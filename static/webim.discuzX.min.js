(function(x,A,ma){function ta(d){return ua.call(d)==="[object Function]"}function na(d){return ua.call(d)==="[object Array]"}function Aa(d){return d&&ua.call(d)==="[object Object]"}function va(d){return(d||"").replace(/^\s+|\s+$/g,"")}function qa(d,g){var j=false;if(Aa(g)){d=d||{};for(var l in g){var o=g[l];if(d[l]!=o){j=j||{};j[l]=o}}}return j}function ia(d){var g=[];if(d!=null){var j=d.length;if(j==null||typeof d==="string"||ta(d)||d.setInterval)g[0]=d;else for(;j;)g[--j]=d[j]}return g}function G(){var d=
arguments[0]||{},g=1,j=arguments.length,l=false,o;if(typeof d==="boolean"){l=d;d=arguments[1]||{};g=2}if(typeof d!=="object"&&!ta(d))d={};for(;g<j;g++)if((o=arguments[g])!=null)for(var r in o){var q=d[r],v=o[r];if(d!==v)if(l&&v&&typeof v==="object"&&!v.nodeType)d[r]=G(l,q||(v.length!=null?[]:{}),v);else if(v!==ma)d[r]=v}return d}function L(d,g,j){var l,o=0,r=d.length,q=r===ma||ta(d);if(j)if(q)for(l in d){if(g.apply(d[l],j)===false)break}else for(;o<r;){if(g.apply(d[o++],j)===false)break}else if(q)for(l in d){if(g.call(d[l],
l,d[l])===false)break}else for(j=d[0];o<r&&g.call(j,o,j)!==false;j=d[++o]);return d}function Ba(d,g,j){for(var l=[],o=0,r=d.length;o<r;o++)!j!==!g(d[o],o)&&l.push(d[o]);return l}function ra(d,g){for(var j=[],l,o=0,r=d.length;o<r;o++){l=g(d[o],o);if(l!=null)j[j.length]=l}return j.concat.apply([],j)}function ea(d){this.type=d;this.timeStamp=(new Date).getTime()}function M(d){this.URL=d;this._setting();this._connect()}function F(d,g){var j=this;g=g||{};var l=j.ws=new WebSocket(d);l.onopen=function(){j.trigger("open",
"success");l.send("subscribe "+g.domain+" "+g.ticket)};l.onclose=function(o){j.trigger("close",[o.data])};l.onmessage=function(o){o=o.data;try{o=o?x.JSON&&x.JSON.parse?x.JSON.parse(o):(new Function("return "+o))():o}catch(r){}j.trigger("message",[o])};l.onerror=function(){j.trigger("error",[])}}function ja(d,g,j){if(typeof g!="undefined"){j=j||{};if(g===null){g="";j.expires=-1}var l="";if(j.expires&&(typeof j.expires=="number"||j.expires.toUTCString)){if(typeof j.expires=="number"){l=new Date;l.setTime(l.getTime()+
j.expires*24*60*60*1E3)}else l=j.expires;l="; expires="+l.toUTCString()}var o=j.path?"; path="+j.path:"",r=j.domain?"; domain="+j.domain:"";j=j.secure?"; secure":"";A.cookie=[d,"=",encodeURIComponent(g),l,o,r,j].join("")}else{g=null;if(A.cookie&&A.cookie!=""){j=A.cookie.split(";");for(l=0;l<j.length;l++){o=va(j[l]);if(o.substring(0,d.length+1)==d+"="){g=decodeURIComponent(o.substring(d.length+1));break}}}return g}}function Q(d,g){this.options=G({},Q.defaults,g);this._init(d,g)}function y(d){return d&&
d.split?d.split(","):na(d)?d:parseInt(d)?[parseInt(d)]:[]}function oa(d,g,j){function l(o,r){this.data=o;this.options=G({},l.defaults,r);ta(this._init)&&this._init()}l.defaults=g;ea.on(l);G(l.prototype,j);Q[d]=l}function I(d,g){if(typeof d=="string"){d[d]=g;if(g===ma)return I[d]}G(I,d)}var ua=Object.prototype.toString;ea.on=function(){for(var d,g=ea.on.prototype,j=0,l=arguments.length;j<l;j++){d=arguments[j].prototype;d.bind=d.addEventListener=g.addEventListener;d.unbind=d.removeEventListener=g.removeEventListener;
d.trigger=d.dispatchEvent=g.dispatchEvent}};ea.on.prototype={addEventListener:function(d,g){var j=this.__listeners=this.__listeners||{};j[d]=j[d]||[];j[d].push(g);return this},dispatchEvent:function(d,g){var j=this.__listeners=this.__listeners||{};d=d.type?d:new ea(d);j=j[d.type];if(Object.prototype.toString.call(g)==="[object Array]")g.unshift(d);else g=[d,g];if(j)for(var l=0,o=j.length;l<o;l++)j[l].apply(this,g);return this},removeEventListener:function(d,g){var j=this.__listeners=this.__listeners||
{};if(j[d])if(g){j=j[d];for(var l=j.length;l--;)j[l]===g&&j.splice(l,1)}else delete j[d];return this}};var X=function(){function d(u){var k={};for(var B in d.settings)k[B]=d.settings[B];if(u)for(B in u)k[B]=u[B];var N,P,C,D=k.type.toUpperCase(),ha=o.test(D),fa,V,Ca=x,W;k.url=k.url.replace(Z,"");k.context=u&&u.context!=null?u.context:k;if(k.data&&k.processData&&typeof k.data!=="string")k.data=g(k.data,k.traditional);var ca=H.exec(k.url);B=x.location;ca=ca&&(ca[1]&&ca[1]!==B.protocol||ca[2]!==B.host);
/https?:/i.test(B.protocol)||(ca=false);ca=k.forceRemote?true:ca;if(k.dataType==="jsonp"&&!ca)k.dataType="json";if(k.dataType==="jsonp"){if(D==="GET")q.test(k.url)||(k.url+=(v.test(k.url)?"&":"?")+(k.jsonp||"callback")+"=?");else if(!k.data||!q.test(k.data))k.data=(k.data?k.data+"&":"")+(k.jsonp||"callback")+"=?";k.dataType="json"}if(k.dataType==="json"&&(k.data&&q.test(k.data)||q.test(k.url))){N=k.jsonpCallback||"jsonp"+j++;if(k.data)k.data=(k.data+"").replace(q,"="+N+"$1");k.url=k.url.replace(q,
"="+N+"$1");k.dataType="script";var wa=x[N],pa=false;x[N]=function(ga){if(!pa){pa=true;if(Object.prototype.toString.call(wa)==="[object Function]")wa(ga);else{x[N]=ma;try{delete x[N]}catch(a){}}C=ga;J.handleSuccess(k,E,P,C);J.handleComplete(k,E,P,C);fa&&fa.removeChild(W);V&&V.parentNode&&V.parentNode.removeChild(V)}}}if(k.dataType==="script"&&k.cache===null)k.cache=false;if(k.cache===false&&D==="GET"){var Da=(new Date).getTime(),ka=k.url.replace(R,"$1_="+Da);k.url=ka+(ka===k.url?(v.test(k.url)?"&":
"?")+"_="+Da:"")}if(k.data&&D==="GET")k.url+=(v.test(k.url)?"&":"?")+k.data;k.global&&J.active++;if(k.dataType==="script"&&D==="GET"&&ca){u=false;if(N&&k.async&&!l)if(x._fragmentProxy)fa=V=A.createDocumentFragment();else{u=true;if(k.url.slice(0,1)=="/")k.url=B.protocol+"//"+B.host+(B.port?":"+B.port:"")+k.url;else if(!/^https?:\/\//i.test(k.url)){B=B.href;D=/([^?#]+)\//.exec(B);k.url=(D?D[1]:B)+"/"+k.url}k.url=k.url.replace("="+N,"=parent."+N);V=A.createElement("iframe");V.style.position="absolute";
V.style.left="-100px";V.style.top="-100px";V.style.height="1px";V.style.width="1px";V.style.visibility="hidden";A.body.insertBefore(V,A.body.firstChild);Ca=V.contentWindow}var Ea=function(){var ga=Ca.document;fa=fa||ga.getElementsByTagName("head")[0]||ga.documentElement;W=ga.createElement("script");if(k.scriptCharset)W.charset=k.scriptCharset;W.src=k.url;if(l)W.async=k.async;if(N)W.onload=W.onerror=W.onreadystatechange=function(){if(!pa&&(!this.readyState||this.readyState==="loaded"||this.readyState===
"complete")){pa=true;J.handleError(k,E,"error","load error");fa&&W.parentNode&&fa.removeChild(W);V&&V.parentNode&&V.parentNode.removeChild(V)}};else{var a=false;W.onload=W.onreadystatechange=function(){if(!a&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){a=true;J.handleSuccess(k,E,P,C);J.handleComplete(k,E,P,C);W.onload=W.onreadystatechange=null;fa&&W.parentNode&&fa.removeChild(W)}}}fa.insertBefore(W,fa.firstChild)};u?setTimeout(function(){Ea()},0):Ea();return ma}var sa=
false,E=k.xhr();if(E){k.username?E.open(D,k.url,k.async,k.username,k.password):E.open(D,k.url,k.async);try{if(k.data!=null&&!ha||u&&u.contentType)E.setRequestHeader("Content-Type",k.contentType);if(k.ifModified){J.lastModified[k.url]&&E.setRequestHeader("If-Modified-Since",J.lastModified[k.url]);J.etag[k.url]&&E.setRequestHeader("If-None-Match",J.etag[k.url])}ca||E.setRequestHeader("X-Requested-With","XMLHttpRequest");E.setRequestHeader("Accept",k.dataType&&k.accepts[k.dataType]?k.accepts[k.dataType]+
", */*; q=0.01":k.accepts._default)}catch(xa){}if(k.beforeSend&&k.beforeSend.call(k.context,E,k)===false){k.global&&J.active--;E.abort();return false}k.global&&J.triggerGlobal(k,"ajaxSend",[E,k]);var S=E.onreadystatechange=function(ga){if(!E||E.readyState===0||ga==="abort"){sa||J.handleComplete(k,E,P,C);sa=true;if(E)E.onreadystatechange=J.noop}else if(!sa&&E&&(E.readyState===4||ga==="timeout")){sa=true;E.onreadystatechange=J.noop;P=ga==="timeout"?"timeout":!J.httpSuccess(E)?"error":k.ifModified&&
J.httpNotModified(E,k.url)?"notmodified":"success";var a;if(P==="success")try{C=J.httpData(E,k.dataType,k)}catch(b){P="parsererror";a=b}if(P==="success"||P==="notmodified")N||J.handleSuccess(k,E,P,C);else J.handleError(k,E,P,a);N||J.handleComplete(k,E,P,C);ga==="timeout"&&E.abort();if(k.async)E=null}};try{var $=E.abort;E.abort=function(){E&&$.call&&$.call(E);S("abort")}}catch(Ha){}k.async&&k.timeout>0&&setTimeout(function(){E&&!sa&&S("timeout")},k.timeout);try{E.send(ha||k.data==null?null:k.data)}catch(Ga){J.handleError(k,
E,null,Ga);J.handleComplete(k,E,P,C)}k.async||S();return E}}function g(u){var k=[];if(typeof u=="object"){for(var B in u)k[k.length]=encodeURIComponent(B)+"="+encodeURIComponent(u[B]);return k.join("&").replace(O,"+")}return u}var j=(new Date).getTime(),l=typeof A.createElement("script").async==="boolean",o=/^(?:GET|HEAD|DELETE)$/,r=/\S/,q=/\=\?(&|$)/,v=/\?/,R=/([?&])_=[^&]*/,H=/^(\w+:)?\/\/([^\/?#]+)/,O=/%20/g,Z=/#.*$/;x._fragmentProxy=false;var da=A.createDocumentFragment(),ya=A.createElement("script");
try{ya.appendChild(A.createTextNode("window._fragmentProxy = true"))}catch(Fa){ya.text="window._fragmentProxy = true"}da.appendChild(ya);da=ya=null;d.param=g;var J={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(u,k,B,N){u.error&&u.error.call(u.context,k,B,N);u.global&&J.triggerGlobal(u,"ajaxError",[k,u,N])},handleSuccess:function(u,k,B,N){u.success&&u.success.call(u.context,N,B,k);u.global&&J.triggerGlobal(u,"ajaxSuccess",[k,u])},handleComplete:function(u,k,B){u.complete&&
u.complete.call(u.context,k,B);u.global&&J.triggerGlobal(u,"ajaxComplete",[k,u]);u.global&&J.active--},triggerGlobal:function(){},httpSuccess:function(u){try{return!u.status&&location.protocol==="file:"||u.status>=200&&u.status<300||u.status===304||u.status===1223}catch(k){}return false},httpNotModified:function(u,k){var B=u.getResponseHeader("Last-Modified"),N=u.getResponseHeader("Etag");if(B)J.lastModified[k]=B;if(N)J.etag[k]=N;return u.status===304},httpData:function(u,k,B){var N=u.getResponseHeader("content-type")||
"",P=k==="xml"||!k&&N.indexOf("xml")>=0;u=P?u.responseXML:u.responseText;P&&u.documentElement.nodeName==="parsererror"&&J.error("parsererror");if(B&&B.dataFilter)u=B.dataFilter(u,k);if(typeof u==="string")if(k==="json"||!k&&N.indexOf("json")>=0)u=u?x.JSON&&x.JSON.parse?x.JSON.parse(u):(new Function("return "+u))():u;else if(k==="script"||!k&&N.indexOf("javascript")>=0)if(u&&r.test(u)){k=A.getElementsByTagName("head")[0]||A.documentElement;B=A.createElement("script");B.type="text/javascript";try{B.appendChild(A.createTextNode(u))}catch(C){B.text=
u}k.insertBefore(B,k.firstChild);k.removeChild(B)}return u}};d.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new x.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};d.setup=function(u){if(u)for(var k in u)d.settings[k]=u[k]};if(x.ActiveXObject)d.settings.xhr=
function(){if(x.location.protocol!=="file:")try{return new x.XMLHttpRequest}catch(u){}try{return new x.ActiveXObject("Microsoft.XMLHTTP")}catch(k){}};return d}(),la=x.JSON?x.JSON:function(){function d(l){return j[l]||"\\u00"+Math.floor(l.charCodeAt()/16).toString(16)+(l.charCodeAt()%16).toString(16)}function g(l){switch(Object.prototype.toString.call(l)){case "[object String]":return'"'+l.replace(/[\x00-\x1f\\"]/g,d)+'"';case "[object Array]":for(var o=[],r=l.length,q=0;q<r;q++)o.push(g(l[q]));return"["+
o.join(",")+"]";case "[object Object]":o=[];for(r in l)(q=g(l[r]))&&o.push(g(r)+":"+q);return"{"+o+"}";case "[object Number]":case "[object Boolean]":return String(l);case false:return"null"}return null}var j={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:g,parse:function(l){l=l.toString();if(!l||!l.length)return null;return(new Function("return "+l))()}}}();M.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=M.CLOSED;
this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var d=this;if(d._connecting)return d;d.readyState=M.CONNECTING;d._connecting=true;d._onPolling||x.setTimeout(function(){d._startPolling()},300);return d},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=M.OPEN;this.trigger("open","success")},_onClose:function(d){var g=this;g._setting();setTimeout(function(){g.trigger("close",
[d])},1E3)},_onData:function(d){this.trigger("message",[d])},_onError:function(d){var g=this;g._setting();setTimeout(function(){g.trigger("error",[d])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;X({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(d){var g=this;g._onPolling=false;if(g._connecting)if(d){g._pollingTimes==1&&g._onConnect();g._onData(d);g._failTimes=
0;g._pollTimer=x.setTimeout(function(){g._startPolling()},200)}else return g._onError("error data")},_onPollError:function(d){var g=this;g._onPolling=false;if(g._connecting){g._failTimes++;if(g._pollingTimes==1)g._onError("can not connect.");else if(g._failTimes>1)g._onClose(d);else g._pollTimer=x.setTimeout(function(){g._startPolling()},200)}}};M.CONNECTING=0;M.OPEN=1;M.CLOSED=2;ea.on(M);F.prototype={readyState:0,send:function(){},close:function(){this.ws.close()}};F.enable=!!x.WebSocket;F.CONNECTING=
0;F.OPEN=1;F.CLOSED=2;ea.on(F);ea.on(Q);Q.OFFLINE=0;Q.BEFOREONLINE=1;Q.ONLINE=2;G(Q.prototype,{state:Q.OFFLINE,_init:function(){this.data={user:{presence:"offline",show:"unavailable"}};this.status=new Q.status;this.setting=new Q.setting;this.buddy=new Q.buddy;this.room=new Q.room(null,this.data);this.history=new Q.history(null,this.data);this._initEvents()},_createConnect:function(){var d=this,g=d.data.connection;d.connection=d.options.connectionType!="jsonpd"&&g.websocket&&F.enable?new F(g.websocket,
g):new M(g.server+(/\?/.test(g)?"&":"?")+X.param({ticket:g.ticket,domain:g.domain}));d.connection.bind("connect",function(){}).bind("message",function(j,l){d.handle(l)}).bind("error",function(){d._stop("connect","Connect Error")}).bind("close",function(){d._stop("connect","Disconnect")})},setUser:function(d){G(this.data.user,d)},_ready:function(d){var g=this;g.state=Q.BEFOREONLINE;g._unloadFun=x.onbeforeunload;x.onbeforeunload=function(){g._deactivate()};g.trigger("beforeOnline",[d])},_go:function(){var d=
this.data,g=this.history,j=this.buddy,l=this.room;this.state=Q.ONLINE;g.options.userInfo=d.user;L(d.buddies,function(r,q){g.init("unicast",q.id,q.history)});j.set(d.buddies);L(d.rooms,function(r,q){g.init("multicast",q.id,q.history)});j=this.setting.get("blocked_rooms");var o=d.rooms;na(j)&&o&&L(j,function(r,q){o[q]&&(o[q].blocked=true)});l.set(o);l.options.ticket=d.connection.ticket;this.trigger("online",[d]);this._createConnect();if((d=d.new_messages)&&d.length){L(d,function(r,q){q["new"]=true});
this.trigger("message",[d])}},_stop:function(d,g){if(this.state!==Q.OFFLINE){this.state=Q.OFFLINE;x.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("offline",[d,g])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function d(o){var r={id:o.from,presence:o.type};if(o.show)r.show=o.show;if(o.nick)r.nick=o.nick;if(o.status)r.status=o.status;return r}var g=this,j=g.history,l=g.buddy;g.bind("message",
function(o,r){for(var q=[],v=r.length,R=g.data.user.id,H,O,Z,da=0;da<v;da++){H=r[da];Z=H.type;O=Z=="unicast"?H.to==R?H.from:H.to:H.to;H.id=O;if(Z=="unicast"&&!H["new"]){O={id:O,presence:"online"};if(H.nick&&H.to==R)O.nick=H.nick;q.push(O)}}if(q.length){l.presence(q);l.complete()}j.set(r)});g.bind("presence",function(o,r){l.presence(ra(r,d))})},handle:function(d){d.messages&&d.messages.length&&this.trigger("message",[d.messages]);d.presences&&d.presences.length&&this.trigger("presence",[d.presences]);
d.statuses&&d.statuses.length&&this.trigger("status",[d.statuses])},sendMessage:function(d,g){d.ticket=this.data.connection.ticket;this.trigger("sendMessage",[d]);X({type:"get",dataType:"jsonp",cache:false,url:I("message"),data:d,success:g,error:g})},sendStatus:function(d,g){d.ticket=this.data.connection.ticket;this.trigger("sendStatus",[d]);X({type:"get",dataType:"jsonp",cache:false,url:I("status"),data:d,success:g,error:g})},sendPresence:function(d,g){d.ticket=this.data.connection.ticket;this.data.user.show=
d.show;this.status.set("s",d.show);this.trigger("sendPresence",[d]);X({type:"get",dataType:"jsonp",cache:false,url:I("presence"),data:d,success:g,error:g})},online:function(d){var g=this,j=g.status;if(g.state===Q.OFFLINE){var l=[],o=[],r=j.get("tabs"),q=j.get("tabIds");q&&q.length&&r&&L(r,function(v){v[0]=="b"&&l.push(v.slice(2));v[0]=="r"&&o.push(v.slice(2))});d=G({buddy_ids:l.join(","),room_ids:o.join(","),show:j.get("s")||"available"},d);g._ready(d);j.set("o",false);j.set("s",d.show);X({type:"get",
dataType:"jsonp",cache:false,url:I("online"),data:d,success:function(v){if(v)if(v.success){v.user=G(g.data.user,v.user,{presence:"online"});g.data=v;g._go()}else g._stop("online",v.error_msg);else g._stop("online","Not Found")},error:function(){g._stop("online","Not Found")}})}},offline:function(){var d=this.data;if(this.state!==Q.OFFLINE){this.status.set("o",true);this.connection.close();this._stop("offline","offline");X({type:"get",dataType:"jsonp",cache:false,url:I("offline"),data:{status:"offline",
ticket:d.connection.ticket}})}},_deactivate:function(){var d=this.data;!d||!d.connection||!d.connection.ticket||X({type:"get",dataType:"jsonp",cache:false,url:I("deactivate"),data:{ticket:d.connection.ticket}})}});x.webim=Q;G(Q,{version:"1.1.0",defaults:{},log:function(){var d=new Date;["[",d.getHours(),":",d.getMinutes(),":",d.getSeconds(),"-",d.getMilliseconds(),"]"].join("");if(x&&x.console)x.console.log.apply(null,arguments);else x&&x.runtime&&x.air&&x.air.Introspector&&x.air.Introspector.Console.log.apply(null,
arguments)},idsArray:y,now:function(){return(new Date).getTime()},isFunction:ta,isArray:na,isObject:Aa,trim:va,makeArray:ia,extend:G,each:L,inArray:function(d,g){for(var j=0,l=g.length;j<l;j++)if(g[j]===d)return j;return-1},grep:Ba,map:ra,JSON:la,ajax:X,comet:M,socket:F,model:oa,route:I,ClassEvent:ea});oa("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true,blocked_rooms:[]}},{_init:function(){this.data=G({},this.options.data,this.data)},get:function(d){return this.data[d]},
set:function(d,g){var j=this,l=d;if(d){if(typeof d=="string"){l={};l[d]=g}var o=j.data,r=qa(o,l);if(r){L(r,function(q,v){j.trigger("update",[q,v])});l=G({},o,l);j.data=l;X({type:"get",url:I("setting"),dataType:"jsonp",cache:false,data:{data:la.stringify(l)}})}}}});oa("status",{key:"_webim"},{_init:function(){var d=this.data,g=this.options.key;if(d)this._save(d);else this.data=(d=x.localStorage?x.localStorage.getItem(g):ja(g))?la.parse(d):{}},set:function(d,g){var j=d;if(typeof d=="string"){j={};j[d]=
g}var l=this.data;qa(l,j)&&this._save(G({},l,j))},get:function(d){return this.data[d]},clear:function(){this._save({})},_save:function(d){var g=this.options.key;this.data=d;d=la.stringify(d);x.localStorage?x.localStorage.setItem(g,d):ja(g,d,{path:"/",domain:A.domain})}});oa("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(d){var g=this.dataHash,j=0,l;for(var o in g)if(Aa(d)){l=true;
for(var r in d)if(d[r]!=g[o][r])l=false;l&&j++}else j++;return j},get:function(d){return this.dataHash[d]},all:function(d){return d?Ba(this.data,function(g){return g.show!="invisible"&&g.presence=="online"}):this.data},complete:function(){var d=this.dataHash,g=[],j;for(var l in d){j=d[l];if(j.incomplete&&j.presence=="online"){j.incomplete=false;g.push(l)}}this.load(g)},update:function(d){this.load(d)},presence:function(d){var g=this.dataHash;d=na(d)?d:[d];for(var j in d){var l=d[j];l.presence=l.presence==
"offline"?"offline":"online";l.incomplete=!g[l.id]}this.set(d)},load:function(d){d=y(d);d.length&&X({type:"get",url:I("buddies"),cache:false,dataType:"jsonp",data:{ids:d.join(",")},context:this,success:this.set})},set:function(d){var g=this.data,j=this.dataHash,l={};d=d||[];var o,r;for(var q in d){o=d[q];if(id=o.id){if(!j[id]){o.presence=o.presence||"online";o.show=o.show?o.show:o.presence=="offline"?"unavailable":"available";j[id]={};g.push(j[id])}o.incomplete=!!o.incomplete;if(r=qa(j[id],o)){o=
r.presence||"update";l[o]=l[o]||[];G(j[id],r);l[o].push(j[id])}}}for(var v in l)this.trigger(v,[l[v]]);this.options.active&&this.complete()}});(function(){oa("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(d){return this.dataHash[d]},block:function(d){var g=this.dataHash[d];if(g&&!g.blocked){g.blocked=true;var j=[];L(this.dataHash,function(l,o){o.blocked&&j.push(o.id)});this.trigger("block",[d,j])}},unblock:function(d){var g=this.dataHash[d];if(g&&g.blocked){g.blocked=
false;var j=[];L(this.dataHash,function(l,o){o.blocked&&j.push(o.id)});this.trigger("unblock",[d,j])}},set:function(d){var g=this,j=g.data,l=g.dataHash;L(d,function(o,r){var q=r.id;if(q){r.members=r.members||[];r.count=r.count||0;r.all_count=r.all_count||0;if(l[q])G(l[q],r);else{l[q]=r;j.push(r)}g.trigger("join",[l[q]])}})},addMember:function(d,g){var j=this;if(na(g))L(g,function(v,R){j.addMember(d,R)});else{var l=j.dataHash[d];if(l){for(var o=l.members,r,q=o.length;q--;)if(o[q].id==g.id)r=o[q];if(!r){g.nick=
g.nick;o.push(g);l.count=o.length;j.trigger("addMember",[d,g])}}}},removeMember:function(d,g){var j=this.dataHash[d];if(j){for(var l=j.members,o,r=l.length;r--;)if(l[r].id==g){o=l[r];l.splice(r,1);j.count--}o&&self.trigger("removeMember",[d,o])}},initMember:function(d){var g=this.dataHash[d];if(g&&!g.initMember){g.initMember=true;this.loadMember(d)}},loadMember:function(d){var g=this,j=g.options;X({type:"get",cache:false,url:I("members"),dataType:"jsonp",data:{ticket:j.ticket,id:d},success:function(l){g.addMember(d,
l)}})},join:function(d){var g=this,j=g.options,l=j.user;X({type:"get",cache:false,url:I("join"),dataType:"jsonp",data:{ticket:j.ticket,id:d,nick:l.nick},success:function(o){g.initMember(d);g.set([o])}})},leave:function(d){var g=this.options,j=this.dataHash[d],l=g.user;if(j){j.initMember=false;X({type:"get",cache:false,url:I("leave"),dataType:"jsonp",data:{ticket:g.ticket,id:d,nick:l.nick}});this.trigger("leave",[j])}},clear:function(){}})})();oa("history",{},{_init:function(){this.data=this.data||
{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{}},get:function(d,g){return this.data[d][g]},set:function(d){var g=this.data,j={unicast:{},multicast:{}};d=ia(d);var l=d.length,o,r,q=this.options.userInfo.id;if(l){for(var v=0;v<l;v++){o=d[v];R=o.type;if((r=R=="unicast"?o.to==q?o.from:o.to:o.to)&&R){j[R][r]=j[R][r]||[];j[R][r].push(o)}}for(var R in j)for(r in j[R]){o=j[R][r];if(g[R][r]){g[R][r]=g[R][r].concat(o);this._triggerMsg(R,r,o)}else this.load(R,r)}}},_triggerMsg:function(d,
g,j){this.trigger(d,[g,j])},clear:function(d,g){this.data[d][g]=[];this.trigger("clear",[d,g]);X({url:I("clear"),type:"get",cache:false,dataType:"jsonp",data:{type:d,id:g}})},download:function(d,g){var j=I("download"),l=A.createElement("iframe"),o=new Date,r=[];o={id:g,type:d,time:(new Date).getTime(),date:o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()};for(var q in o)r[r.length]=encodeURIComponent(q)+"="+encodeURIComponent(o[q]);j+=(/\?/.test(j)?"&":"?")+r.join("&");l.setAttribute("src",j);
l.style.display="none";A.body.appendChild(l)},init:function(d,g,j){if(na(j)){this.data[d][g]=j;this._triggerMsg(d,g,j)}},load:function(d,g){var j=this;j.data[d][g]=[];X({url:I("history"),cache:false,type:"get",dataType:"jsonp",data:{type:d,id:g},success:function(l){j.init(d,g,l)}})}})})(window,document);
(function(x,A,ma){function ta(){return false}function na(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Aa(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function va(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function qa(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&c.push(a);return c}function ia(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function G(a,b){if(a)ia(a,b)||(a.className+=" "+b)}function L(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function Ba(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function ra(a,b,c){y(a,"mouseover",function(){G(this,b);c&&L(this,c)});y(a,"mouseout",function(){L(this,
b);c&&G(this,c)})}function ea(a,b,c){if(typeof c==="boolean")c?G(a,b):L(a,b);else ia(a,b)?L(a,b):G(a,b)}function M(a){a&&a.style&&(a.style.display="block")}function F(a){a&&a.style&&(a.style.display="none")}function ja(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function Q(a,b){var c=a.childNodes;for(i=0;i<c.length;i++)a.removeChild(c[i]);typeof b==="string"?a.innerHTML=b:a.appendChild(b)}function y(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+
b+c](x.event)};a.attachEvent("on"+b,a[b+c])}}function oa(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}}function I(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function ua(a){if(!a.target)a.target=a.srcElement||A;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function X(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";a.style.OUserSelect="none";a.style.WebkitUserSelect="none";y(a,"selectstart",ta)}function la(){if(!wa){wa=
true;if(pa){for(var a,b=0;a=pa[b++];)a();pa=null}}}function d(){if(!Da){Da=true;if(A.readyState==="complete")return la();if(A.addEventListener)A.addEventListener("DOMContentLoaded",function(){A.removeEventListener("DOMContentLoaded",arguments.callee,false);la()},false);else if(A.attachEvent){A.attachEvent("onreadystatechange",function(){if(A.readyState==="complete"){A.detachEvent("onreadystatechange",arguments.callee);la()}});A.documentElement.doScroll&&x==x.top&&function(){if(!wa){try{A.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,
0);return}la()}}()}y(x,"load",la)}}function g(a){var b=new Date;b.setTime(a?parseFloat(a)+g.timeSkew:(new Date).getTime());this.date=b}function j(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](x.event)};a.attachEvent("on"+b,a[b+c])}}function l(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function o(a){return a?x.JSON&&x.JSON.parse?x.JSON.parse(a):(new Function("return "+a))():a}function r(a,b){j(a,"submit",function(){function c(){try{var n=
f.contentWindow.name||null;if(n!=null){l(e);b&&b(o(n))}else throw Error("Empty data");}catch(p){l(e);b&&b({error:"Retrieve data error"})}}a.setAttribute("target","_upload_form13123");var e=A.createElement("div");e.innerHTML='<iframe name="_upload_form13123" id="_upload_form13123" style="display:none;" scrolling="no" frameborder="0"></iframe>';var f=e.firstChild;A.body.appendChild(e);if(x.postMessage){var h=function(n){var p=x,z=h;if(p.addEventListener)p.removeEventListener("message",z,false);else{p.detachEvent("onmessage",
p["message"+z]);p["message"+z]=null}l(e);b&&b(o(n.data))};j(x,"message",h)}else{var m=false;j(f,"load",function(){if(m)x.attachEvent||c();else{m=true;f.contentWindow.location="about:blank"}});if(x.attachEvent)f.onreadystatechange=function(){m&&c()}}})}function q(a,b,c){c=C({locale:q.locale},c);c=q.dictionary[c.locale];B(c)||(c={});a=c[a]===ma?a:c[a];if(b){sa=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,E)}return a}function v(a,b){this.element=a;this.options=C({},v.defaults,b);this._init()}function R(a){a=
a.getElementsByTagName("*");for(var b,c,e={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==0)e[c.substring(1,c.length)]=b}return e}function H(a){var b=A.createElement("div");b.innerHTML=a;return b=b.firstChild}function O(a,b,c){function e(f,h){this.id=Ha++;this.name=a;this.className="webim-"+a;this.options=C({},e.defaults,h);if(this.element=f||this.template&&H(this.template())||this.options.template&&H(S(this.options.template))){this.options.className&&G(this.element,this.options.className);
this.$=R(this.element)}u(this._init)&&this._init();u(this._initEvents)&&this._initEvents()}e.defaults=b;Ca.on(e);C(e.prototype,O.prototype,c);v[a]=e}function Z(a,b){v.apps[a]=b||{}}function da(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+b:a}function ya(a){return a=="b"||a=="buddy"||a=="unicast"?"buddy":"room"}function Fa(){A.selection&&(this.caretPos=A.selection.createRange())}var J=webim.idsArray,u=webim.isFunction,k=webim.isArray,B=webim.isObject,N=webim.trim,P=webim.makeArray,C=
webim.extend,D=webim.each,ha=webim.grep,fa=webim.ajax,V=webim.model,Ca=webim.ClassEvent,W=webim.route,ca=webim.map,wa=false,pa=[],Da=false;g.timeSkew=0;g.init=function(a){g.timeSkew=(new Date).getTime()-parseFloat(a)};C(g.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return q("dt:today");
else if(a<864E5)return q("dt:yesterday")}return q("dt:monthdate",{month:q(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var ka=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(c){C(b,c);c=b.lib+"?_"+(new Date).getTime();c=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?
'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+c+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+c+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+c+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';try{A.getElementById("webim-flashlib-c").innerHTML=c}catch(e){}},play:function(c){c=Aa(c)?c:b[c];if(a)try{A.getElementById("webim-flashlib").playSound(c?
c:"/sound/sound.mp3")}catch(e){}}}}(),Ea=function(){var a=false;y(x,"focus",function(){a=false});y(x,"blur",function(){a=true});var b=A.title,c=0,e=false;return function(f,h){if(a){if(m){clearInterval(m);c=0;e=false}var m=setInterval(function(){c++;e=!e;if(c==h||!a){clearInterval(m);c=0;e=false}A.title=e?"["+f+"]"+b:b},1500)}}}(),sa={},E=function(a,b){return sa[b]||""};q.locale="zh-CN";q.dictionary={};q.store=function(a,b){var c=q.dictionary;B(c[a])||(c[a]={});C(c[a],b)};Ca.on(v);C(v.prototype,{render:function(){var a=
this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),b=this.options;this.layout=this.addApp(b.layout||"layout",b.layoutOptions);a.setting.get("play_sound")?ka.enable():ka.disable();a.bind("online",function(c,e){g.init(e.server_time)});a.setting.bind("update",function(c,e,f){if("play_sound"==e)f?ka.enable():ka.disable()})},addApp:function(a,b){var c=v.apps[a];
if(c)return u(c)&&c.apply(this,[b])},initSound:function(a){ka.init(a||this.options.soundUrls)}});var xa=function(a,b){if(b===ma)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();M(a)}else{a.innerHTML="0";F(a)}return b},S=function(){function a(e,f){return b&&b[f]!=ma?b[f]:q(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(e,f){if(!e)return"";b=f;return e.replace(c,a)}}(),$={add:function(a,b,c){a=v[a].prototype;for(var e in c){a.plugins[e]=
a.plugins[e]||[];a.plugins[e].push([b,c[e]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var e=0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,c)}},Ha=1;C(O.prototype,{_init:function(){}});C(v,{version:"3.0.1",widget:O,app:Z,plugin:$,i18n:q,date:g,ready:function(a){d();wa?a():pa.push(a)},createElement:H,defaults:{},apps:{}});webim.ui=v;O("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){Q(this.$.content,a)},subHeader:function(a){Q(this.$.subHeader,a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&F(c.minimize);!b.maximizable&&F(c.maximize);if(!b.closeable){F(c.tabClose);F(c.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?F(c.tabTitle):ja(c.tabTip);b.count&&this.notifyUser("information",b.count);
Ga(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(xa(c.tabCount,b)){G(c.tab,"ui-state-highlight");L(c.tab,"ui-state-default")}},_count:function(){return xa(this.$.tabCount)},title:function(a,b){var c=this.$,e=c.tabIcon;if(b)if(Aa(b)){e.className="webim-icon";e.style.backgroundImage="url("+b+")"}else e.className="webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;e=this.options.titleVisibleLength;if(a){for(var f=0,h=[],m=a.split(""),n=m.length,p=0;p<n;p++)if(f>=
e||f<0)break;else{if(m[p].charCodeAt(0)>255)f+=2;else f++;h.push(m[p])}e=h.join("")}else e=a;(c.tabTitle.innerHTML=e)&&a&&e.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){Ba(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return ia(this.element,"webim-window-active")},activate:function(){if(!this.active()){G(this.element,
"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){L(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;Ba(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();xa(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!ia(this.element,"webim-window-normal")){this._setVisibile();
this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){Ba(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");ja(this.element)},_initEvents:function(){var a=this,b=a.$,c=b.tab,e=function(f){oa(f);I(f)};y(c,"click",function(f){a.isMinimize()?a.restore():a.minimize();e(f)});y(c,"mouseover",function(){G(this,"ui-state-hover");L(this,"ui-state-default")});y(c,"mouseout",
function(){L(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&G(this,"ui-state-default")});y(c,"mousedown",e);X(c);D(qa(b.actions.firstChild),function(f,h){ra(h,"ui-state-hover")});D(["minimize","maximize","close","tabClose"],function(f,h){y(b[h],"click",function(m){this.disabled||a[h]();e(m)});y(b[h],"mousedown",e)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return ia(this.element,"webim-window-maximize")},isMinimize:function(){return ia(this.element,
"webim-window-minimize")}});var Ga=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},e=function(){this&&a==this&&(a=false)};y(A,"mousedown",function(f){f=ua(f);for(var h;f;)if(f.id==":webim-window"){h=f;break}else f=f.parentNode;if(h)(f=h.window)&&f.activate();else b()});return function(f){if(f.active()){b();a=f}f.bind("activate",c);f.bind("deactivate",e)}}();Z("layout",function(a){function b(){if(f)return s.updateAllChat();f=true;
var t=n.get("tabs"),w=n.get("tabIds"),K=n.get("p"),aa=n.get("a");w&&w.length&&t&&D(t,function(U,T){var Y=U.slice(2),ba=U.slice(0,1);s.addChat(ba,Y,{},{isMinimize:true});s.chat(U).window.notifyUser("information",T.n)});K&&(s.prevCount=K)&&s._fitUI();aa&&s.focusChat(aa)}function c(){var t={};D(s.tabs,function(w,K){t[w]={n:K._count()}});n.set({tabs:t,tabIds:s.tabIds,p:s.prevCount,a:s.activeTabId})}a=a||{};var e=this.im,f=false,h=e.buddy,m=e.history,n=e.status,p=e.setting,z=e.room,s=this.layout=new v.layout(null,
C({chatAutoPop:e.setting.get("msg_auto_pop")},a,{ui:this}));e.setting.get("minimize_layout")?s.collapse():s.expand();e.bind("beforeOnline",function(){s.changeState("ready")}).bind("online",function(t,w){s.changeState("active");s.options.user=w.user;b()}).bind("offline",function(t,w){w=="offline"&&s.removeAllChat();s.updateAllChat();s.changeState("stop")});p.bind("update",function(t,w,K){if("msg_auto_pop"==w)s.options.chatAutoPop=K;else if("minimize_layout"==w)K?s.collapse():s.expand()});h.bind("online",
function(t,w){s.updateChat("buddy",w)}).bind("offline",function(t,w){s.updateChat("buddy",w)}).bind("update",function(t,w){s.updateChat("buddy",w)});z.bind("addMember",function(t,w,K){(t=s.chat("room",w))&&t.addMember(K.id,K.nick,K.id==e.data.user.id)}).bind("removeMember",function(t,w,K){(t=s.chat("room",w))&&t.removeMember(K.id,K.nick)});s.bind("collapse",function(){p.set("minimize_layout",true)});s.bind("expand",function(){p.set("minimize_layout",false)});s.bind("displayUpdate",function(){c()});
e.bind("message",function(t,w){for(var K=false,aa=w.length,U,T=e.data.user.id,Y,ba,za=0;za<aa;za++){U=w[za];Y=U.id;type=U.type;(ba=s.chat(type,Y))&&ba.status("");if(!ba){U.type==="unicast"?s.addChat(type,Y,null,null,U.nick):s.addChat(type,Y);ba=s.chat(type,Y)}ba&&p.get("msg_auto_pop")&&!s.activeTabId&&s.focusChat(Y);ba.window.notifyUser("information","+1");Y=ba.window.pos;Y==-1&&s.setNextMsgNum("+1");Y==1&&s.setPrevMsgNum("+1");if(U.from!=T)K=true}if(K){ka.play("msg");Ea(q("new message"),5)}});e.bind("status",
function(t,w){D(w,function(K,aa){var U=e.data.user.id,T=aa.from;if(!(U!=aa.to&&U!=aa.from))(U=s.chat("buddy",T))&&U.status(aa.show)})});m.bind("unicast",function(t,w,K){(t=s.chat("unicast",w))&&t.history.add(K)});m.bind("multicast",function(t,w,K){(t=s.chat("multicast",w))&&t.history.add(K)});m.bind("clear",function(t,w,K){(t=s.chat(w,K))&&t.history.clear()});return s});O("layout",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">\t<div id=":shortcut" class="webim-shortcut">\t</div>\t<div class="webim-layout-r">\t<div id=":panels" class="webim-panels">\t<div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">\t<div id=":next" class="webim-window-tab webim-panels-next ui-state-default">\t<div id=":nextMsgCount" class="webim-window-tab-count">\t0\t</div>\t<em class="ui-icon ui-icon-triangle-1-w"></em>\t<span id=":nextCount">0</span>\t</div>\t</div>\t<div id=":tabsWrap" class="webim-panels-tab-wrap">\t<div id=":tabs" class="webim-panels-tab">\t</div>\t</div>\t<div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">\t<div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">\t<div id=":prevMsgCount" class="webim-window-tab-count">\t0\t</div>\t<span id=":prevCount">0</span>\t<em class="ui-icon ui-icon-triangle-1-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">\t<div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">\t<em class="ui-icon ui-icon-circle-arrow-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-expand-wrap ui-widget">\t<div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">\t<em class="ui-icon ui-icon-circle-arrow-w"></em>\t</div>\t</div>\t</div>\t<div id=":widgets" class="webim-widgets">\t</div>\t</div>\t</div></div>\t</div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">\t<div class="webim-window-tab-tip">\t<strong><%=title%></strong>\t</div>\t<em class="webim-icon" style="background-image:url(<%=icon%>)"></em>\t</a>\t</div>',chatApp:"chat"},{_init:function(a,b){b=this.options;C(this,{window:x,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},
tabIds:[],nextCount:0,prevCount:0});b.unscalable&&G(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((A.compatMode==="CSS1Compat"&&A.documentElement.clientWidth||A.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,
e=b.length,f=this.prevCount;if(!(e<=c)){if(a){for(var h=0,m=0;m<e;m++)if(b[m]==a){h=m;break}if(h<=f)f=h;else if(h>=f+c)f=h-c+1}else f=e-c;this.prevCount=f}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,e=this.tabs,f=this.tabIds,h=f.length,m=0,n=0,p=0;p<h;p++){var z=e[f[p]];if(p<b||p>=c)if(a)M(z.element);else{this.activeTabId==f[p]&&z.minimize();var s=z._count();if(p<b){n+=s;z.pos=1}else{m+=s;z.pos=-1}F(z.element)}else{z.pos=0;M(z.element)}}if(!a){this.setNextMsgNum(m);
this.setPrevMsgNum(n)}},setNextMsgNum:function(a){xa(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){xa(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,e=b.nextCount;if(e>0&&a==-1||c>0&&a==1){b.slideing=true;if(e==1&&a==-1||c==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var f=b.$.tabs,h=parseFloat(f.style.left);c=-1*b.tabWidth*b.nextCount;var m=parseInt(500/
13),n=1,p=(c-h)/m,z=setInterval(function(){f.style.left=h+p*n+"px";if(n==m){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(z)}else n++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,c=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+
"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,e=this.nextCount;if(b<=a)c=e=0;else{e=b-a-c;e=e<0?0:e;c=b-a-e}this.prevCount=c;this.nextCount=e},_updateCountUI:function(){var a=this.$,b=this.prevCount,c=this.nextCount;c<=0?G(a.next,"ui-state-disabled"):L(a.next,"ui-state-disabled");b<=0?G(a.prev,"ui-state-disabled"):L(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display=
"block";a.prev.style.display="block"}else{F(a.next);F(a.prev)}a.nextCount.innerHTML=c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;y(a.window,"resize",function(){if(c){c=true;a.buildUI()}});y(b.next,"mousedown",function(){a._slide(-1)});y(b.next,"mouseup",function(){a._slideUp()});X(b.next);y(b.prev,"mousedown",function(){a._slide(1)});y(b.prev,"mouseup",function(){a._slideUp()});X(b.prev);y(b.expand,"click",function(){if(!a.isMinimize())return false;
a.expand();a.trigger("expand");return false});y(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});ra(b.collapse,"ui-state-hover","ui-state-default");ra(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return ia(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||G(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&L(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&
this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&D(this.widgets,function(c,e){e.window!=a&&e.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,e){var f=this;b=C(b,{closeable:false,subHeader:a.header});var h=a.element;b=new v.window(null,
b);b.html(h);f.$[e?e:"widgets"].insertBefore(b.element,c&&f.widgets[c]?f.widgets[c].window.element:null);a.window=b;b.bind("displayStateChange",function(m,n){f._widgetStateChange(this,n)});f.widgets[a.name]=a},focusChat:function(a,b){b=da(a,b);var c=this.tabs[b],e=this.panels[b];c&&c.isMinimize()&&c.restore();e&&e.focus()},chat:function(a,b){return this.panels[da(a,b)]},updateChat:function(a,b){b=P(b);for(var c,e=b.length,f,h=0;h<e;h++){c=b[h];(f=this.panels[da(a,c.id)])&&f.update(c)}},updateAllChat:function(){D(this.panels,
function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=ha(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{c&&c!=a&&this.tabs[c].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,
b,c,e,f){a=ya(a);var h=this;if(!h.chat(a,b)){var m=h.panels,n=da(a,b);e=h.tabs[n]=(new v.window(null,C({isMinimize:h.activeTabId||!h.options.chatAutoPop,tabWidth:h.tabWidth-2,titleVisibleLength:9},e))).bind("close",function(){h._onChatClose(n)}).bind("displayStateChange",function(p,z){h._onChatChange(n,z)});a=h.options.ui.addApp(h.options.chatApp,C({id:b,type:a,nick:f,window:e},c));m[n]=a;h.tabIds.push(n);h.$.tabs.insertBefore(e.element,h.$.tabs.firstChild);!e.isMinimize()&&h._changeActive(n);h._fitUI()}},
removeChat:function(a,b){var c=this.tabs[da(a,b)];c&&c.close()},removeAllChat:function(){D(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(k(a))D(a,function(f,h){b.addShortcut(h)});else if(B(a)){var c=b.$.shortcut,e=b.options.tpl_shortcut;if(!(c.childNodes.length>b.options.shortcutLength+1)){e=H(S(e,{title:q(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));ra(e.firstChild,"ui-state-hover");c.appendChild(e)}}}});O("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},
{_init:function(){$.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=P(a);var b=a.length,c=[];if(b){for(var e=0;e<b;e++)c.push(this._renderMsg(a[e]));this.$.content.innerHTML+=c.join("");this.trigger("update")}},_renderMsg:function(a){a=C({},a);$.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,e=a.timestamp,f=a.body,h=true,m=this._lastLogItem,n=[],p;p=a.nick;if(m&&m.to==c&&m.from==b&&e-m.timestamp<6E4)h=false;
if(h){this._lastLogItem=a;a=new g(e);n.push('<h4><span class="webim-gray">');n.push(a.getDay(true));n.push(" ");n.push(a.getTime());n.push("</span>");n.push(p);n.push('</h4><hr class="webim-line ui-state-default" />')}n.push("<p>");n.push(f);n.push("</p>");return n.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,e=new Date,f=[];c.setTime(a);b&&e.setTime(b.timestamp);if(!b||c.getDate()!=e.getDate()||c.getMonth()!=e.getMonth()){f.push("<h5>");f.push((new g(a)).getDay(true));
f.push("</h5>")}return f.join("")},ui:function(a){return C({element:this.element,$:this.$},a)},plugins:{}});var ga=function(){function a(e,f,h,m,n,p,z,s){if(f)return'<a href="'+(f=="www."?"http://"+e:e)+'"'+c+">"+e+"</a>";if(m)return'<a class="webim-img" href="'+p+'"'+c+'><img src="'+(s||p)+'" alt="'+(n||p)+'"/></a>';return'<a class="webim-file" href="'+p+'"'+c+">"+(n||p)+"</a>"}function b(e,f){c+=" "+e+'="'+f+'"'}var c;return function(e,f){c="";f&&B(f)&&D(f,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)|(\!?)\[([^\]]*)\]\(([^\)]+)\)(\(([^\)]+)\))?/ig,
a)}}();v.history.defaults.parseMsg=true;$.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=na(c);c=ga(c,{target:"_blank"});b.msg.body=c}});v.history.defaults.emot=true;$.add("history","emot",{render:function(a,b){b.msg.body=v.emot.parse(b.msg.body)}});O("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;D(b.firstChild.childNodes,function(c,e){y(e,"click",function(){L(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},
template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');D(a,function(c,e){var f=e.src,h=e.t?e.t:e.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(h);b.push('" alt="');b.push(e.q[0]);b.push('" rel="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return S(this.options.template,{emots:b.join("")})},toggle:function(){ea(this.element,"webim-emot-show")}});C(v.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",
q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",
q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=C({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";D(b.emots,function(f,h){if(h&&h.src)h.src=e+h.src;h&&h.q&&D(h.q,function(m,n){c[n]=f})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&D(b,function(e,f){var h=c[f],m=h.src,n=h.t?h.t:h.q[0],
p=[];p.push('<img src="');p.push(m);p.push('" title="');p.push(n);p.push('" alt="');p.push(h.q[0]);p.push('" />');e=na(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),p.join(""))});return a}});O("upload",{template:'<div class="webim-upload ui-widget-content"><form class="ui-helper-clearfix" id=":form" method="POST" enctype="multipart/form-data" encoding="multipart/form-data"><input id=":input" type="file" name="files" /><input class="ui-state-default ui-corner-all webim-upload-submit" type="submit" value="<%=upload%>" /></form></div>'},
{_init:function(){var a=this;a.$.form.setAttribute("action",W("upload"));r(a.$.form,function(b){if(b=b&&b[0])if(!b.url||b.error)alert(b.error||"Upload error");else{var c=["image/jpeg","image/jpg","image/gif","image/png"].indexOf(b.type)==-1?"":"!";c+="["+(b.name||"").replace(/\[|\]/ig,"")+"]("+b.url+")";if(b.thumbnailUrl)c+="("+b.thumbnailUrl+")";try{a.$.input.value=""}catch(e){}a.toggle();a.trigger("upload",c)}else alert("Upload error")})},toggle:function(){ea(this.element,"webim-upload-show")}});
Z("chat",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,f=c.room,h=c.history,m=a.id,n=a.type;if(n=="room"){var p=h.get("multicast",m);p||h.load("multicast",m);var z=c.room.get(m)||{id:m,nick:a.nick||m};z.presence="online";a=C({info:z,user:c.data.user},b.options.roomChatOptions,{history:p,block:true,emot:true,clearHistory:false,member:true,type:n,downloadHistory:false},a);var s=new v.chat(null,a);s.bind("sendMessage",function(t,w){c.sendMessage(w);h.set(w)}).bind("downloadHistory",function(t,w){h.download("multicast",
w.id)}).bind("select",function(t,w){w.presence="online";e.presence(w);b.layout.addChat("buddy",w.id,w.nick);b.layout.focusChat("buddy",w.id)}).bind("block",function(t,w){f.block(w.id)}).bind("unblock",function(t,w){f.unblock(w.id)}).bind("destroy",function(){s.options.info.blocked&&f.leave(m)});setTimeout(function(){s.options.info.blocked?f.join(m):f.initMember(m)},500);k(z.members)&&D(z.members,function(t,w){s.addMember(w.id,w.nick,w.id==c.data.user.id)})}else{(p=h.get("unicast",m))||h.load("unicast",
m);z=c.buddy.get(m)||{id:m,nick:a.nick||m};a=C({info:z,user:c.data.user},b.options.buddyChatOptions,{history:p,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},a);s=new v.chat(null,a);c.buddy.get(m)||c.buddy.update(m);s.bind("sendMessage",function(t,w){c.sendMessage(w);h.set(w)}).bind("sendStatus",function(t,w){c.sendStatus(w)}).bind("clearHistory",function(t,w){h.clear("unicast",w.id)}).bind("downloadHistory",function(t,w){h.download("unicast",w.id)})}return s});O("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t</div></div>',
template:'<div id=":container" class="webim-chat webim-box webim-flex"> \t<div class="webim-chat-notice-wrap1"><div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div> </div>\t<div id=":content" class="webim-chat-content webim-flex webim-box-h"> \t<div id=":sidebar" class="webim-chat-sidebar webim-box"></div><div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div> \t</div> \t<div id=":actions" class="webim-chat-actions"> \t<div id=":toolContent" class="webim-chat-tool-content"></div>\t<div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>\t<table class="webim-chat-t" cellSpacing="0"> \t<tr> \t<td style="vertical-align:top;"> \t<em class="webim-icon webim-icon-chat-edit"></em>\t</td> \t<td style="vertical-align:top;width:100%;"> \t<div class="webim-chat-input-wrap">\t<textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea> \t</div> \t</td> \t</tr> \t</table> \t</div> \t</div>'},
{_init:function(){var a=this,b=a.element,c=a.options,e=c.window,f=a.history=new v.history(null,{user:c.user,info:c.info});G(b,"webim-chat-"+c.type);a.$.main.insertBefore(f.element,a.$.main.firstChild);a.header=H(S(c.tpl_header));C(a.$,R(a.header));a._initEvents();e&&a.setWindow(e);c.simple&&F(a.header);a.update(c.info);f.add(c.history);$.call(a,"init",[null,a.ui()]);setTimeout(function(){a._adjustContent()},0)},setWindow:function(a,b){this.window=a;a.subHeader(this.header);!b&&a.html(this.element);
a.title(this.options.info.nick);this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(q("buddy offline notice",{name:this.options.info.nick}));else this.notice(q("user offline notice"));$.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;x.setTimeout(function(){try{a.focus()}catch(b){}},0)},_noticeTime:null,
_noticeTxt:"",notice:function(a,b){var c=this,e=c.$.notice,f=c._noticeTime;f&&clearTimeout(f);if(a)if(b){e.innerHTML=a;M(e);setTimeout(function(){if(c._noticeTxt)e.innerHTML=c._noticeTxt;else F(e,500)},b)}else{c._noticeTxt=a;e.innerHTML=a;M(e)}else{c._noticeTxt=null;F(e)}},_adjustContent:function(){var a=this.$.main;if(a.scrollTop!=a.scrollHeight)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b,c){if(c!=
"minimize"){x.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}}).bind("close",function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"multicast":"unicast",to:c.id,from:b.user.id,nick:b.user.nick,to_nick:c.nick,offline:c.presence!="online",timestamp:(new Date).getTime(),body:a};$.call(this,"send",[null,this.ui({msg:a})]);
this.trigger("sendMessage",[a])},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=ua(a),c=b.value;if(N(c).length){this.sendMessage(c);b.value="";I(a)}}else this._typing()},_onFocusInput:function(a){var b=this;ua(a);(x.getSelection?x.getSelection().toString():A.selection?A.selection.createRange().text:"")||x.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=q("input notice"),e=b.input;a.history.bind("update",
function(){a._adjustContent()}).bind("clear",function(){a.notice(q("clear history notice"),3E3)});y(e,"keyup",function(){Fa.call(this)});y(e,"click",Fa);y(e,"select",Fa);y(e,"focus",function(){L(this,"webim-gray");if(this.value==c)this.value=""});y(e,"blur",function(){if(this.value==""){G(this,"webim-gray");this.value=c}});y(e,"keypress",function(f){a._inputkeypress(f)});y(b.main,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)try{b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)}catch(c){}},100);b.userStatus.innerHTML=va(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var e=c.value,f=c.selectionStart,h=c.selectionEnd,m=e.substring(0,f);e=e.substring(h);h=a.length;c.value=m+a+e;c.setSelectionRange(f+h,
f+h)}else if(A.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",[{to:this.options.info.id,show:a}])}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=x.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=
a||"clear";var b=this.$.status,c=this.options.info.nick,e="";e=a=="clear"?"":c+q(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!="")this._setST=x.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return C({self:this,$:this.$,history:this.history},a)},plugins:{}});v.chat.defaults.emot=true;$.add("chat","emot",{init:function(a,b){var c=b.self,e=c.emot=new v.emot;e.bind("select",function(h,m){c.focus();c.insert(m,
true)});var f=H(S('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));y(f,"click",function(h){c.upload&&L(c.upload.element,"webim-upload-show");I(h);e.toggle()});b.$.toolContent.appendChild(e.element);b.$.tools.appendChild(f)},send:function(){}});v.chat.defaults.image=true;$.add("chat","image",{init:function(a,b){var c=b.self,e=c.upload=new v.upload;e.bind("upload",function(h,m){c.sendMessage(m)});var f=H(S('<a href="#chat-upload" title="<%=upload%>"><em class="webim-icon webim-icon-upload"></em></a>'));
y(f,"click",function(h){c.emot&&L(c.emot.element,"webim-emot-show");I(h);e.toggle()});b.$.toolContent.appendChild(e.element);b.$.tools.appendChild(f)},send:function(){}});v.chat.defaults.clearHistory=true;$.add("chat","clearHistory",{init:function(a,b){var c=b.self,e=H(S('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));y(e,"click",function(f){I(f);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(e)}});v.chat.defaults.block=
true;$.add("chat","block",{init:function(a,b){var c=b.self,e=c.options.info.blocked,f=c.options.info.nick,h=H('<a href="#chat-block" style="display:'+(e?"none":"")+'" title="'+q("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),m=H('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+q("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');y(h,"click",function(n){I(n);F(h);M(m);c.trigger("block",[c.options.info])});y(m,"click",
function(n){I(n);F(m);M(h);c.trigger("unblock",[c.options.info])});b.$.tools.appendChild(h);b.$.tools.appendChild(m)}});v.chat.defaults.member=true;C(v.chat.prototype,{addMember:function(a,b,c){var e=this,f=e.memberLi;if(!f[a]){var h=H('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");y(h.firstChild,"click",function(m){I(m);c||e.trigger("select",[{id:a,nick:b}])});f[a]=h;e.$.member.appendChild(h);e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=
this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});$.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var e=H(S('<div class="webim-box webim-flex  webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul" class="webim-flex"></ul></div>')),
f=R(e);c.member=f.ul;c.memberCount=f.memberCount;c.sidebar.appendChild(e)}});v.chat.defaults.downloadHistory=true;$.add("chat","downloadHistory",{init:function(a,b){var c=b.self,e=H(S('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));y(e,"click",function(f){I(f);c.trigger("downloadHistory",[c.options.info])});b.$.tools.appendChild(e)}});Z("setting",function(a){var b=this.im.setting,c=this.layout,e=this.setting=
new v.setting(null,a);c.addWidget(e,{title:q("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,h,m){typeof m!="object"&&e.check_tag(h,m)});e.bind("change",function(f,h,m){b.set(h,m)})});O("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},
{_init:function(){},template:function(){var a=this,b=[],c=a.options.data;c&&D(c,function(e,f){f&&typeof f!="boolean"||b.push(a._check_tpl(e,f))});return S(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&D(b,function(e){c[e]&&a._check_event(c[e])})},_check_tpl:function(a,b){return S(this.options.tpl_check,{label:q(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;y(a.firstChild,"click",function(){b._change(this.name,
this.checked)})},check_tag:function(a,b){var c=this;if(B(a))D(a,function(h,m){c.check_tag(h,m)});else{var e=c.$,f=e[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=b;else{f=e[a]=H(c._check_tpl(a,b));c._check_event(f);e.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});Z("user",function(a){a=a||{};var b=this.im,c=new v.user;!a.show&&F(c.element);a.container&&a.container.appendChild(c.element);c.bind("online",function(e,f){b.online(f)}).bind("offline",
function(){b.offline()}).bind("presence",function(e,f){b.sendPresence(f)});c.update(b.data.user);b.bind("online",function(){M(c.element);c.update(b.data.user)}).bind("offline",function(){c.show("unavailable")});return c});O("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;y(b.userShowTrigger,"click",function(e){c.style.display=="block"?F(c):M(c);I(e)});D(qa(c.firstChild),function(e,f){y(f,"click",function(h){a._set(this.href.split("#")[1]);F(c);I(h)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=va(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=q(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});Z("login",function(a){a=a||{};var b=this.im,c=new v.login(null,a);a.container&&a.container.appendChild(c.element);c.bind("login",function(e,f){b.online(f)});b.bind("online",function(){c.hide()}).bind("offline",function(e,f,h){f=="online"&&c.showError(h)});return c});O("login",{questions:null,notice:"",template:'<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?D(a,function(c,e){var f=A.createElement("option");f.value=e[0];f.innerHTML=e[1];b.question.appendChild(f)}):F(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;ra(b.submit,"ui-state-hover");y(b.form,"submit",function(c){I(c);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){F(this.element)},show:function(){M(this.element)},
hideError:function(){F(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=q(a);M(b)},destroy:function(){}});Z("buddy",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,f=b.layout,h=new v.buddy(null,C({title:a.title||q("buddy")},a));f.addWidget(h,{className:"webim-buddy-window",title:a.title||q("buddy"),titleVisibleLength:19,sticky:c.setting.get("buddy_sticky"),isMinimize:!c.status.get("b"),icon:"buddy"});h.bind("select",function(s,t){b.layout.addChat("buddy",t.id);b.layout.focusChat("buddy",
t.id)});var m;if(!a.disable_user){m=b.addApp("user",a.userOptions);if(a.is_login){h.window.subHeader(m.element);m=null}}!a.is_login&&!a.disable_login&&b.addApp("login",C({container:h.$.content},a.loginOptions));c.setting.bind("update",function(s,t){if(s=="buddy_sticky")h.window.option.sticky=t});h.window&&h.window.bind("displayStateChange",function(s,t){if(t!="minimize"){e.options.active=true;c.status.set("b",1);e.complete()}else{c.status.set("b",0);e.options.active=false}});var n=function(s){return B(s)?
s.id:s},p=function(s){return s.show!="invisible"&&s.presence=="online"},z=function(s){return s.show=="invisible"};e.bind("online",function(s,t){h.add(ha(t,p))});e.bind("offline",function(s,t){h.remove(ca(t,n))});e.bind("update",function(s,t){h.add(ha(t,p));h.update(ha(t,p));h.remove(ca(ha(t,z),n))});h.offline();c.bind("beforeOnline",function(){h.online()}).bind("online",function(){m&&h.window.subHeader(m.element);h.titleCount()}).bind("offline",function(){h.offline()});return h});O("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},
{_init:function(){var a=this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&G(this.element,"webim-buddy-hidegroup");a.simple&&G(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=q("search buddy");y(c.firstChild,"click",function(){e.focus()});e.value=f;y(e,"focus",function(){G(c,"ui-state-active");if(this.value==f)this.value=""});y(e,"blur",function(){L(c,"ui-state-active");if(this.value=="")this.value=f});y(e,
"keyup",function(){var h=this.value;D(a.li,function(m,n){h&&(n.text||n.innerHTML.replace(/<[^>]*>/g,"")).indexOf(h)==-1?F(n):M(n)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?F(c):M(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){ea(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},
5E3)},_title:function(a){var b=this.window;b&&b.title(this.options.title+"["+q(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");F(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();F(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a=a.nextSibling;var c=b.show?b.show:"available";a.className=
"webim-icon webim-icon-"+c;a.setAttribute("title",q(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=va(b.status)||"&nbsp;";return a},showCount:function(a,b){var c=this.li;c[a]&&xa(c[a].firstChild.firstChild,b)},_addOne:function(a,b){var c=this,e=c.li,f=a.id,h=c.$.ul;if(!e[f]){c.size++;if(!a.default_pic_url)a.default_pic_url=
"";a.status=va(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=q(a.show);a.pic_url=a.pic_url||"";e=e[f]=H(S(c.options.tpl_li,a));y(e.firstChild,"click",function(p){c.active(f);I(p);c.showCount(f,0);c.trigger("select",[a]);this.blur()});var m=c.groups,n=q(a.group||"friend");m=m[n];if(!m){m=H(S(c.options.tpl_group));F(m);if(n==q("stranger"))b=true;b?h.appendChild(m):h.insertBefore(m,h.firstChild);m={name:n,el:m,count:0,title:m.firstChild,li:m.lastChild};c.groups[n]=m}m.count==0&&M(m.el);
c.li_group[f]=m;m.li.appendChild(e);m.count++;m.title.innerHTML=n+"("+m.count+")"}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=P(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=P(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,e=this.li,f,h=this.li_group;a=J(a);for(var m=0;m<
a.length;m++){b=a[m];if(c=e[b]){this.size--;if(f=h[b]){f.count--;f.count==0&&F(f.el);f.title.innerHTML=f.name+"("+f.count+")"}ja(c);delete e[b]}}this.titleCount()},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},active:function(a){if(this.options.highlightable){this._actived&&L(this._actived.firstChild,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){G(a.firstChild,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}},destroy:function(){}});
Z("room",function(){function a(n){var p=n.nick;n=C({},n,{group:"group",nick:p+"("+(parseInt(n.count)+"/"+parseInt(n.all_count))+")"});h.updateChat(n);n.blocked&&(n.nick=p+"("+q("blocked")+")");m.li[n.id]?m.update(n):m.add(n)}var b=this,c=b.im,e=c.room,f=c.setting,h=b.layout,m=b.room=(new webim.ui.room(null)).bind("select",function(n,p){b.layout.addChat("room",p.id);b.layout.focusChat("room",p.id)});h.addWidget(m,{container:"tab",title:q("room"),icon:"room",sticky:c.setting.get("buddy_sticky"),onlyIcon:true,
isMinimize:true});c.setting.bind("update",function(n,p,z){if(p=="buddy_sticky")m.window.options.sticky=z});e.bind("join",function(n,p){a(p)}).bind("leave",function(){}).bind("block",function(n,p,z){f.set("blocked_rooms",z);a(e.get(p));e.leave(p)}).bind("unblock",function(n,p,z){f.set("blocked_rooms",z);a(e.get(p));e.join(p)}).bind("addMember",function(n,p){a(e.get(p))}).bind("removeMember",function(n,p){a(e.get(p))})});O("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content webim-flex">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;M(this.$.empty)},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=q("search room");y(c.firstChild,"click",function(){e.focus()});e.value=f;y(e,"focus",function(){G(c,
"ui-state-active");if(this.value==f)this.value=""});y(e,"blur",function(){L(c,"ui-state-active");if(this.value=="")this.value=f});y(e,"keyup",function(){var h=this.value;D(a.li,function(m,n){h&&(n.text||n.innerHTML.replace(/<[^>]*>/g,"")).indexOf(h)==-1?F(n):M(n)})})},scroll:function(a){ea(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",
b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,e=a.id,f=b.$.ul;b.size++;if(!c[e]){if(!a.default_pic_url)a.default_pic_url="";c=c[e]=H(S(b.options.tpl_li,a));y(c.firstChild,"click",function(h){I(h);b.trigger("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=P(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){F(this.$.empty);a=P(a);for(var b=
0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,e=this.li;a=J(a);for(var f=0;f<a.length;f++){b=a[f];if(c=e[b]){ja(c);delete e[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});Z("menu",function(a){var b=this.layout;a=this.menu=new v.menu(null,a);b.addWidget(a,{title:q("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},
null,"shortcut")});O("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&F(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&D(c,function(e,f){b.push(a._li_tpl(f))});return S(a.options.template,
{list:b.join("")})},_li_tpl:function(a){return S(this.options.tpl_li,{title:q(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(k(a))D(a,function(e,f){b.add(f)});else{var c=b.$;F(c.empty);c.ul.appendChild(H(b._li_tpl(a)))}},destroy:function(){}});Z("chatlink",function(a){var b=this,c=b.im,e=b.chatlink=(new webim.ui.chatlink(null,a)).bind("select",function(m,n){b.layout.addChat("buddy",
n);b.layout.focusChat("buddy",n)}),f=function(m){return m.show!="invisible"&&m.presence=="online"},h=function(m){return m.show=="invisible"};c.buddy.bind("online",function(m,n){e.add(ha(n,f))}).bind("update",function(m,n){e.add(ha(n,f));e.remove(ha(n,h))}).bind("offline",function(m,n){e.remove(n)});c.bind("beforeOnline",function(m,n){n.stranger_ids=e.idsArray()}).bind("online",function(){e.remove(c.data.user)}).bind("offline",function(){e.removeAll()})});O("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,
/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,link_class:null,off_link_class:null,link_wrap:null,space_wrap:null},{_init:function(){function a(U,T){if(!U)return false;for(var Y=T.length,ba=0;ba<Y;ba++){var za=T[ba].exec(U);if(za&&za[1])return za[1]}return false}
var b=this.list={},c=this.options,e=this.anthors={},f=c.link_href,h=c.space_href,m=c.space_id,n=c.off_link_class,p=c.link_class,z=c.space_class,s=c.space_wrap||A;(c=(c.link_wrap||A).getElementsByTagName("a"))&&D(c,function(U,T){var Y=a(T.href,f),ba=T.innerHTML;if(Y&&qa(T.firstChild).length==0&&ba&&(!T.className||!p||p.test(T.className))&&(!T.className||!n||!n.test(T.className))){e[Y]?e[Y].push(T):e[Y]=[T];b[Y]={id:Y,name:ba}}});if(h=a(x.location.href,h)){b[h]=C(b[h],{id:h});s=s.getElementsByTagName("*");
c=s.length;for(var t,w,K,aa=0;aa<c;aa++){t=s[aa];w=t.className;K=t.id;if(z&&z.test(w)||m&&m.test(K)){t=qa(t.firstChild);if(t.length){t=t[t.length-1];e[h]?e[h].push(t):e[h]=[t]}break}}}},_temp:function(a){var b=this;a=H(S('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',a));y(a,"click",function(c){b.trigger("select",this.id);oa(c);I(c)});return a},idsArray:function(){var a=[];D(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,c=this.anthors,
e=a.length,f,h,m,n,p;for(f=0;f<e;f++){h=a[f];if(h.id&&(m=h.uid)&&(n=b[m])){p=c[m];if(!n.elements&&p){n.elements=[];for(var z=0;z<p.length;z++)if(p[z].tagName.toLowerCase()=="li"){n.elements[z]=A.createElement("li");n.elements[z].appendChild(this._temp({id:h.id,title:"",text:q("chat with me")}))}else n.elements[z]=this._temp({id:h.id,title:q("chat with",{name:n.name}),text:""})}p&&D(p,function(s,t){t.parentNode.insertBefore(n.elements[s],t.nextSibling)})}}},remove:function(a){var b=this.list,c=a.length,
e,f,h,m;for(e=0;e<c;e++){f=a[e];if(f.id&&(h=f.uid)&&(m=b[h]))m.elements&&D(m.elements,function(n,p){ja(p)})}},removeAll:function(){D(this.list,function(a,b){b.elements&&D(b.elements,function(c,e){ja(e)})})}});V("notification",{url:"webim/notifications"},{_init:function(){this.request=this.options.jsonp?jsonp:fa},grep:function(a){return a&&a.text},handle:function(a){a=ha(P(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){this.request({url:W("notifications"),cache:false,dataType:"json",
context:this,success:this.handle})}});Z("notification",function(a){var b=this.im,c=this.layout,e=this.notification=new v.notification(null,a),f=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});c.addWidget(e,{title:q("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});f.bind("data",function(h,m){e.window.notifyUser("information","+"+m.length);e.add(m)});setTimeout(function(){f.load()},2E3)});O("notification",{template:'<div id="webim-notification" class="webim-notification">\t<ul id=":ul"><%=list%></ul>\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&F(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&D(c,function(e,f){b.push(a._li_tpl(f))});return S(a.options.template,{list:b.join("")})},_li_tpl:function(a){return S(this.options.tpl_li,{text:a.text,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=
this;if(k(a))D(a,function(e,f){b.add(f)});else{var c=b.$;F(c.empty);c.ul.appendChild(H(b._li_tpl(a)))}},destroy:function(){}});Z("layout.popup",function(a){a=a||{};var b=this.im,c=b.buddy,e=b.history,f=b.status,h=new v["layout.popup"](null,C({},a,{ui:this}));b.bind("beforeOnline",function(n,p){C(p,{buddy_ids:f.get("_cacheBuddy"),room_ids:"",show:"available"})});b.bind("online",function(n,p){h.options.user=p.user});var m=function(n){return n&&n.id};a=function(){var n=ca(c.all(true),m);f.set("_cacheBuddy",
n.join(","));h.updateAllChat()};c.bind("online",a).bind("offline",a);e.bind("unicast",function(n,p,z){(n=h.chat("unicast",p))&&n.history.add(z)});e.bind("clear",function(n,p,z){(n=h.chat(p,z))&&n.history.clear()});b.bind("message",function(n,p){for(var z=false,s=p.length,t,w=b.data.user.id,K,aa,U=h.widget("buddy"),T=0;T<s;T++){t=p[T];K=t.id;type=t.type;(aa=h.chat(type,K))&&aa.status("");aa||U.showCount(K,"+1");if(t.from!=w)z=true}if(z){ka.play("msg");Ea(q("new message"),5)}});b.bind("status",function(n,
p){D(p,function(z,s){var t=b.data.user.id,w=s.from;if(!(t!=s.to&&t!=s.from))(t=h.chat("buddy",w))&&t.status(s.show)})});return h});O("layout.popup",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout webim-popup ui-helper-clearfix"><div id=":left" class="webim-popup-left"></div><div id=":right" class="webim-popup-right"></div></div>\t</div>'},{_init:function(){C(this,
{widgets:{}})},buildUI:function(){},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var c=self.win=new v.window(null,C(b,{closeable:false,minimizable:false,isMinimize:false}));a.window=c;c.html(a.element);this.$.left.appendChild(c.element);this.widgets[a.name]=a},focusChat:function(a,b){da(a,b)},chat:function(a,b){if(!a||this.__chat&&this.__chat.__id==da(a,b))return this.__chat;return null},updateChat:function(){},updateAllChat:function(){var a=this.chat();a&&a.update()},addChat:function(a,
b,c,e,f){a=ya(a);var h=this;h.__chat&&ja(h.__chat.window.element);var m=h.win=(new v.window(null,C({minimizable:false},e))).bind("close",function(){h.__chat=null;h.widgets.buddy&&h.widgets.buddy.active()});c=h.__chat=h.options.ui.addApp("chat",C({id:b,type:a,nick:f,winOptions:e,clearHistory:false,downloadHistory:false},c));c.__id=da(a,b);c.setWindow(m);h.$.right.appendChild(m.element)}})})(window,document);
