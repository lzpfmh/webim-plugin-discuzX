(function(v,x,ia){function oa(d){return pa.call(d)==="[object Function]"}function ja(d){return pa.call(d)==="[object Array]"}function ta(d){return d&&pa.call(d)==="[object Object]"}function qa(d){return(d||"").replace(/^\s+|\s+$/g,"")}function na(d,h){var g=false;if(ta(h)){d=d||{};for(var j in h){var l=h[j];if(d[j]!=l){g=g||{};g[j]=l}}}return g}function ga(d){var h=[];if(d!=null){var g=d.length;if(g==null||typeof d==="string"||oa(d)||d.setInterval)h[0]=d;else for(;g;)h[--g]=d[g]}return h}function D(){var d=
arguments[0]||{},h=1,g=arguments.length,j=false,l;if(typeof d==="boolean"){j=d;d=arguments[1]||{};h=2}if(typeof d!=="object"&&!oa(d))d={};for(;h<g;h++)if((l=arguments[h])!=null)for(var n in l){var s=d[n],z=l[n];if(d!==z)if(j&&z&&typeof z==="object"&&!z.nodeType)d[n]=D(j,s||(z.length!=null?[]:{}),z);else if(z!==ia)d[n]=z}return d}function G(d,h,g){var j,l=0,n=d.length,s=n===ia||oa(d);if(g)if(s)for(j in d){if(h.apply(d[j],g)===false)break}else for(;l<n;){if(h.apply(d[l++],g)===false)break}else if(s)for(j in d){if(h.call(d[j],
j,d[j])===false)break}else for(g=d[0];l<n&&h.call(g,l,g)!==false;g=d[++l]);return d}function ua(d,h){for(var g=[],j,l=0,n=d.length;l<n;l++){j=h(d[l],l);if(j!=null)g[g.length]=j}return g.concat.apply([],g)}function Y(d){this.type=d;this.timeStamp=(new Date).getTime()}function Z(d){this.URL=d;this._setting();this._connect()}function J(d,h){var g=this;h=h||{};var j=g.ws=new WebSocket(d);j.onopen=function(){g.trigger("open","success");j.send("subscribe "+h.domain+" "+h.ticket)};j.onclose=function(l){g.trigger("close",
[l.data])};j.onmessage=function(l){l=l.data;try{l=l?v.JSON&&v.JSON.parse?v.JSON.parse(l):(new Function("return "+l))():l}catch(n){}g.trigger("message",[l])};j.onerror=function(){g.trigger("error",[])}}function E(d,h,g){if(typeof h!="undefined"){g=g||{};if(h===null){h="";g.expires=-1}var j="";if(g.expires&&(typeof g.expires=="number"||g.expires.toUTCString)){if(typeof g.expires=="number"){j=new Date;j.setTime(j.getTime()+g.expires*24*60*60*1E3)}else j=g.expires;j="; expires="+j.toUTCString()}var l=
g.path?"; path="+g.path:"",n=g.domain?"; domain="+g.domain:"";g=g.secure?"; secure":"";x.cookie=[d,"=",encodeURIComponent(h),j,l,n,g].join("")}else{h=null;if(x.cookie&&x.cookie!=""){g=x.cookie.split(";");for(j=0;j<g.length;j++){l=qa(g[j]);if(l.substring(0,d.length+1)==d+"="){h=decodeURIComponent(l.substring(d.length+1));break}}}return h}}function S(d,h){this.options=D({},S.defaults,h);this._init(d,h)}function w(d){return d&&d.split?d.split(","):ja(d)?d:parseInt(d)?[parseInt(d)]:[]}function ka(d,h,
g){function j(l,n){this.data=l;this.options=D({},j.defaults,n);oa(this._init)&&this._init()}j.defaults=h;Y.on(j);D(j.prototype,g);S[d]=j}function F(d,h){if(typeof d=="string"){d[d]=h;if(h===ia)return F[d]}D(F,d)}var pa=Object.prototype.toString;Y.on=function(){for(var d,h=Y.on.prototype,g=0,j=arguments.length;g<j;g++){d=arguments[g].prototype;d.bind=d.addEventListener=h.addEventListener;d.unbind=d.removeEventListener=h.removeEventListener;d.trigger=d.dispatchEvent=h.dispatchEvent}};Y.on.prototype=
{addEventListener:function(d,h){var g=this.__listeners=this.__listeners||{};g[d]=g[d]||[];g[d].push(h);return this},dispatchEvent:function(d,h){var g=this.__listeners=this.__listeners||{};d=d.type?d:new Y(d);g=g[d.type];if(Object.prototype.toString.call(h)==="[object Array]")h.unshift(d);else h=[d,h];if(g)for(var j=0,l=g.length;j<l;j++)g[j].apply(this,h);return this},removeEventListener:function(d,h){var g=this.__listeners=this.__listeners||{};if(g[d])if(h){g=g[d];for(var j=g.length;j--;)g[j]===h&&
g.splice(j,1)}else delete g[d];return this}};var O=function(){function d(p){var i={};for(var y in d.settings)i[y]=d.settings[y];if(p)for(y in p)i[y]=p[y];var H,Q,$,ca=i.type.toUpperCase(),wa=l.test(ca),U,M,xa=v,L;i.url=i.url.replace(la,"");i.context=p&&p.context!=null?p.context:i;if(i.data&&i.processData&&typeof i.data!=="string")i.data=h(i.data,i.traditional);var aa=V.exec(i.url);y=v.location;aa=aa&&(aa[1]&&aa[1]!==y.protocol||aa[2]!==y.host);/https?:/i.test(y.protocol)||(aa=false);aa=i.forceRemote?
true:aa;if(i.dataType==="jsonp"&&!aa)i.dataType="json";if(i.dataType==="jsonp"){if(ca==="GET")s.test(i.url)||(i.url+=(z.test(i.url)?"&":"?")+(i.jsonp||"callback")+"=?");else if(!i.data||!s.test(i.data))i.data=(i.data?i.data+"&":"")+(i.jsonp||"callback")+"=?";i.dataType="json"}if(i.dataType==="json"&&(i.data&&s.test(i.data)||s.test(i.url))){H=i.jsonpCallback||"jsonp"+g++;if(i.data)i.data=(i.data+"").replace(s,"="+H+"$1");i.url=i.url.replace(s,"="+H+"$1");i.dataType="script";var ya=v[H],va=false;v[H]=
function(f){if(!va){va=true;if(Object.prototype.toString.call(ya)==="[object Function]")ya(f);else{v[H]=ia;try{delete v[H]}catch(k){}}$=f;B.handleSuccess(i,A,Q,$);B.handleComplete(i,A,Q,$);U&&U.removeChild(L);M&&M.parentNode&&M.parentNode.removeChild(M)}}}if(i.dataType==="script"&&i.cache===null)i.cache=false;if(i.cache===false&&ca==="GET"){var ma=(new Date).getTime(),N=i.url.replace(K,"$1_="+ma);i.url=N+(N===i.url?(z.test(i.url)?"&":"?")+"_="+ma:"")}if(i.data&&ca==="GET")i.url+=(z.test(i.url)?"&":
"?")+i.data;i.global&&B.active++;if(i.dataType==="script"&&ca==="GET"&&aa){p=false;if(H&&i.async&&!j)if(v._fragmentProxy)U=M=x.createDocumentFragment();else{p=true;if(i.url.slice(0,1)=="/")i.url=y.protocol+"//"+y.host+(y.port?":"+y.port:"")+i.url;else if(!/^https?:\/\//i.test(i.url)){y=y.href;ca=/([^?#]+)\//.exec(y);i.url=(ca?ca[1]:y)+"/"+i.url}i.url=i.url.replace("="+H,"=parent."+H);M=x.createElement("iframe");M.style.position="absolute";M.style.left="-100px";M.style.top="-100px";M.style.height=
"1px";M.style.width="1px";M.style.visibility="hidden";x.body.insertBefore(M,x.body.firstChild);xa=M.contentWindow}var W=function(){var f=xa.document;U=U||f.getElementsByTagName("head")[0]||f.documentElement;L=f.createElement("script");if(i.scriptCharset)L.charset=i.scriptCharset;L.src=i.url;if(j)L.async=i.async;if(H)L.onload=L.onerror=L.onreadystatechange=function(){if(!va&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){va=true;B.handleError(i,A,"error","load error");
U&&L.parentNode&&U.removeChild(L);M&&M.parentNode&&M.parentNode.removeChild(M)}};else{var k=false;L.onload=L.onreadystatechange=function(){if(!k&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){k=true;B.handleSuccess(i,A,Q,$);B.handleComplete(i,A,Q,$);L.onload=L.onreadystatechange=null;U&&L.parentNode&&U.removeChild(L)}}}U.insertBefore(L,U.firstChild)};p?setTimeout(function(){W()},0):W();return ia}var ra=false,A=i.xhr();if(A){i.username?A.open(ca,i.url,i.async,i.username,
i.password):A.open(ca,i.url,i.async);try{if(i.data!=null&&!wa||p&&p.contentType)A.setRequestHeader("Content-Type",i.contentType);if(i.ifModified){B.lastModified[i.url]&&A.setRequestHeader("If-Modified-Since",B.lastModified[i.url]);B.etag[i.url]&&A.setRequestHeader("If-None-Match",B.etag[i.url])}aa||A.setRequestHeader("X-Requested-With","XMLHttpRequest");A.setRequestHeader("Accept",i.dataType&&i.accepts[i.dataType]?i.accepts[i.dataType]+", */*; q=0.01":i.accepts._default)}catch(za){}if(i.beforeSend&&
i.beforeSend.call(i.context,A,i)===false){i.global&&B.active--;A.abort();return false}i.global&&B.triggerGlobal(i,"ajaxSend",[A,i]);var a=A.onreadystatechange=function(f){if(!A||A.readyState===0||f==="abort"){ra||B.handleComplete(i,A,Q,$);ra=true;if(A)A.onreadystatechange=B.noop}else if(!ra&&A&&(A.readyState===4||f==="timeout")){ra=true;A.onreadystatechange=B.noop;Q=f==="timeout"?"timeout":!B.httpSuccess(A)?"error":i.ifModified&&B.httpNotModified(A,i.url)?"notmodified":"success";var k;if(Q==="success")try{$=
B.httpData(A,i.dataType,i)}catch(m){Q="parsererror";k=m}if(Q==="success"||Q==="notmodified")H||B.handleSuccess(i,A,Q,$);else B.handleError(i,A,Q,k);H||B.handleComplete(i,A,Q,$);f==="timeout"&&A.abort();if(i.async)A=null}};try{var b=A.abort;A.abort=function(){A&&b.call&&b.call(A);a("abort")}}catch(c){}i.async&&i.timeout>0&&setTimeout(function(){A&&!ra&&a("timeout")},i.timeout);try{A.send(wa||i.data==null?null:i.data)}catch(e){B.handleError(i,A,null,e);B.handleComplete(i,A,Q,$)}i.async||a();return A}}
function h(p){var i=[];if(typeof p=="object"){for(var y in p)i[i.length]=encodeURIComponent(y)+"="+encodeURIComponent(p[y]);return i.join("&").replace(da,"+")}return p}var g=(new Date).getTime(),j=typeof x.createElement("script").async==="boolean",l=/^(?:GET|HEAD|DELETE)$/,n=/\S/,s=/\=\?(&|$)/,z=/\?/,K=/([?&])_=[^&]*/,V=/^(\w+:)?\/\/([^\/?#]+)/,da=/%20/g,la=/#.*$/;v._fragmentProxy=false;var ea=x.createDocumentFragment(),fa=x.createElement("script");try{fa.appendChild(x.createTextNode("window._fragmentProxy = true"))}catch(Aa){fa.text=
"window._fragmentProxy = true"}ea.appendChild(fa);ea=fa=null;d.param=h;var B={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(p,i,y,H){p.error&&p.error.call(p.context,i,y,H);p.global&&B.triggerGlobal(p,"ajaxError",[i,p,H])},handleSuccess:function(p,i,y,H){p.success&&p.success.call(p.context,H,y,i);p.global&&B.triggerGlobal(p,"ajaxSuccess",[i,p])},handleComplete:function(p,i,y){p.complete&&p.complete.call(p.context,i,y);p.global&&B.triggerGlobal(p,"ajaxComplete",[i,p]);p.global&&
B.active--},triggerGlobal:function(){},httpSuccess:function(p){try{return!p.status&&location.protocol==="file:"||p.status>=200&&p.status<300||p.status===304||p.status===1223}catch(i){}return false},httpNotModified:function(p,i){var y=p.getResponseHeader("Last-Modified"),H=p.getResponseHeader("Etag");if(y)B.lastModified[i]=y;if(H)B.etag[i]=H;return p.status===304},httpData:function(p,i,y){var H=p.getResponseHeader("content-type")||"",Q=i==="xml"||!i&&H.indexOf("xml")>=0;p=Q?p.responseXML:p.responseText;
Q&&p.documentElement.nodeName==="parsererror"&&B.error("parsererror");if(y&&y.dataFilter)p=y.dataFilter(p,i);if(typeof p==="string")if(i==="json"||!i&&H.indexOf("json")>=0)p=p?v.JSON&&v.JSON.parse?v.JSON.parse(p):(new Function("return "+p))():p;else if(i==="script"||!i&&H.indexOf("javascript")>=0)if(p&&n.test(p)){i=x.getElementsByTagName("head")[0]||x.documentElement;y=x.createElement("script");y.type="text/javascript";try{y.appendChild(x.createTextNode(p))}catch($){y.text=p}i.insertBefore(y,i.firstChild);
i.removeChild(y)}return p}};d.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new v.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};d.setup=function(p){if(p)for(var i in p)d.settings[i]=p[i]};if(v.ActiveXObject)d.settings.xhr=function(){if(v.location.protocol!==
"file:")try{return new v.XMLHttpRequest}catch(p){}try{return new v.ActiveXObject("Microsoft.XMLHTTP")}catch(i){}};return d}(),ha=v.JSON?v.JSON:function(){function d(j){return g[j]||"\\u00"+Math.floor(j.charCodeAt()/16).toString(16)+(j.charCodeAt()%16).toString(16)}function h(j){switch(Object.prototype.toString.call(j)){case "[object String]":return'"'+j.replace(/[\x00-\x1f\\"]/g,d)+'"';case "[object Array]":for(var l=[],n=j.length,s=0;s<n;s++)l.push(h(j[s]));return"["+l.join(",")+"]";case "[object Object]":l=
[];for(n in j)(s=h(j[n]))&&l.push(h(n)+":"+s);return"{"+l+"}";case "[object Number]":case "[object Boolean]":return String(j);case false:return"null"}return null}var g={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:h,parse:function(j){j=j.toString();if(!j||!j.length)return null;return(new Function("return "+j))()}}}();Z.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=Z.CLOSED;this._onPolling=this._connecting=false;
this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var d=this;if(d._connecting)return d;d.readyState=Z.CONNECTING;d._connecting=true;d._onPolling||v.setTimeout(function(){d._startPolling()},300);return d},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=Z.OPEN;this.trigger("open","success")},_onClose:function(d){this._setting();this.trigger("close",[d])},_onData:function(d){this.trigger("message",
[d])},_onError:function(d){this._setting();this.trigger("error",[d])},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;O({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(d){var h=this;h._onPolling=false;if(h._connecting)if(d){h._pollingTimes==1&&h._onConnect();h._onData(d);h._failTimes=0;h._pollTimer=v.setTimeout(function(){h._startPolling()},200)}else return h._onError("error data")},
_onPollError:function(d){var h=this;h._onPolling=false;if(h._connecting){h._failTimes++;if(h._pollingTimes==1)h._onError("can not connect.");else if(h._failTimes>1)h._onClose(d);else h._pollTimer=v.setTimeout(function(){h._startPolling()},200)}}};Z.CONNECTING=0;Z.OPEN=1;Z.CLOSED=2;Y.on(Z);J.prototype={readyState:0,send:function(){},close:function(){this.ws.close()}};J.enable=!!v.WebSocket;J.CONNECTING=0;J.OPEN=1;J.CLOSED=2;Y.on(J);Y.on(S);D(S.prototype,{_init:function(){this.data={user:{presence:"offline",
show:"unavailable"}};this.status=new S.status;this.setting=new S.setting;this.buddy=new S.buddy;this.room=new S.room(null,this.data);this.history=new S.history(null,this.data);this._initEvents()},_createConnect:function(){var d=this,h=d.data.connection;d.connection=d.options.connectionType!="jsonpd"&&h.websocket&&J.enable?new J(h.websocket,h):new Z(h.server+(/\?/.test(h)?"&":"?")+O.param({ticket:h.ticket,domain:h.domain}));d.connection.bind("connect",function(){}).bind("message",function(g,j){d.handle(j)}).bind("error",
function(){d._stop("connect","Connect Error")}).bind("close",function(){d._stop("connect","Disconnect")})},setUser:function(d){D(this.data.user,d)},_ready:function(d){var h=this;h._unloadFun=v.onbeforeunload;v.onbeforeunload=function(){h._deactivate()};h.trigger("beforeOnline",[d])},_go:function(){var d=this.data,h=this.history,g=this.buddy,j=this.room;h.options.userInfo=d.user;G(d.buddies,function(n,s){h.init("unicast",s.id,s.history)});g.set(d.buddies);G(d.rooms,function(n,s){h.init("multicast",
s.id,s.history)});g=this.setting.get("blocked_rooms");var l=d.rooms;ja(g)&&l&&G(g,function(n,s){l[s]&&(l[s].blocked=true)});j.set(l);j.options.ticket=d.connection.ticket;this.trigger("online",[d]);this._createConnect();if((d=d.new_messages)&&d.length){G(d,function(n,s){s["new"]=true});this.trigger("message",[d])}},_stop:function(d,h){v.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("offline",[d,h])},autoOnline:function(){return!this.status.get("o")},
_initEvents:function(){function d(l){var n={id:l.from,presence:l.type};if(l.show)n.show=l.show;if(l.nick)n.nick=l.nick;if(l.status)n.status=l.status;return n}var h=this,g=h.history,j=h.buddy;h.bind("message",function(l,n){for(var s=[],z=n.length,K=h.data.user.id,V,da,la,ea=0;ea<z;ea++){V=n[ea];la=V.type;da=la=="unicast"?V.to==K?V.from:V.to:V.to;V.id=da;if(la=="unicast"&&!V["new"]){da={id:da,presence:"online"};if(V.nick)da.nick=V.nick;s.push(da)}}if(s.length){j.presence(s);j.complete()}g.set(n)});
h.bind("presence",function(l,n){j.presence(ua(n,d))})},handle:function(d){d.messages&&d.messages.length&&this.trigger("message",[d.messages]);d.presences&&d.presences.length&&this.trigger("presence",[d.presences]);d.statuses&&d.statuses.length&&this.trigger("status",[d.statuses])},sendMessage:function(d){d.ticket=this.data.connection.ticket;this.trigger("sendMessage",[d]);O({type:"get",dataType:"jsonp",cache:false,url:F("message"),data:d})},sendStatus:function(d){d.ticket=this.data.connection.ticket;
this.trigger("sendStatus",[d]);O({type:"get",dataType:"jsonp",cache:false,url:F("status"),data:d})},sendPresence:function(d){d.ticket=this.data.connection.ticket;this.data.user.show=d.show;this.status.set("s",d.show);this.trigger("sendPresence",[d]);O({type:"get",dataType:"jsonp",cache:false,url:F("presence"),data:d})},online:function(d){var h=this,g=h.status,j=[],l=[],n=g.get("tabs"),s=g.get("tabIds");s&&s.length&&n&&G(n,function(z){z[0]=="b"&&j.push(z.slice(2));z[0]=="r"&&l.push(z.slice(2))});d=
D({buddy_ids:j.join(","),room_ids:l.join(","),show:g.get("s")||"available"},d);h._ready(d);g.set("o",false);g.set("s",d.show);O({type:"get",dataType:"jsonp",cache:false,url:F("online"),data:d,success:function(z){if(z)if(z.success){z.user=D(h.data.user,z.user,{presence:"online"});h.data=z;h._go()}else h._stop("online",z.error_msg);else h._stop("online","Not Found")},error:function(){h._stop("online","Not Found")}})},offline:function(){var d=this.data;this.connection.close();this._stop("offline","offline");
O({type:"get",dataType:"jsonp",cache:false,url:F("offline"),data:{status:"offline",ticket:d.connection.ticket}})},_deactivate:function(){var d=this.data;!d||!d.connection||!d.connection.ticket||O({type:"get",dataType:"jsonp",cache:false,url:F("deactivate"),data:{ticket:d.connection.ticket}})}});v.webim=S;D(S,{version:"1.1.0",defaults:{},log:function(){var d=new Date;["[",d.getHours(),":",d.getMinutes(),":",d.getSeconds(),"-",d.getMilliseconds(),"]"].join("");if(v&&v.console)v.console.log.apply(null,
arguments);else v&&v.runtime&&v.air&&v.air.Introspector&&v.air.Introspector.Console.log.apply(null,arguments)},idsArray:w,now:function(){return(new Date).getTime()},isFunction:oa,isArray:ja,isObject:ta,trim:qa,makeArray:ga,extend:D,each:G,inArray:function(d,h){for(var g=0,j=h.length;g<j;g++)if(h[g]===d)return g;return-1},grep:function(d,h,g){for(var j=[],l=0,n=d.length;l<n;l++)!g!==!h(d[l],l)&&j.push(d[l]);return j},map:ua,JSON:ha,ajax:O,comet:Z,socket:J,model:ka,route:F,ClassEvent:Y});ka("setting",
{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true,blocked_rooms:[]}},{_init:function(){this.data=D({},this.options.data,this.data)},get:function(d){return this.data[d]},set:function(d,h){var g=this,j=d;if(d){if(typeof d=="string"){j={};j[d]=h}var l=g.data,n=na(l,j);if(n){G(n,function(s,z){g.trigger("update",[s,z])});j=D({},l,j);g.data=j;O({type:"get",url:F("setting"),dataType:"jsonp",cache:false,data:{data:ha.stringify(j)}})}}}});ka("status",{key:"_webim"},{_init:function(){var d=
this.data,h=this.options.key;if(d)this._save(d);else this.data=(d=v.localStorage?v.localStorage.getItem(h):E(h))?ha.parse(d):{}},set:function(d,h){var g=d;if(typeof d=="string"){g={};g[d]=h}var j=this.data;na(j,g)&&this._save(D({},j,g))},get:function(d){return this.data[d]},clear:function(){this._save({})},_save:function(d){var h=this.options.key;this.data=d;d=ha.stringify(d);v.localStorage?v.localStorage.setItem(h,d):E(h,d,{path:"/",domain:x.domain})}});ka("buddy",{active:true},{_init:function(){this.data=
this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(d){var h=this.dataHash,g=0,j;for(var l in h)if(ta(d)){j=true;for(var n in d)if(d[n]!=h[l][n])j=false;j&&g++}else g++;return g},get:function(d){return this.dataHash[d]},complete:function(){var d=this.dataHash,h=[],g;for(var j in d){g=d[j];if(g.incomplete&&g.presence=="online"){g.incomplete=false;h.push(j)}}this.load(h)},update:function(d){this.load(d)},presence:function(d){var h=this.dataHash;
d=ja(d)?d:[d];for(var g in d){var j=d[g];j.presence=j.presence=="offline"?"offline":"online";j.incomplete=!h[j.id]}this.set(d)},load:function(d){d=w(d);d.length&&O({type:"get",url:F("buddies"),cache:false,dataType:"jsonp",data:{ids:d.join(",")},context:this,success:this.set})},set:function(d){var h=this.data,g=this.dataHash,j={};d=d||[];var l,n;for(var s in d){l=d[s];if(id=l.id){if(!g[id]){l.presence=l.presence||"online";l.show=l.show?l.show:l.presence=="offline"?"unavailable":"available";g[id]={};
h.push(g[id])}l.incomplete=!!l.incomplete;if(n=na(g[id],l)){l=n.presence||"update";j[l]=j[l]||[];D(g[id],n);j[l].push(g[id])}}}for(var z in j)this.trigger(z,[j[z]]);this.options.active&&this.complete()}});(function(){ka("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(d){return this.dataHash[d]},block:function(d){var h=this.dataHash[d];if(h&&!h.blocked){h.blocked=true;var g=[];G(this.dataHash,function(j,l){l.blocked&&g.push(l.id)});this.trigger("block",[d,g])}},unblock:function(d){var h=
this.dataHash[d];if(h&&h.blocked){h.blocked=false;var g=[];G(this.dataHash,function(j,l){l.blocked&&g.push(l.id)});this.trigger("unblock",[d,g])}},set:function(d){var h=this,g=h.data,j=h.dataHash;G(d,function(l,n){var s=n.id;if(s){n.members=n.members||[];n.count=n.count||0;n.all_count=n.all_count||0;if(j[s])D(j[s],n);else{j[s]=n;g.push(n)}h.trigger("join",[j[s]])}})},addMember:function(d,h){var g=this;if(ja(h))G(h,function(z,K){g.addMember(d,K)});else{var j=g.dataHash[d];if(j){for(var l=j.members,
n,s=l.length;s--;)if(l[s].id==h.id)n=l[s];if(!n){h.nick=h.nick;l.push(h);j.count=l.length;g.trigger("addMember",[d,h])}}}},removeMember:function(d,h){var g=this.dataHash[d];if(g){for(var j=g.members,l,n=j.length;n--;)if(j[n].id==h){l=j[n];j.splice(n,1);g.count--}l&&self.trigger("removeMember",[d,l])}},initMember:function(d){var h=this.dataHash[d];if(h&&!h.initMember){h.initMember=true;this.loadMember(d)}},loadMember:function(d){var h=this,g=h.options;O({type:"get",cache:false,url:F("members"),dataType:"jsonp",
data:{ticket:g.ticket,id:d},success:function(j){h.addMember(d,j)}})},join:function(d){var h=this,g=h.options,j=g.user;O({type:"get",cache:false,url:F("join"),dataType:"jsonp",data:{ticket:g.ticket,id:d,nick:j.nick},success:function(l){h.initMember(d);h.set([l])}})},leave:function(d){var h=this.options,g=this.dataHash[d],j=h.user;if(g){g.initMember=false;O({type:"get",cache:false,url:F("leave"),dataType:"jsonp",data:{ticket:h.ticket,id:d,nick:j.nick}});this.trigger("leave",[g])}},clear:function(){}})})();
ka("history",{},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{}},get:function(d,h){return this.data[d][h]},set:function(d){var h=this.data,g={unicast:{},multicast:{}};d=ga(d);var j=d.length,l,n,s=this.options.userInfo.id;if(j){for(var z=0;z<j;z++){l=d[z];K=l.type;if((n=K=="unicast"?l.to==s?l.from:l.to:l.to)&&K){g[K][n]=g[K][n]||[];g[K][n].push(l)}}for(var K in g)for(n in g[K]){l=g[K][n];if(h[K][n]){h[K][n]=h[K][n].concat(l);
this._triggerMsg(K,n,l)}else this.load(K,n)}}},_triggerMsg:function(d,h,g){this.trigger(d,[h,g])},clear:function(d,h){this.data[d][h]=[];this.trigger("clear",[d,h]);O({url:F("clear"),type:"get",cache:false,dataType:"jsonp",data:{type:d,id:h}})},download:function(d,h){var g=F("download"),j=x.createElement("iframe"),l=new Date,n=[];l={id:h,type:d,time:(new Date).getTime(),date:l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate()};for(var s in l)n[n.length]=encodeURIComponent(s)+"="+encodeURIComponent(l[s]);
g+=(/\?/.test(g)?"&":"?")+n.join("&");j.setAttribute("src",g);j.style.display="none";x.body.appendChild(j)},init:function(d,h,g){if(ja(g)){this.data[d][h]=g;this._triggerMsg(d,h,g)}},load:function(d,h){var g=this;g.data[d][h]=[];O({url:F("history"),cache:false,type:"get",dataType:"jsonp",data:{type:d,id:h},success:function(j){g.init(d,h,j)}})}})})(window,document);
(function(v,x,ia){function oa(){return false}function ja(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function ta(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function qa(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function na(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&c.push(a);return c}function ga(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function D(a,b){if(a)ga(a,b)||(a.className+=" "+b)}function G(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function ua(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function Y(a,b,c){w(a,"mouseover",function(){D(this,b);c&&G(this,c)});w(a,"mouseout",function(){G(this,
b);c&&D(this,c)})}function Z(a,b,c){if(typeof c==="boolean")c?D(a,b):G(a,b);else ga(a,b)?G(a,b):D(a,b)}function J(a){a&&a.style&&(a.style.display="block")}function E(a){a&&a.style&&(a.style.display="none")}function S(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function w(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](v.event)};a.attachEvent("on"+b,a[b+c])}}function ka(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=
true}}function F(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function pa(a){if(!a.target)a.target=a.srcElement||x;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function O(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";a.style.OUserSelect="none";a.style.WebkitUserSelect="none";w(a,"selectstart",oa)}function ha(){if(!U){U=true;if(M){for(var a,b=0;a=M[b++];)a();M=null}}}function d(){if(!xa){xa=true;if(x.readyState==="complete")return ha();
if(x.addEventListener)x.addEventListener("DOMContentLoaded",function(){x.removeEventListener("DOMContentLoaded",arguments.callee,false);ha()},false);else if(x.attachEvent){x.attachEvent("onreadystatechange",function(){if(x.readyState==="complete"){x.detachEvent("onreadystatechange",arguments.callee);ha()}});x.documentElement.doScroll&&v==v.top&&function(){if(!U){try{x.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}ha()}}()}w(v,"load",ha)}}function h(a){var b=new Date;
b.setTime(a?parseFloat(a)+h.timeSkew:(new Date).getTime());this.date=b}function g(a,b,c){c=p({locale:g.locale},c);c=g.dictionary[c.locale];fa(c)||(c={});a=c[a]===ia?a:c[a];if(b){ya=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,va)}return a}function j(a,b){this.element=a;this.options=p({},j.defaults,b);this._init()}function l(a){a=a.getElementsByTagName("*");for(var b,c,e={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==0)e[c.substring(1,c.length)]=b}return e}function n(a){var b=x.createElement("div");
b.innerHTML=a;return b=b.firstChild}function s(a,b,c){function e(f,k){this.id=ra++;this.name=a;this.className="webim-"+a;this.options=p({},e.defaults,k);if(this.element=f||this.template&&n(this.template())||this.options.template&&n(N(this.options.template))){this.options.className&&D(this.element,this.options.className);this.$=l(this.element)}la(this._init)&&this._init();la(this._initEvents)&&this._initEvents()}e.defaults=b;$.on(e);p(e.prototype,s.prototype,c);j[a]=e}function z(a,b){j.apps[a]=b||
{}}function K(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+b:a}function V(){x.selection&&(this.caretPos=x.selection.createRange())}var da=webim.idsArray,la=webim.isFunction,ea=webim.isArray,fa=webim.isObject,Aa=webim.trim,B=webim.makeArray,p=webim.extend,i=webim.each,y=webim.grep,H=webim.ajax,Q=webim.model,$=webim.ClassEvent,ca=webim.route,wa=webim.map,U=false,M=[],xa=false;h.timeSkew=0;h.init=function(a){h.timeSkew=(new Date).getTime()-parseFloat(a)};p(h.prototype,{getTime:function(){var a=
this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return g("dt:today");else if(a<864E5)return g("dt:yesterday")}return g("dt:monthdate",{month:g(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});
var L=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(c){p(b,c);c=b.lib+"?_"+(new Date).getTime();c=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+c+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+c+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+
c+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';try{x.getElementById("webim-flashlib-c").innerHTML=c}catch(e){}},play:function(c){c=ta(c)?c:b[c];if(a)try{x.getElementById("webim-flashlib").playSound(c?c:"/sound/sound.mp3")}catch(e){}}}}(),aa=function(){var a=false;w(v,"focus",function(){a=false});w(v,"blur",function(){a=true});var b=x.title,c=0,e=false;return function(f,k){if(a){if(m){clearInterval(m);c=0;e=false}var m=setInterval(function(){c++;e=!e;if(c==k||!a){clearInterval(m);
c=0;e=false}x.title=e?"["+f+"]"+b:b},1500)}}}(),ya={},va=function(a,b){return ya[b]||""};g.locale="zh-CN";g.dictionary={};g.store=function(a,b){var c=g.dictionary;fa(c[a])||(c[a]={});p(c[a],b)};$.on(j);p(j.prototype,{render:function(){var a=this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),b=this.options;this.layout=this.addApp(b.layout||"layout",b.layoutOptions);
a.setting.get("play_sound")?L.enable():L.disable();a.bind("online",function(c,e){h.init(e.server_time)});a.setting.bind("update",function(c,e,f){if("play_sound"==e)f?L.enable():L.disable()})},addApp:function(a,b){var c=j.apps[a];if(c)return la(c)&&c.apply(this,[b])},initSound:function(a){L.init(a||this.options.soundUrls)}});var ma=function(a,b){if(b===ia)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();J(a)}else{a.innerHTML=
"0";E(a)}return b},N=function(){function a(e,f){return b&&b[f]!=ia?b[f]:g(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(e,f){if(!e)return"";b=f;return e.replace(c,a)}}(),W={add:function(a,b,c){a=j[a].prototype;for(var e in c){a.plugins[e]=a.plugins[e]||[];a.plugins[e].push([b,c[e]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var e=0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,c)}},ra=1;p(s.prototype,{_init:function(){}});p(j,{version:"3.0.1",widget:s,
app:z,plugin:W,i18n:g,date:h,ready:function(a){d();U?a():M.push(a)},createElement:n,defaults:{},apps:{}});webim.ui=j;s("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){return this.$.content.appendChild(a)},subHeader:function(a){this.$.subHeader.innerHTML="";return this.$.subHeader.appendChild(a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&E(c.minimize);!b.maximizable&&E(c.maximize);if(!b.closeable){E(c.tabClose);E(c.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?E(c.tabTitle):
S(c.tabTip);b.count&&this.notifyUser("information",b.count);A(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(ma(c.tabCount,b)){D(c.tab,"ui-state-highlight");G(c.tab,"ui-state-default")}},_count:function(){return ma(this.$.tabCount)},title:function(a,b){var c=this.$,e=c.tabIcon;if(b)if(ta(b)){e.className="webim-icon";e.style.backgroundImage="url("+b+")"}else e.className="webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;e=this.options.titleVisibleLength;if(a){for(var f=
0,k=[],m=a.split(""),o=m.length,r=0;r<o;r++)if(f>=e||f<0)break;else{if(m[r].charCodeAt(0)>255)f+=2;else f++;k.push(m[r])}e=k.join("")}else e=a;(c.tabTitle.innerHTML=e)&&a&&e.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){ua(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return ga(this.element,"webim-window-active")},
activate:function(){if(!this.active()){D(this.element,"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){G(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;ua(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();ma(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!ga(this.element,
"webim-window-normal")){this._setVisibile();this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){ua(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");S(this.element)},_initEvents:function(){var a=this,b=a.$,c=b.tab,e=function(f){ka(f);F(f)};w(c,"click",function(f){a.isMinimize()?a.restore():a.minimize();e(f)});w(c,"mouseover",function(){D(this,"ui-state-hover");
G(this,"ui-state-default")});w(c,"mouseout",function(){G(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&D(this,"ui-state-default")});w(c,"mousedown",e);O(c);i(na(b.actions.firstChild),function(f,k){Y(k,"ui-state-hover")});i(["minimize","maximize","close","tabClose"],function(f,k){w(b[k],"click",function(m){this.disabled||a[k]();e(m)});w(b[k],"mousedown",e)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return ga(this.element,"webim-window-maximize")},
isMinimize:function(){return ga(this.element,"webim-window-minimize")}});var A=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},e=function(){this&&a==this&&(a=false)};w(x,"mousedown",function(f){f=pa(f);for(var k;f;)if(f.id==":webim-window"){k=f;break}else f=f.parentNode;if(k)(f=k.window)&&f.activate();else b()});return function(f){if(f.active()){b();a=f}f.bind("activate",c);f.bind("deactivate",e)}}();z("layout",function(a){function b(){if(f)return q.updateAllChat();
f=true;var t=o.get("tabs"),u=o.get("tabIds"),I=o.get("p"),ba=o.get("a");u&&u.length&&t&&i(t,function(R,T){var P=R.slice(2),X=R.slice(0,1);q.addChat(X,P,{},{isMinimize:true});q.chat(R).window.notifyUser("information",T.n)});I&&(q.prevCount=I)&&q._fitUI();ba&&q.focusChat(ba)}function c(){var t={};i(q.tabs,function(u,I){t[u]={n:I._count()}});o.set({tabs:t,tabIds:q.tabIds,p:q.prevCount,a:q.activeTabId})}a=a||{};var e=this.im,f=false,k=e.buddy,m=e.history,o=e.status,r=e.setting,C=e.room,q=new j.layout(null,
p({chatAutoPop:e.setting.get("msg_auto_pop")},a,{ui:this}));e.setting.get("minimize_layout")?q.collapse():q.expand();e.bind("beforeOnline",function(){q.changeState("ready")}).bind("online",function(t,u){q.changeState("active");q.options.user=u.user;b()}).bind("offline",function(t,u){u=="offline"&&q.removeAllChat();q.updateAllChat();q.changeState("stop")});r.bind("update",function(t,u,I){if("msg_auto_pop"==u)q.options.chatAutoPop=I;else if("minimize_layout"==u)I?q.collapse():q.expand()});k.bind("online",
function(t,u){q.updateChat("buddy",u)}).bind("offline",function(t,u){q.updateChat("buddy",u)}).bind("update",function(t,u){q.updateChat("buddy",u)});C.bind("addMember",function(t,u,I){(t=q.chat("room",u))&&t.addMember(I.id,I.nick,I.id==e.data.user.id)}).bind("removeMember",function(t,u,I){(t=q.chat("room",u))&&t.removeMember(I.id,I.nick)});q.bind("collapse",function(){r.set("minimize_layout",true)});q.bind("expand",function(){r.set("minimize_layout",false)});q.bind("displayUpdate",function(){c()});
e.bind("message",function(t,u){for(var I=false,ba=u.length,R,T=e.data.user.id,P,X,sa=0;sa<ba;sa++){R=u[sa];P=R.id;type=R.type;(X=q.chat(type,P))&&X.status("");if(!X){R.type==="unicast"?q.addChat(type,P,null,null,R.nick):q.addChat(type,P);X=q.chat(type,P)}X&&r.get("msg_auto_pop")&&!q.activeTabId&&q.focusChat(P);X.window.notifyUser("information","+1");P=X.window.pos;P==-1&&q.setNextMsgNum("+1");P==1&&q.setPrevMsgNum("+1");if(R.from!=T)I=true}if(I){L.play("msg");aa(g("new message"),5)}});e.bind("status",
function(t,u){i(u,function(I,ba){var R=e.data.user.id,T=ba.from;if(!(R!=ba.to&&R!=ba.from))(R=q.chat("buddy",T))&&R.status(ba.show)})});m.bind("unicast",function(t,u,I){(t=q.chat("unicast",u))&&t.history.add(I)});m.bind("multicast",function(t,u,I){(t=q.chat("multicast",u))&&t.history.add(I)});m.bind("clear",function(t,u,I){(t=q.chat(u,I))&&t.history.clear()});return q});s("layout",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">\t<div id=":shortcut" class="webim-shortcut">\t</div>\t<div class="webim-layout-r">\t<div id=":panels" class="webim-panels">\t<div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">\t<div id=":next" class="webim-window-tab webim-panels-next ui-state-default">\t<div id=":nextMsgCount" class="webim-window-tab-count">\t0\t</div>\t<em class="ui-icon ui-icon-triangle-1-w"></em>\t<span id=":nextCount">0</span>\t</div>\t</div>\t<div id=":tabsWrap" class="webim-panels-tab-wrap">\t<div id=":tabs" class="webim-panels-tab">\t</div>\t</div>\t<div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">\t<div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">\t<div id=":prevMsgCount" class="webim-window-tab-count">\t0\t</div>\t<span id=":prevCount">0</span>\t<em class="ui-icon ui-icon-triangle-1-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">\t<div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">\t<em class="ui-icon ui-icon-circle-arrow-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-expand-wrap ui-widget">\t<div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">\t<em class="ui-icon ui-icon-circle-arrow-w"></em>\t</div>\t</div>\t</div>\t<div id=":widgets" class="webim-widgets">\t</div>\t</div>\t</div></div>\t</div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">\t<div class="webim-window-tab-tip">\t<strong><%=title%></strong>\t</div>\t<em class="webim-icon" style="background-image:url(<%=icon%>)"></em>\t</a>\t</div>'},{_init:function(a,b){b=this.options;p(this,{window:v,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,
prevCount:0});b.unscalable&&D(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((x.compatMode==="CSS1Compat"&&x.documentElement.clientWidth||x.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,e=b.length,
f=this.prevCount;if(!(e<=c)){if(a){for(var k=0,m=0;m<e;m++)if(b[m]==a){k=m;break}if(k<=f)f=k;else if(k>=f+c)f=k-c+1}else f=e-c;this.prevCount=f}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,e=this.tabs,f=this.tabIds,k=f.length,m=0,o=0,r=0;r<k;r++){var C=e[f[r]];if(r<b||r>=c)if(a)J(C.element);else{this.activeTabId==f[r]&&C.minimize();var q=C._count();if(r<b){o+=q;C.pos=1}else{m+=q;C.pos=-1}E(C.element)}else{C.pos=0;J(C.element)}}if(!a){this.setNextMsgNum(m);this.setPrevMsgNum(o)}},
setNextMsgNum:function(a){ma(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){ma(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,e=b.nextCount;if(e>0&&a==-1||c>0&&a==1){b.slideing=true;if(e==1&&a==-1||c==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var f=b.$.tabs,k=parseFloat(f.style.left);c=-1*b.tabWidth*b.nextCount;var m=parseInt(500/13),o=1,r=(c-k)/m,C=setInterval(function(){f.style.left=
k+r*o+"px";if(o==m){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(C)}else o++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,c=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},
_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,e=this.nextCount;if(b<=a)c=e=0;else{e=b-a-c;e=e<0?0:e;c=b-a-e}this.prevCount=c;this.nextCount=e},_updateCountUI:function(){var a=this.$,b=this.prevCount,c=this.nextCount;c<=0?D(a.next,"ui-state-disabled"):G(a.next,"ui-state-disabled");b<=0?D(a.prev,"ui-state-disabled"):G(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display="block";a.prev.style.display="block"}else{E(a.next);E(a.prev)}a.nextCount.innerHTML=
c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;w(a.window,"resize",function(){if(c){c=true;a.buildUI()}});w(b.next,"mousedown",function(){a._slide(-1)});w(b.next,"mouseup",function(){a._slideUp()});O(b.next);w(b.prev,"mousedown",function(){a._slide(1)});w(b.prev,"mouseup",function(){a._slideUp()});O(b.prev);w(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});w(b.collapse,"click",function(){if(a.isMinimize())return false;
a.collapse();a.trigger("collapse");return false});Y(b.collapse,"ui-state-hover","ui-state-default");Y(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return ga(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||D(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&G(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=
-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&i(this.widgets,function(c,e){e.window!=a&&e.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,e){var f=this;b=p(b,{closeable:false,subHeader:a.header});var k=a.element;b=new j.window(null,b);b.html(k);f.$[e?e:"widgets"].insertBefore(b.element,c&&f.widgets[c]?f.widgets[c].window.element:
null);a.window=b;b.bind("displayStateChange",function(m,o){f._widgetStateChange(this,o)});f.widgets[a.name]=a},focusChat:function(a,b){b=K(a,b);var c=this.tabs[b],e=this.panels[b];c&&c.isMinimize()&&c.restore();e&&e.focus()},chat:function(a,b){return this.panels[K(a,b)]},updateChat:function(a,b){b=B(b);for(var c,e=b.length,f,k=0;k<e;k++){c=b[k];(f=this.panels[K(a,c.id)])&&f.update(c)}},updateAllChat:function(){i(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=y(this.tabIds,
function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{c&&c!=a&&this.tabs[c].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,c,e,f){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var k=
this;if(!k.chat(a,b)){c=k.options.ui.addApp("chat",p({id:b,type:a,nick:f,winOptions:e},c));f=k.panels;b=K(a,b);f[b]=c;a=k.tabs[b]=(new j.window(null,p({isMinimize:k.activeTabId||!k.options.chatAutoPop,tabWidth:k.tabWidth-2,titleVisibleLength:9},e))).bind("close",function(){k._onChatClose(b)}).bind("displayStateChange",function(m,o){k._onChatChange(b,o)});k.tabIds.push(b);k.$.tabs.insertBefore(a.element,k.$.tabs.firstChild);c.setWindow(a);!a.isMinimize()&&k._changeActive(b);k._fitUI()}},removeChat:function(a,
b){var c=this.tabs[K(a,b)];c&&c.close()},removeAllChat:function(){i(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(ea(a))i(a,function(f,k){b.addShortcut(k)});else if(fa(a)){var c=b.$.shortcut,e=b.options.tpl_shortcut;if(!(c.childNodes.length>b.options.shortcutLength+1)){e=n(N(e,{title:g(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));Y(e.firstChild,"ui-state-hover");c.appendChild(e)}}}});s("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},
{_init:function(){W.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=B(a);var b=a.length,c=[];if(b){for(var e=0;e<b;e++)c.push(this._renderMsg(a[e]));this.$.content.innerHTML+=c.join("");this.trigger("update")}},_renderMsg:function(a){a=p({},a);W.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,e=a.timestamp,f=a.body,k=true,m=this._lastLogItem,o=[],r;r=a.nick;if(m&&m.to==c&&m.from==b&&e-m.timestamp<6E4)k=false;
if(k){this._lastLogItem=a;a=new h(e);o.push('<h4><span class="webim-gray">');o.push(a.getDay(true));o.push(" ");o.push(a.getTime());o.push("</span>");o.push(r);o.push('</h4><hr class="webim-line ui-state-default" />')}o.push("<p>");o.push(f);o.push("</p>");return o.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,e=new Date,f=[];c.setTime(a);b&&e.setTime(b.timestamp);if(!b||c.getDate()!=e.getDate()||c.getMonth()!=e.getMonth()){f.push("<h5>");f.push((new h(a)).getDay(true));
f.push("</h5>")}return f.join("")},ui:function(a){return p({element:this.element,$:this.$},a)},plugins:{}});var za=function(){function a(e,f){return'<a href="'+(f=="www."?"http://"+e:e)+'"'+c+">"+e+"</a>"}function b(e,f){c+=" "+e+'="'+f+'"'}var c;return function(e,f){c="";f&&fa(f)&&i(f,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();j.history.defaults.parseMsg=true;W.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=ja(c);c=za(c,{target:"_blank"});b.msg.body=c}});j.history.defaults.emot=
true;W.add("history","emot",{render:function(a,b){b.msg.body=j.emot.parse(b.msg.body)}});s("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;i(b.firstChild.childNodes,function(c,e){w(e,"click",function(){G(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');i(a,function(c,e){var f=e.src,k=e.t?e.t:
e.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(k);b.push('" alt="');b.push(e.q[0]);b.push('" rel="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return N(this.options.template,{emots:b.join("")})},toggle:function(){Z(this.element,"webim-emot-show")}});p(j.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",
q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},
{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=p({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";i(b.emots,function(f,k){if(k&&k.src)k.src=e+k.src;k&&k.q&&i(k.q,function(m,o){c[o]=f})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&i(b,function(e,f){var k=c[f],m=k.src,o=k.t?k.t:k.q[0],r=[];r.push('<img src="');r.push(m);r.push('" title="');r.push(o);r.push('" alt="');r.push(k.q[0]);r.push('" />');e=
ja(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),r.join(""))});return a}});z("chat",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,f=c.room,k=c.history,m=a.id,o=a.type;if(o=="room"){var r=k.get("multicast",m);r||k.load("multicast",m);var C=c.room.get(m)||{id:m,nick:a.nick||m};C.presence="online";a=p({info:C,user:c.data.user},b.options.roomChatOptions,{history:r,block:true,emot:true,clearHistory:false,member:true,type:o,downloadHistory:false},
a);var q=new j.chat(null,a);q.bind("sendMessage",function(t,u){c.sendMessage(u);k.set(u)}).bind("downloadHistory",function(t,u){k.download("multicast",u.id)}).bind("select",function(t,u){u.presence="online";e.presence(u);b.layout.addChat("buddy",u.id,u.nick);b.layout.focusChat("buddy",u.id)}).bind("block",function(t,u){f.block(u.id)}).bind("unblock",function(t,u){f.unblock(u.id)}).bind("destroy",function(){q.options.info.blocked&&f.leave(m)});setTimeout(function(){q.options.info.blocked?f.join(m):
f.initMember(m)},500);ea(C.members)&&i(C.members,function(t,u){q.addMember(u.id,u.nick,u.id==c.data.user.id)})}else{(r=k.get("unicast",m))||k.load("unicast",m);C=c.buddy.get(m)||{id:m,nick:a.nick||m};a=p({info:C,user:c.data.user},b.options.buddyChatOptions,{history:r,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},a);q=new j.chat(null,a);c.buddy.get(m)||c.buddy.update(m);q.bind("sendMessage",function(t,u){c.sendMessage(u);k.set(u)}).bind("sendStatus",function(t,u){c.sendStatus(u)}).bind("clearHistory",
function(t,u){k.clear("unicast",u.id)}).bind("downloadHistory",function(t,u){k.download("unicast",u.id)})}return q});s("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t</div></div>',
template:'<div class="webim-chat webim-box webim-flex"> \t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div> \t<div id=":content" class="webim-chat-content webim-flex webim-box-h"> \t<div id=":sidebar" class="webim-chat-sidebar webim-box"></div><div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div> \t</div> \t<div id=":actions" class="webim-chat-actions"> \t<div id=":toolContent" class="webim-chat-tool-content"></div>\t<div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>\t<table class="webim-chat-t" cellSpacing="0"> \t<tr> \t<td style="vertical-align:top;"> \t<em class="webim-icon webim-icon-chat-edit"></em>\t</td> \t<td style="vertical-align:top;width:100%;"> \t<div class="webim-chat-input-wrap">\t<textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea> \t</div> \t</td> \t</tr> \t</table> \t</div> \t</div>'},
{_init:function(){var a=this,b=a.element,c=a.options,e=c.window,f=a.history=new j.history(null,{user:c.user,info:c.info});D(b,"webim-chat-"+c.type);a.$.main.insertBefore(f.element,a.$.main.firstChild);a.header=n(N(c.tpl_header));p(a.$,l(a.header));a._initEvents();e&&a.setWindow(e);c.simple&&E(a.header);a.update(c.info);f.add(c.history);W.call(a,"init",[null,a.ui()]);setTimeout(function(){a._adjustContent()},0)},setWindow:function(a){this.window=a;a.subHeader(this.header);a.html(this.element);a.title(this.options.info.nick);
this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(g("buddy offline notice",{name:this.options.info.nick}));else this.notice(g("user offline notice"));W.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;v.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var c=this,e=
c.$.notice,f=c._noticeTime;f&&clearTimeout(f);if(a)if(b){e.innerHTML=a;J(e);setTimeout(function(){if(c._noticeTxt)e.innerHTML=c._noticeTxt;else E(e,500)},b)}else{c._noticeTxt=a;e.innerHTML=a;J(e)}else{c._noticeTxt=null;E(e)}},_adjustContent:function(){var a=this.$.main;a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b,c){if(c!="minimize"){v.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}}).bind("close",
function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},_sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"multicast":"unicast",to:c.id,from:b.user.id,nick:b.user.nick,offline:c.presence!="online",timestamp:(new Date).getTime(),body:a};W.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMessage",[a])},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",
true);return true}else{var b=pa(a),c=b.value;if(Aa(c).length){this._sendMessage(c);b.value="";F(a)}}else this._typing()},_onFocusInput:function(a){var b=this;pa(a);(v.getSelection?v.getSelection().toString():x.selection?x.selection.createRange().text:"")||v.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=g("input notice"),e=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(g("clear history notice"),3E3)});w(e,"keyup",
function(){V.call(this)});w(e,"click",V);w(e,"select",V);w(e,"focus",function(){G(this,"webim-gray");if(this.value==c)this.value=""});w(e,"blur",function(){if(this.value==""){D(this,"webim-gray");this.value=c}});w(e,"keypress",function(f){a._inputkeypress(f)});w(b.main,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||
a.default_pic_url)b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=qa(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var e=c.value,f=c.selectionStart,k=c.selectionEnd,m=e.substring(0,f);e=e.substring(k);k=a.length;c.value=m+a+e;c.setSelectionRange(f+k,f+k)}else if(x.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;
else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",[{to:this.options.info.id,show:a}])}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=v.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,e="";e=a=="clear"?"":
c+g(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!="")this._setST=v.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return p({self:this,$:this.$,history:this.history},a)},plugins:{}});j.chat.defaults.emot=true;W.add("chat","emot",{init:function(a,b){var c=b.self,e=new j.emot;e.bind("select",function(k,m){c.focus();c.insert(m,true)});var f=n(N('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));
w(f,"click",function(k){F(k);e.toggle()});b.$.toolContent.appendChild(e.element);b.$.tools.appendChild(f)},send:function(){}});j.chat.defaults.clearHistory=true;W.add("chat","clearHistory",{init:function(a,b){var c=b.self,e=n(N('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));w(e,"click",function(f){F(f);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(e)}});j.chat.defaults.block=true;W.add("chat","block",{init:function(a,
b){var c=b.self,e=c.options.info.blocked,f=c.options.info.nick,k=n('<a href="#chat-block" style="display:'+(e?"none":"")+'" title="'+g("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),m=n('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+g("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');w(k,"click",function(o){F(o);E(k);J(m);c.trigger("block",[c.options.info])});w(m,"click",function(o){F(o);E(m);J(k);c.trigger("unblock",
[c.options.info])});b.$.tools.appendChild(k);b.$.tools.appendChild(m)}});j.chat.defaults.member=true;p(j.chat.prototype,{addMember:function(a,b,c){var e=this,f=e.memberLi;if(!f[a]){var k=n('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");w(k.firstChild,"click",function(m){F(m);c||e.trigger("select",[{id:a,nick:b}])});f[a]=k;e.$.member.appendChild(k);e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);
delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});W.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var e=n(N('<div class="webim-box webim-flex  webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul" class="webim-flex"></ul></div>')),f=l(e);c.member=f.ul;c.memberCount=
f.memberCount;c.sidebar.appendChild(e)}});j.chat.defaults.downloadHistory=true;W.add("chat","downloadHistory",{init:function(a,b){var c=b.self,e=n(N('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));w(e,"click",function(f){F(f);c.trigger("downloadHistory",[c.options.info])});b.$.tools.appendChild(e)}});z("setting",function(a){var b=this.im.setting,c=this.layout,e=this.setting=new j.setting(null,a);c.addWidget(e,
{title:g("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,k,m){typeof m!="object"&&e.check_tag(k,m)});e.bind("change",function(f,k,m){b.set(k,m)})});s("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},
template:function(){var a=this,b=[],c=a.options.data;c&&i(c,function(e,f){f&&typeof f!="boolean"||b.push(a._check_tpl(e,f))});return N(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&i(b,function(e){c[e]&&a._check_event(c[e])})},_check_tpl:function(a,b){return N(this.options.tpl_check,{label:g(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;w(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,
b){var c=this;if(fa(a))i(a,function(k,m){c.check_tag(k,m)});else{var e=c.$,f=e[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=b;else{f=e[a]=n(c._check_tpl(a,b));c._check_event(f);e.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});z("user",function(a){a=a||{};var b=this.im,c=new j.user;E(c.element);a.container&&a.container.appendChild(c.element);c.bind("online",function(e,f){b.online(f)}).bind("offline",function(){b.offline()}).bind("presence",
function(e,f){b.sendPresence(f)});c.update(b.data.user);b.bind("online",function(){J(c.element);c.update(b.data.user)}).bind("offline",function(){c.show("unavailable")});return c});s("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;w(b.userShowTrigger,"click",function(e){c.style.display=="block"?E(c):J(c);F(e)});i(na(c.firstChild),function(e,f){w(f,"click",function(k){a._set(this.href.split("#")[1]);E(c);F(k)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=qa(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=g(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});z("login",function(a){a=a||{};var b=this.im,c=new j.login(null,a);a.container&&a.container.appendChild(c.element);c.bind("login",function(e,f){b.online(f)});b.bind("online",function(){c.hide()}).bind("offline",function(e,f,k){f=="online"&&c.showError(k)});return c});s("login",{questions:null,notice:"",template:'<div>  \t\t<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?i(a,function(c,e){var f=x.createElement("option");f.value=e[0];f.innerHTML=e[1];b.question.appendChild(f)}):E(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;Y(b.submit,"ui-state-hover");w(b.form,"submit",function(c){F(c);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){E(this.element)},show:function(){J(this.element)},
hideError:function(){E(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=g(a);J(b)},destroy:function(){}});z("buddy",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,f=b.layout,k=new j.buddy(null,p({title:g("buddy")},a));f.addWidget(k,{className:"webim-buddy-window",title:g("buddy"),titleVisibleLength:19,sticky:c.setting.get("buddy_sticky"),isMinimize:!c.status.get("b"),icon:"buddy"});k.bind("select",function(q,t){b.layout.addChat("buddy",t.id);b.layout.focusChat("buddy",t.id)});
var m;if(!a.disable_user){m=b.addApp("user",a.userOptions);if(a.is_login){k.window.subHeader(m.element);m=null}}!a.is_login&&!a.disable_login&&b.addApp("login",p({container:k.$.content},a.loginOptions));c.setting.bind("update",function(q,t){if(q=="buddy_sticky")k.window.option.sticky=t});k.window&&k.window.bind("displayStateChange",function(q){if(q!="minimize"){e.options.active=true;c.status.set("b",1);e.complete()}else{c.status.set("b",0);e.options.active=false}});var o=function(q){return fa(q)?
q.id:q},r=function(q){return q.show!="invisible"&&q.presence=="online"},C=function(q){return q.show=="invisible"};e.bind("online",function(q,t){k.add(y(t,r))});e.bind("offline",function(q,t){k.remove(wa(t,o))});e.bind("update",function(q,t){k.add(y(t,r));k.update(y(t,r));k.remove(wa(y(t,C),o))});k.offline();c.bind("beforeOnline",function(){k.online()}).bind("online",function(){m&&k.window.subHeader(m.element);k.titleCount()}).bind("offline",function(){k.offline()});return k});s("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},
{_init:function(){var a=this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&D(this.element,"webim-buddy-hidegroup");a.simple&&D(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=g("search buddy");w(c.firstChild,"click",function(){e.focus()});e.value=f;w(e,"focus",function(){D(c,"ui-state-active");if(this.value==f)this.value=""});w(e,"blur",function(){G(c,"ui-state-active");if(this.value=="")this.value=f});w(e,
"keyup",function(){var k=this.value;i(a.li,function(m,o){k&&(o.text||o.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?E(o):J(o)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?E(c):J(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){Z(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},
5E3)},_title:function(a){var b=this.window;b&&b.title(this.options.title+"["+g(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");E(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();E(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a=a.nextSibling;var c=b.show?b.show:"available";a.className=
"webim-icon webim-icon-"+c;a.setAttribute("title",g(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=qa(b.status)||"&nbsp;";return a},showCount:function(a,b){var c=this.li;c[a]&&ma(c[a].firstChild.firstChild,b)},_addOne:function(a,b){var c=this,e=c.li,f=a.id,k=c.$.ul;if(!e[f]){c.size++;if(!a.default_pic_url)a.default_pic_url=
"";a.status=qa(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=g(a.show);a.pic_url=a.pic_url||"";e=e[f]=n(N(c.options.tpl_li,a));w(e.firstChild,"click",function(r){F(r);c.showCount(f,0);c.trigger("select",[a]);this.blur()});var m=c.groups,o=g(a.group||"friend");m=m[o];if(!m){m=n(N(c.options.tpl_group));E(m);if(o==g("stranger"))b=true;b?k.appendChild(m):k.insertBefore(m,k.firstChild);m={name:o,el:m,count:0,title:m.firstChild,li:m.lastChild};c.groups[o]=m}m.count==0&&J(m.el);c.li_group[f]=
m;m.li.appendChild(e);m.count++;m.title.innerHTML=o+"("+m.count+")"}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=B(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=B(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,e=this.li,f,k=this.li_group;a=da(a);for(var m=0;m<a.length;m++){b=
a[m];if(c=e[b]){this.size--;if(f=k[b]){f.count--;f.count==0&&E(f.el);f.title.innerHTML=f.name+"("+f.count+")"}S(c);delete e[b]}}this.titleCount()},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});z("room",function(){function a(o){var r=o.nick;o=p({},o,{group:"group",nick:r+"("+(parseInt(o.count)+"/"+parseInt(o.all_count))+")"});k.updateChat(o);o.blocked&&(o.nick=r+"("+g("blocked")+")");m.li[o.id]?m.update(o):m.add(o)}var b=this,c=b.im,e=c.room,f=c.setting,k=
b.layout,m=b.room=(new webim.ui.room(null)).bind("select",function(o,r){b.layout.addChat("room",r.id);b.layout.focusChat("room",r.id)});k.addWidget(m,{container:"tab",title:g("room"),icon:"room",sticky:c.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true});c.setting.bind("update",function(o,r,C){if(r=="buddy_sticky")m.window.options.sticky=C});e.bind("join",function(o,r){a(r)}).bind("leave",function(){}).bind("block",function(o,r,C){f.set("blocked_rooms",C);a(e.get(r));e.leave(r)}).bind("unblock",
function(o,r,C){f.set("blocked_rooms",C);a(e.get(r));e.join(r)}).bind("addMember",function(o,r){a(e.get(r))}).bind("removeMember",function(o,r){a(e.get(r))})});s("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content webim-flex">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;J(this.$.empty)},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=g("search room");w(c.firstChild,"click",function(){e.focus()});e.value=f;w(e,"focus",function(){D(c,
"ui-state-active");if(this.value==f)this.value=""});w(e,"blur",function(){G(c,"ui-state-active");if(this.value=="")this.value=f});w(e,"keyup",function(){var k=this.value;i(a.li,function(m,o){k&&(o.text||o.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?E(o):J(o)})})},scroll:function(a){Z(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",
b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,e=a.id,f=b.$.ul;b.size++;if(!c[e]){if(!a.default_pic_url)a.default_pic_url="";c=c[e]=n(N(b.options.tpl_li,a));w(c.firstChild,"click",function(k){F(k);b.trigger("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=B(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){E(this.$.empty);a=B(a);for(var b=
0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,e=this.li;a=da(a);for(var f=0;f<a.length;f++){b=a[f];if(c=e[b]){S(c);delete e[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});z("menu",function(a){var b=this.layout;a=this.menu=new j.menu(null,a);b.addWidget(a,{title:g("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},
null,"shortcut")});s("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&E(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&i(c,function(e,f){b.push(a._li_tpl(f))});return N(a.options.template,
{list:b.join("")})},_li_tpl:function(a){return N(this.options.tpl_li,{title:g(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(ea(a))i(a,function(e,f){b.add(f)});else{var c=b.$;E(c.empty);c.ul.appendChild(n(b._li_tpl(a)))}},destroy:function(){}});z("chatlink",function(a){var b=this,c=b.im,e=b.chatlink=(new webim.ui.chatlink(null,a)).bind("select",function(m,o){b.layout.addChat("buddy",
o);b.layout.focusChat("buddy",o)}),f=function(m){return m.show!="invisible"&&m.presence=="online"},k=function(m){return m.show=="invisible"};c.buddy.bind("online",function(m,o){e.add(y(o,f))}).bind("update",function(m,o){e.add(y(o,f));e.remove(y(o,k))}).bind("offline",function(m,o){e.remove(o)});c.bind("beforeOnline",function(m,o){o.stranger_ids=e.idsArray()}).bind("online",function(){e.remove(c.data.user)}).bind("offline",function(){e.removeAll()})});s("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,
/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,link_class:null,off_link_class:null,link_wrap:null,space_wrap:null},{_init:function(){function a(R,T){if(!R)return false;for(var P=T.length,X=0;X<P;X++){var sa=T[X].exec(R);if(sa&&sa[1])return sa[1]}return false}
var b=this.list={},c=this.options,e=this.anthors={},f=c.link_href,k=c.space_href,m=c.space_id,o=c.off_link_class,r=c.link_class,C=c.space_class,q=c.space_wrap||x;(c=(c.link_wrap||x).getElementsByTagName("a"))&&i(c,function(R,T){var P=a(T.href,f),X=T.innerHTML;if(P&&na(T.firstChild).length==0&&X&&(!T.className||!r||r.test(T.className))&&(!T.className||!o||!o.test(T.className))){e[P]?e[P].push(T):e[P]=[T];b[P]={id:P,name:X}}});if(k=a(v.location.href,k)){b[k]=p(b[k],{id:k});q=q.getElementsByTagName("*");
c=q.length;for(var t,u,I,ba=0;ba<c;ba++){t=q[ba];u=t.className;I=t.id;if(C&&C.test(u)||m&&m.test(I)){t=na(t.firstChild);if(t.length){t=t[t.length-1];e[k]?e[k].push(t):e[k]=[t]}break}}}},_temp:function(a){var b=this;a=n(N('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',a));w(a,"click",function(c){b.trigger("select",this.id);ka(c);F(c)});return a},idsArray:function(){var a=[];i(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,c=this.anthors,
e=a.length,f,k,m,o,r;for(f=0;f<e;f++){k=a[f];if(k.id&&(m=k.uid)&&(o=b[m])){r=c[m];if(!o.elements&&r){o.elements=[];for(var C=0;C<r.length;C++)if(r[C].tagName.toLowerCase()=="li"){o.elements[C]=x.createElement("li");o.elements[C].appendChild(this._temp({id:k.id,title:"",text:g("chat with me")}))}else o.elements[C]=this._temp({id:k.id,title:g("chat with",{name:o.name}),text:""})}r&&i(r,function(q,t){t.parentNode.insertBefore(o.elements[q],t.nextSibling)})}}},remove:function(a){var b=this.list,c=a.length,
e,f,k,m;for(e=0;e<c;e++){f=a[e];if(f.id&&(k=f.uid)&&(m=b[k]))m.elements&&i(m.elements,function(o,r){S(r)})}},removeAll:function(){i(this.list,function(a,b){b.elements&&i(b.elements,function(c,e){S(e)})})}});Q("notification",{url:"webim/notifications"},{_init:function(){this.request=this.options.jsonp?jsonp:H},grep:function(a){return a&&a.text},handle:function(a){a=y(B(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){this.request({url:ca("notifications"),cache:false,dataType:"json",
context:this,success:this.handle})}});z("notification",function(a){var b=this.im,c=this.layout,e=this.notification=new j.notification(null,a),f=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});c.addWidget(e,{title:g("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});f.bind("data",function(k,m){e.window.notifyUser("information","+"+m.length);e.add(m)});setTimeout(function(){f.load()},2E3)});s("notification",{template:'<div id="webim-notification" class="webim-notification">\t<ul id=":ul"><%=list%></ul>\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&E(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&i(c,function(e,f){b.push(a._li_tpl(f))});return N(a.options.template,{list:b.join("")})},_li_tpl:function(a){return N(this.options.tpl_li,{text:a.text,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=
this;if(ea(a))i(a,function(e,f){b.add(f)});else{var c=b.$;E(c.empty);c.ul.appendChild(n(b._li_tpl(a)))}},destroy:function(){}})})(window,document);
(function(v,x,ia){function oa(d){return pa.call(d)==="[object Function]"}function ja(d){return pa.call(d)==="[object Array]"}function ta(d){return d&&pa.call(d)==="[object Object]"}function qa(d){return(d||"").replace(/^\s+|\s+$/g,"")}function na(d,h){var g=false;if(ta(h)){d=d||{};for(var j in h){var l=h[j];if(d[j]!=l){g=g||{};g[j]=l}}}return g}function ga(d){var h=[];if(d!=null){var g=d.length;if(g==null||typeof d==="string"||oa(d)||d.setInterval)h[0]=d;else for(;g;)h[--g]=d[g]}return h}function D(){var d=
arguments[0]||{},h=1,g=arguments.length,j=false,l;if(typeof d==="boolean"){j=d;d=arguments[1]||{};h=2}if(typeof d!=="object"&&!oa(d))d={};for(;h<g;h++)if((l=arguments[h])!=null)for(var n in l){var s=d[n],z=l[n];if(d!==z)if(j&&z&&typeof z==="object"&&!z.nodeType)d[n]=D(j,s||(z.length!=null?[]:{}),z);else if(z!==ia)d[n]=z}return d}function G(d,h,g){var j,l=0,n=d.length,s=n===ia||oa(d);if(g)if(s)for(j in d){if(h.apply(d[j],g)===false)break}else for(;l<n;){if(h.apply(d[l++],g)===false)break}else if(s)for(j in d){if(h.call(d[j],
j,d[j])===false)break}else for(g=d[0];l<n&&h.call(g,l,g)!==false;g=d[++l]);return d}function ua(d,h){for(var g=[],j,l=0,n=d.length;l<n;l++){j=h(d[l],l);if(j!=null)g[g.length]=j}return g.concat.apply([],g)}function Y(d){this.type=d;this.timeStamp=(new Date).getTime()}function Z(d){this.URL=d;this._setting();this._connect()}function J(d,h){var g=this;h=h||{};var j=g.ws=new WebSocket(d);j.onopen=function(){g.trigger("open","success");j.send("subscribe "+h.domain+" "+h.ticket)};j.onclose=function(l){g.trigger("close",
[l.data])};j.onmessage=function(l){l=l.data;try{l=l?v.JSON&&v.JSON.parse?v.JSON.parse(l):(new Function("return "+l))():l}catch(n){}g.trigger("message",[l])};j.onerror=function(){g.trigger("error",[])}}function E(d,h,g){if(typeof h!="undefined"){g=g||{};if(h===null){h="";g.expires=-1}var j="";if(g.expires&&(typeof g.expires=="number"||g.expires.toUTCString)){if(typeof g.expires=="number"){j=new Date;j.setTime(j.getTime()+g.expires*24*60*60*1E3)}else j=g.expires;j="; expires="+j.toUTCString()}var l=
g.path?"; path="+g.path:"",n=g.domain?"; domain="+g.domain:"";g=g.secure?"; secure":"";x.cookie=[d,"=",encodeURIComponent(h),j,l,n,g].join("")}else{h=null;if(x.cookie&&x.cookie!=""){g=x.cookie.split(";");for(j=0;j<g.length;j++){l=qa(g[j]);if(l.substring(0,d.length+1)==d+"="){h=decodeURIComponent(l.substring(d.length+1));break}}}return h}}function S(d,h){this.options=D({},S.defaults,h);this._init(d,h)}function w(d){return d&&d.split?d.split(","):ja(d)?d:parseInt(d)?[parseInt(d)]:[]}function ka(d,h,
g){function j(l,n){this.data=l;this.options=D({},j.defaults,n);oa(this._init)&&this._init()}j.defaults=h;Y.on(j);D(j.prototype,g);S[d]=j}function F(d,h){if(typeof d=="string"){d[d]=h;if(h===ia)return F[d]}D(F,d)}var pa=Object.prototype.toString;Y.on=function(){for(var d,h=Y.on.prototype,g=0,j=arguments.length;g<j;g++){d=arguments[g].prototype;d.bind=d.addEventListener=h.addEventListener;d.unbind=d.removeEventListener=h.removeEventListener;d.trigger=d.dispatchEvent=h.dispatchEvent}};Y.on.prototype=
{addEventListener:function(d,h){var g=this.__listeners=this.__listeners||{};g[d]=g[d]||[];g[d].push(h);return this},dispatchEvent:function(d,h){var g=this.__listeners=this.__listeners||{};d=d.type?d:new Y(d);g=g[d.type];if(Object.prototype.toString.call(h)==="[object Array]")h.unshift(d);else h=[d,h];if(g)for(var j=0,l=g.length;j<l;j++)g[j].apply(this,h);return this},removeEventListener:function(d,h){var g=this.__listeners=this.__listeners||{};if(g[d])if(h){g=g[d];for(var j=g.length;j--;)g[j]===h&&
g.splice(j,1)}else delete g[d];return this}};var O=function(){function d(p){var i={};for(var y in d.settings)i[y]=d.settings[y];if(p)for(y in p)i[y]=p[y];var H,Q,$,ca=i.type.toUpperCase(),wa=l.test(ca),U,M,xa=v,L;i.url=i.url.replace(la,"");i.context=p&&p.context!=null?p.context:i;if(i.data&&i.processData&&typeof i.data!=="string")i.data=h(i.data,i.traditional);var aa=V.exec(i.url);y=v.location;aa=aa&&(aa[1]&&aa[1]!==y.protocol||aa[2]!==y.host);/https?:/i.test(y.protocol)||(aa=false);aa=i.forceRemote?
true:aa;if(i.dataType==="jsonp"&&!aa)i.dataType="json";if(i.dataType==="jsonp"){if(ca==="GET")s.test(i.url)||(i.url+=(z.test(i.url)?"&":"?")+(i.jsonp||"callback")+"=?");else if(!i.data||!s.test(i.data))i.data=(i.data?i.data+"&":"")+(i.jsonp||"callback")+"=?";i.dataType="json"}if(i.dataType==="json"&&(i.data&&s.test(i.data)||s.test(i.url))){H=i.jsonpCallback||"jsonp"+g++;if(i.data)i.data=(i.data+"").replace(s,"="+H+"$1");i.url=i.url.replace(s,"="+H+"$1");i.dataType="script";var ya=v[H],va=false;v[H]=
function(f){if(!va){va=true;if(Object.prototype.toString.call(ya)==="[object Function]")ya(f);else{v[H]=ia;try{delete v[H]}catch(k){}}$=f;B.handleSuccess(i,A,Q,$);B.handleComplete(i,A,Q,$);U&&U.removeChild(L);M&&M.parentNode&&M.parentNode.removeChild(M)}}}if(i.dataType==="script"&&i.cache===null)i.cache=false;if(i.cache===false&&ca==="GET"){var ma=(new Date).getTime(),N=i.url.replace(K,"$1_="+ma);i.url=N+(N===i.url?(z.test(i.url)?"&":"?")+"_="+ma:"")}if(i.data&&ca==="GET")i.url+=(z.test(i.url)?"&":
"?")+i.data;i.global&&B.active++;if(i.dataType==="script"&&ca==="GET"&&aa){p=false;if(H&&i.async&&!j)if(v._fragmentProxy)U=M=x.createDocumentFragment();else{p=true;if(i.url.slice(0,1)=="/")i.url=y.protocol+"//"+y.host+(y.port?":"+y.port:"")+i.url;else if(!/^https?:\/\//i.test(i.url)){y=y.href;ca=/([^?#]+)\//.exec(y);i.url=(ca?ca[1]:y)+"/"+i.url}i.url=i.url.replace("="+H,"=parent."+H);M=x.createElement("iframe");M.style.position="absolute";M.style.left="-100px";M.style.top="-100px";M.style.height=
"1px";M.style.width="1px";M.style.visibility="hidden";x.body.insertBefore(M,x.body.firstChild);xa=M.contentWindow}var W=function(){var f=xa.document;U=U||f.getElementsByTagName("head")[0]||f.documentElement;L=f.createElement("script");if(i.scriptCharset)L.charset=i.scriptCharset;L.src=i.url;if(j)L.async=i.async;if(H)L.onload=L.onerror=L.onreadystatechange=function(){if(!va&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){va=true;B.handleError(i,A,"error","load error");
U&&L.parentNode&&U.removeChild(L);M&&M.parentNode&&M.parentNode.removeChild(M)}};else{var k=false;L.onload=L.onreadystatechange=function(){if(!k&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){k=true;B.handleSuccess(i,A,Q,$);B.handleComplete(i,A,Q,$);L.onload=L.onreadystatechange=null;U&&L.parentNode&&U.removeChild(L)}}}U.insertBefore(L,U.firstChild)};p?setTimeout(function(){W()},0):W();return ia}var ra=false,A=i.xhr();if(A){i.username?A.open(ca,i.url,i.async,i.username,
i.password):A.open(ca,i.url,i.async);try{if(i.data!=null&&!wa||p&&p.contentType)A.setRequestHeader("Content-Type",i.contentType);if(i.ifModified){B.lastModified[i.url]&&A.setRequestHeader("If-Modified-Since",B.lastModified[i.url]);B.etag[i.url]&&A.setRequestHeader("If-None-Match",B.etag[i.url])}aa||A.setRequestHeader("X-Requested-With","XMLHttpRequest");A.setRequestHeader("Accept",i.dataType&&i.accepts[i.dataType]?i.accepts[i.dataType]+", */*; q=0.01":i.accepts._default)}catch(za){}if(i.beforeSend&&
i.beforeSend.call(i.context,A,i)===false){i.global&&B.active--;A.abort();return false}i.global&&B.triggerGlobal(i,"ajaxSend",[A,i]);var a=A.onreadystatechange=function(f){if(!A||A.readyState===0||f==="abort"){ra||B.handleComplete(i,A,Q,$);ra=true;if(A)A.onreadystatechange=B.noop}else if(!ra&&A&&(A.readyState===4||f==="timeout")){ra=true;A.onreadystatechange=B.noop;Q=f==="timeout"?"timeout":!B.httpSuccess(A)?"error":i.ifModified&&B.httpNotModified(A,i.url)?"notmodified":"success";var k;if(Q==="success")try{$=
B.httpData(A,i.dataType,i)}catch(m){Q="parsererror";k=m}if(Q==="success"||Q==="notmodified")H||B.handleSuccess(i,A,Q,$);else B.handleError(i,A,Q,k);H||B.handleComplete(i,A,Q,$);f==="timeout"&&A.abort();if(i.async)A=null}};try{var b=A.abort;A.abort=function(){A&&b.call&&b.call(A);a("abort")}}catch(c){}i.async&&i.timeout>0&&setTimeout(function(){A&&!ra&&a("timeout")},i.timeout);try{A.send(wa||i.data==null?null:i.data)}catch(e){B.handleError(i,A,null,e);B.handleComplete(i,A,Q,$)}i.async||a();return A}}
function h(p){var i=[];if(typeof p=="object"){for(var y in p)i[i.length]=encodeURIComponent(y)+"="+encodeURIComponent(p[y]);return i.join("&").replace(da,"+")}return p}var g=(new Date).getTime(),j=typeof x.createElement("script").async==="boolean",l=/^(?:GET|HEAD|DELETE)$/,n=/\S/,s=/\=\?(&|$)/,z=/\?/,K=/([?&])_=[^&]*/,V=/^(\w+:)?\/\/([^\/?#]+)/,da=/%20/g,la=/#.*$/;v._fragmentProxy=false;var ea=x.createDocumentFragment(),fa=x.createElement("script");try{fa.appendChild(x.createTextNode("window._fragmentProxy = true"))}catch(Aa){fa.text=
"window._fragmentProxy = true"}ea.appendChild(fa);ea=fa=null;d.param=h;var B={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(p,i,y,H){p.error&&p.error.call(p.context,i,y,H);p.global&&B.triggerGlobal(p,"ajaxError",[i,p,H])},handleSuccess:function(p,i,y,H){p.success&&p.success.call(p.context,H,y,i);p.global&&B.triggerGlobal(p,"ajaxSuccess",[i,p])},handleComplete:function(p,i,y){p.complete&&p.complete.call(p.context,i,y);p.global&&B.triggerGlobal(p,"ajaxComplete",[i,p]);p.global&&
B.active--},triggerGlobal:function(){},httpSuccess:function(p){try{return!p.status&&location.protocol==="file:"||p.status>=200&&p.status<300||p.status===304||p.status===1223}catch(i){}return false},httpNotModified:function(p,i){var y=p.getResponseHeader("Last-Modified"),H=p.getResponseHeader("Etag");if(y)B.lastModified[i]=y;if(H)B.etag[i]=H;return p.status===304},httpData:function(p,i,y){var H=p.getResponseHeader("content-type")||"",Q=i==="xml"||!i&&H.indexOf("xml")>=0;p=Q?p.responseXML:p.responseText;
Q&&p.documentElement.nodeName==="parsererror"&&B.error("parsererror");if(y&&y.dataFilter)p=y.dataFilter(p,i);if(typeof p==="string")if(i==="json"||!i&&H.indexOf("json")>=0)p=p?v.JSON&&v.JSON.parse?v.JSON.parse(p):(new Function("return "+p))():p;else if(i==="script"||!i&&H.indexOf("javascript")>=0)if(p&&n.test(p)){i=x.getElementsByTagName("head")[0]||x.documentElement;y=x.createElement("script");y.type="text/javascript";try{y.appendChild(x.createTextNode(p))}catch($){y.text=p}i.insertBefore(y,i.firstChild);
i.removeChild(y)}return p}};d.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new v.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};d.setup=function(p){if(p)for(var i in p)d.settings[i]=p[i]};if(v.ActiveXObject)d.settings.xhr=function(){if(v.location.protocol!==
"file:")try{return new v.XMLHttpRequest}catch(p){}try{return new v.ActiveXObject("Microsoft.XMLHTTP")}catch(i){}};return d}(),ha=v.JSON?v.JSON:function(){function d(j){return g[j]||"\\u00"+Math.floor(j.charCodeAt()/16).toString(16)+(j.charCodeAt()%16).toString(16)}function h(j){switch(Object.prototype.toString.call(j)){case "[object String]":return'"'+j.replace(/[\x00-\x1f\\"]/g,d)+'"';case "[object Array]":for(var l=[],n=j.length,s=0;s<n;s++)l.push(h(j[s]));return"["+l.join(",")+"]";case "[object Object]":l=
[];for(n in j)(s=h(j[n]))&&l.push(h(n)+":"+s);return"{"+l+"}";case "[object Number]":case "[object Boolean]":return String(j);case false:return"null"}return null}var g={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:h,parse:function(j){j=j.toString();if(!j||!j.length)return null;return(new Function("return "+j))()}}}();Z.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=Z.CLOSED;this._onPolling=this._connecting=false;
this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var d=this;if(d._connecting)return d;d.readyState=Z.CONNECTING;d._connecting=true;d._onPolling||v.setTimeout(function(){d._startPolling()},300);return d},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=Z.OPEN;this.trigger("open","success")},_onClose:function(d){this._setting();this.trigger("close",[d])},_onData:function(d){this.trigger("message",
[d])},_onError:function(d){this._setting();this.trigger("error",[d])},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;O({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(d){var h=this;h._onPolling=false;if(h._connecting)if(d){h._pollingTimes==1&&h._onConnect();h._onData(d);h._failTimes=0;h._pollTimer=v.setTimeout(function(){h._startPolling()},200)}else return h._onError("error data")},
_onPollError:function(d){var h=this;h._onPolling=false;if(h._connecting){h._failTimes++;if(h._pollingTimes==1)h._onError("can not connect.");else if(h._failTimes>1)h._onClose(d);else h._pollTimer=v.setTimeout(function(){h._startPolling()},200)}}};Z.CONNECTING=0;Z.OPEN=1;Z.CLOSED=2;Y.on(Z);J.prototype={readyState:0,send:function(){},close:function(){this.ws.close()}};J.enable=!!v.WebSocket;J.CONNECTING=0;J.OPEN=1;J.CLOSED=2;Y.on(J);Y.on(S);D(S.prototype,{_init:function(){this.data={user:{presence:"offline",
show:"unavailable"}};this.status=new S.status;this.setting=new S.setting;this.buddy=new S.buddy;this.room=new S.room(null,this.data);this.history=new S.history(null,this.data);this._initEvents()},_createConnect:function(){var d=this,h=d.data.connection;d.connection=d.options.connectionType!="jsonpd"&&h.websocket&&J.enable?new J(h.websocket,h):new Z(h.server+(/\?/.test(h)?"&":"?")+O.param({ticket:h.ticket,domain:h.domain}));d.connection.bind("connect",function(){}).bind("message",function(g,j){d.handle(j)}).bind("error",
function(){d._stop("connect","Connect Error")}).bind("close",function(){d._stop("connect","Disconnect")})},setUser:function(d){D(this.data.user,d)},_ready:function(d){var h=this;h._unloadFun=v.onbeforeunload;v.onbeforeunload=function(){h._deactivate()};h.trigger("beforeOnline",[d])},_go:function(){var d=this.data,h=this.history,g=this.buddy,j=this.room;h.options.userInfo=d.user;G(d.buddies,function(n,s){h.init("unicast",s.id,s.history)});g.set(d.buddies);G(d.rooms,function(n,s){h.init("multicast",
s.id,s.history)});g=this.setting.get("blocked_rooms");var l=d.rooms;ja(g)&&l&&G(g,function(n,s){l[s]&&(l[s].blocked=true)});j.set(l);j.options.ticket=d.connection.ticket;this.trigger("online",[d]);this._createConnect();if((d=d.new_messages)&&d.length){G(d,function(n,s){s["new"]=true});this.trigger("message",[d])}},_stop:function(d,h){v.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("offline",[d,h])},autoOnline:function(){return!this.status.get("o")},
_initEvents:function(){function d(l){var n={id:l.from,presence:l.type};if(l.show)n.show=l.show;if(l.nick)n.nick=l.nick;if(l.status)n.status=l.status;return n}var h=this,g=h.history,j=h.buddy;h.bind("message",function(l,n){for(var s=[],z=n.length,K=h.data.user.id,V,da,la,ea=0;ea<z;ea++){V=n[ea];la=V.type;da=la=="unicast"?V.to==K?V.from:V.to:V.to;V.id=da;if(la=="unicast"&&!V["new"]){da={id:da,presence:"online"};if(V.nick)da.nick=V.nick;s.push(da)}}if(s.length){j.presence(s);j.complete()}g.set(n)});
h.bind("presence",function(l,n){j.presence(ua(n,d))})},handle:function(d){d.messages&&d.messages.length&&this.trigger("message",[d.messages]);d.presences&&d.presences.length&&this.trigger("presence",[d.presences]);d.statuses&&d.statuses.length&&this.trigger("status",[d.statuses])},sendMessage:function(d){d.ticket=this.data.connection.ticket;this.trigger("sendMessage",[d]);O({type:"get",dataType:"jsonp",cache:false,url:F("message"),data:d})},sendStatus:function(d){d.ticket=this.data.connection.ticket;
this.trigger("sendStatus",[d]);O({type:"get",dataType:"jsonp",cache:false,url:F("status"),data:d})},sendPresence:function(d){d.ticket=this.data.connection.ticket;this.data.user.show=d.show;this.status.set("s",d.show);this.trigger("sendPresence",[d]);O({type:"get",dataType:"jsonp",cache:false,url:F("presence"),data:d})},online:function(d){var h=this,g=h.status,j=[],l=[],n=g.get("tabs"),s=g.get("tabIds");s&&s.length&&n&&G(n,function(z){z[0]=="b"&&j.push(z.slice(2));z[0]=="r"&&l.push(z.slice(2))});d=
D({buddy_ids:j.join(","),room_ids:l.join(","),show:g.get("s")||"available"},d);h._ready(d);g.set("o",false);g.set("s",d.show);O({type:"get",dataType:"jsonp",cache:false,url:F("online"),data:d,success:function(z){if(z)if(z.success){z.user=D(h.data.user,z.user,{presence:"online"});h.data=z;h._go()}else h._stop("online",z.error_msg);else h._stop("online","Not Found")},error:function(){h._stop("online","Not Found")}})},offline:function(){var d=this.data;this.connection.close();this._stop("offline","offline");
O({type:"get",dataType:"jsonp",cache:false,url:F("offline"),data:{status:"offline",ticket:d.connection.ticket}})},_deactivate:function(){var d=this.data;!d||!d.connection||!d.connection.ticket||O({type:"get",dataType:"jsonp",cache:false,url:F("deactivate"),data:{ticket:d.connection.ticket}})}});v.webim=S;D(S,{version:"1.1.0",defaults:{},log:function(){var d=new Date;["[",d.getHours(),":",d.getMinutes(),":",d.getSeconds(),"-",d.getMilliseconds(),"]"].join("");if(v&&v.console)v.console.log.apply(null,
arguments);else v&&v.runtime&&v.air&&v.air.Introspector&&v.air.Introspector.Console.log.apply(null,arguments)},idsArray:w,now:function(){return(new Date).getTime()},isFunction:oa,isArray:ja,isObject:ta,trim:qa,makeArray:ga,extend:D,each:G,inArray:function(d,h){for(var g=0,j=h.length;g<j;g++)if(h[g]===d)return g;return-1},grep:function(d,h,g){for(var j=[],l=0,n=d.length;l<n;l++)!g!==!h(d[l],l)&&j.push(d[l]);return j},map:ua,JSON:ha,ajax:O,comet:Z,socket:J,model:ka,route:F,ClassEvent:Y});ka("setting",
{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true,blocked_rooms:[]}},{_init:function(){this.data=D({},this.options.data,this.data)},get:function(d){return this.data[d]},set:function(d,h){var g=this,j=d;if(d){if(typeof d=="string"){j={};j[d]=h}var l=g.data,n=na(l,j);if(n){G(n,function(s,z){g.trigger("update",[s,z])});j=D({},l,j);g.data=j;O({type:"get",url:F("setting"),dataType:"jsonp",cache:false,data:{data:ha.stringify(j)}})}}}});ka("status",{key:"_webim"},{_init:function(){var d=
this.data,h=this.options.key;if(d)this._save(d);else this.data=(d=v.localStorage?v.localStorage.getItem(h):E(h))?ha.parse(d):{}},set:function(d,h){var g=d;if(typeof d=="string"){g={};g[d]=h}var j=this.data;na(j,g)&&this._save(D({},j,g))},get:function(d){return this.data[d]},clear:function(){this._save({})},_save:function(d){var h=this.options.key;this.data=d;d=ha.stringify(d);v.localStorage?v.localStorage.setItem(h,d):E(h,d,{path:"/",domain:x.domain})}});ka("buddy",{active:true},{_init:function(){this.data=
this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(d){var h=this.dataHash,g=0,j;for(var l in h)if(ta(d)){j=true;for(var n in d)if(d[n]!=h[l][n])j=false;j&&g++}else g++;return g},get:function(d){return this.dataHash[d]},complete:function(){var d=this.dataHash,h=[],g;for(var j in d){g=d[j];if(g.incomplete&&g.presence=="online"){g.incomplete=false;h.push(j)}}this.load(h)},update:function(d){this.load(d)},presence:function(d){var h=this.dataHash;
d=ja(d)?d:[d];for(var g in d){var j=d[g];j.presence=j.presence=="offline"?"offline":"online";j.incomplete=!h[j.id]}this.set(d)},load:function(d){d=w(d);d.length&&O({type:"get",url:F("buddies"),cache:false,dataType:"jsonp",data:{ids:d.join(",")},context:this,success:this.set})},set:function(d){var h=this.data,g=this.dataHash,j={};d=d||[];var l,n;for(var s in d){l=d[s];if(id=l.id){if(!g[id]){l.presence=l.presence||"online";l.show=l.show?l.show:l.presence=="offline"?"unavailable":"available";g[id]={};
h.push(g[id])}l.incomplete=!!l.incomplete;if(n=na(g[id],l)){l=n.presence||"update";j[l]=j[l]||[];D(g[id],n);j[l].push(g[id])}}}for(var z in j)this.trigger(z,[j[z]]);this.options.active&&this.complete()}});(function(){ka("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(d){return this.dataHash[d]},block:function(d){var h=this.dataHash[d];if(h&&!h.blocked){h.blocked=true;var g=[];G(this.dataHash,function(j,l){l.blocked&&g.push(l.id)});this.trigger("block",[d,g])}},unblock:function(d){var h=
this.dataHash[d];if(h&&h.blocked){h.blocked=false;var g=[];G(this.dataHash,function(j,l){l.blocked&&g.push(l.id)});this.trigger("unblock",[d,g])}},set:function(d){var h=this,g=h.data,j=h.dataHash;G(d,function(l,n){var s=n.id;if(s){n.members=n.members||[];n.count=n.count||0;n.all_count=n.all_count||0;if(j[s])D(j[s],n);else{j[s]=n;g.push(n)}h.trigger("join",[j[s]])}})},addMember:function(d,h){var g=this;if(ja(h))G(h,function(z,K){g.addMember(d,K)});else{var j=g.dataHash[d];if(j){for(var l=j.members,
n,s=l.length;s--;)if(l[s].id==h.id)n=l[s];if(!n){h.nick=h.nick;l.push(h);j.count=l.length;g.trigger("addMember",[d,h])}}}},removeMember:function(d,h){var g=this.dataHash[d];if(g){for(var j=g.members,l,n=j.length;n--;)if(j[n].id==h){l=j[n];j.splice(n,1);g.count--}l&&self.trigger("removeMember",[d,l])}},initMember:function(d){var h=this.dataHash[d];if(h&&!h.initMember){h.initMember=true;this.loadMember(d)}},loadMember:function(d){var h=this,g=h.options;O({type:"get",cache:false,url:F("members"),dataType:"jsonp",
data:{ticket:g.ticket,id:d},success:function(j){h.addMember(d,j)}})},join:function(d){var h=this,g=h.options,j=g.user;O({type:"get",cache:false,url:F("join"),dataType:"jsonp",data:{ticket:g.ticket,id:d,nick:j.nick},success:function(l){h.initMember(d);h.set([l])}})},leave:function(d){var h=this.options,g=this.dataHash[d],j=h.user;if(g){g.initMember=false;O({type:"get",cache:false,url:F("leave"),dataType:"jsonp",data:{ticket:h.ticket,id:d,nick:j.nick}});this.trigger("leave",[g])}},clear:function(){}})})();
ka("history",{},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{}},get:function(d,h){return this.data[d][h]},set:function(d){var h=this.data,g={unicast:{},multicast:{}};d=ga(d);var j=d.length,l,n,s=this.options.userInfo.id;if(j){for(var z=0;z<j;z++){l=d[z];K=l.type;if((n=K=="unicast"?l.to==s?l.from:l.to:l.to)&&K){g[K][n]=g[K][n]||[];g[K][n].push(l)}}for(var K in g)for(n in g[K]){l=g[K][n];if(h[K][n]){h[K][n]=h[K][n].concat(l);
this._triggerMsg(K,n,l)}else this.load(K,n)}}},_triggerMsg:function(d,h,g){this.trigger(d,[h,g])},clear:function(d,h){this.data[d][h]=[];this.trigger("clear",[d,h]);O({url:F("clear"),type:"get",cache:false,dataType:"jsonp",data:{type:d,id:h}})},download:function(d,h){var g=F("download"),j=x.createElement("iframe"),l=new Date,n=[];l={id:h,type:d,time:(new Date).getTime(),date:l.getFullYear()+"-"+(l.getMonth()+1)+"-"+l.getDate()};for(var s in l)n[n.length]=encodeURIComponent(s)+"="+encodeURIComponent(l[s]);
g+=(/\?/.test(g)?"&":"?")+n.join("&");j.setAttribute("src",g);j.style.display="none";x.body.appendChild(j)},init:function(d,h,g){if(ja(g)){this.data[d][h]=g;this._triggerMsg(d,h,g)}},load:function(d,h){var g=this;g.data[d][h]=[];O({url:F("history"),cache:false,type:"get",dataType:"jsonp",data:{type:d,id:h},success:function(j){g.init(d,h,j)}})}})})(window,document);
(function(v,x,ia){function oa(){return false}function ja(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&gt;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function ta(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function qa(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function na(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&c.push(a);return c}function ga(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function D(a,b){if(a)ga(a,b)||(a.className+=" "+b)}function G(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function ua(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function Y(a,b,c){w(a,"mouseover",function(){D(this,b);c&&G(this,c)});w(a,"mouseout",function(){G(this,
b);c&&D(this,c)})}function Z(a,b,c){if(typeof c==="boolean")c?D(a,b):G(a,b);else ga(a,b)?G(a,b):D(a,b)}function J(a){a&&a.style&&(a.style.display="block")}function E(a){a&&a.style&&(a.style.display="none")}function S(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function w(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](v.event)};a.attachEvent("on"+b,a[b+c])}}function ka(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=
true}}function F(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function pa(a){if(!a.target)a.target=a.srcElement||x;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function O(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";a.style.OUserSelect="none";a.style.WebkitUserSelect="none";w(a,"selectstart",oa)}function ha(){if(!U){U=true;if(M){for(var a,b=0;a=M[b++];)a();M=null}}}function d(){if(!xa){xa=true;if(x.readyState==="complete")return ha();
if(x.addEventListener)x.addEventListener("DOMContentLoaded",function(){x.removeEventListener("DOMContentLoaded",arguments.callee,false);ha()},false);else if(x.attachEvent){x.attachEvent("onreadystatechange",function(){if(x.readyState==="complete"){x.detachEvent("onreadystatechange",arguments.callee);ha()}});x.documentElement.doScroll&&v==v.top&&function(){if(!U){try{x.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,0);return}ha()}}()}w(v,"load",ha)}}function h(a){var b=new Date;
b.setTime(a?parseFloat(a)+h.timeSkew:(new Date).getTime());this.date=b}function g(a,b,c){c=p({locale:g.locale},c);c=g.dictionary[c.locale];fa(c)||(c={});a=c[a]===ia?a:c[a];if(b){ya=b;for(var e in b)a=a.replace(/\{\{(.*?)\}\}/g,va)}return a}function j(a,b){this.element=a;this.options=p({},j.defaults,b);this._init()}function l(a){a=a.getElementsByTagName("*");for(var b,c,e={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==0)e[c.substring(1,c.length)]=b}return e}function n(a){var b=x.createElement("div");
b.innerHTML=a;return b=b.firstChild}function s(a,b,c){function e(f,k){this.id=ra++;this.name=a;this.className="webim-"+a;this.options=p({},e.defaults,k);if(this.element=f||this.template&&n(this.template())||this.options.template&&n(N(this.options.template))){this.options.className&&D(this.element,this.options.className);this.$=l(this.element)}la(this._init)&&this._init();la(this._initEvents)&&this._initEvents()}e.defaults=b;$.on(e);p(e.prototype,s.prototype,c);j[a]=e}function z(a,b){j.apps[a]=b||
{}}function K(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+b:a}function V(){x.selection&&(this.caretPos=x.selection.createRange())}var da=webim.idsArray,la=webim.isFunction,ea=webim.isArray,fa=webim.isObject,Aa=webim.trim,B=webim.makeArray,p=webim.extend,i=webim.each,y=webim.grep,H=webim.ajax,Q=webim.model,$=webim.ClassEvent,ca=webim.route,wa=webim.map,U=false,M=[],xa=false;h.timeSkew=0;h.init=function(a){h.timeSkew=(new Date).getTime()-parseFloat(a)};p(h.prototype,{getTime:function(){var a=
this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return g("dt:today");else if(a<864E5)return g("dt:yesterday")}return g("dt:monthdate",{month:g(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});
var L=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=false},init:function(c){p(b,c);c=b.lib+"?_"+(new Date).getTime();c=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+c+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+c+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+
c+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';try{x.getElementById("webim-flashlib-c").innerHTML=c}catch(e){}},play:function(c){c=ta(c)?c:b[c];if(a)try{x.getElementById("webim-flashlib").playSound(c?c:"/sound/sound.mp3")}catch(e){}}}}(),aa=function(){var a=false;w(v,"focus",function(){a=false});w(v,"blur",function(){a=true});var b=x.title,c=0,e=false;return function(f,k){if(a){if(m){clearInterval(m);c=0;e=false}var m=setInterval(function(){c++;e=!e;if(c==k||!a){clearInterval(m);
c=0;e=false}x.title=e?"["+f+"]"+b:b},1500)}}}(),ya={},va=function(a,b){return ya[b]||""};g.locale="zh-CN";g.dictionary={};g.store=function(a,b){var c=g.dictionary;fa(c[a])||(c[a]={});p(c[a],b)};$.on(j);p(j.prototype,{render:function(){var a=this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),b=this.options;this.layout=this.addApp(b.layout||"layout",b.layoutOptions);
a.setting.get("play_sound")?L.enable():L.disable();a.bind("online",function(c,e){h.init(e.server_time)});a.setting.bind("update",function(c,e,f){if("play_sound"==e)f?L.enable():L.disable()})},addApp:function(a,b){var c=j.apps[a];if(c)return la(c)&&c.apply(this,[b])},initSound:function(a){L.init(a||this.options.soundUrls)}});var ma=function(a,b){if(b===ia)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();J(a)}else{a.innerHTML=
"0";E(a)}return b},N=function(){function a(e,f){return b&&b[f]!=ia?b[f]:g(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(e,f){if(!e)return"";b=f;return e.replace(c,a)}}(),W={add:function(a,b,c){a=j[a].prototype;for(var e in c){a.plugins[e]=a.plugins[e]||[];a.plugins[e].push([b,c[e]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var e=0;e<b.length;e++)a.options[b[e][0]]&&b[e][1].apply(a.element,c)}},ra=1;p(s.prototype,{_init:function(){}});p(j,{version:"3.0.1",widget:s,
app:z,plugin:W,i18n:g,date:h,ready:function(a){d();U?a():M.push(a)},createElement:n,defaults:{},apps:{}});webim.ui=j;s("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){return this.$.content.appendChild(a)},subHeader:function(a){this.$.subHeader.innerHTML="";return this.$.subHeader.appendChild(a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&E(c.minimize);!b.maximizable&&E(c.maximize);if(!b.closeable){E(c.tabClose);E(c.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?E(c.tabTitle):
S(c.tabTip);b.count&&this.notifyUser("information",b.count);A(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(ma(c.tabCount,b)){D(c.tab,"ui-state-highlight");G(c.tab,"ui-state-default")}},_count:function(){return ma(this.$.tabCount)},title:function(a,b){var c=this.$,e=c.tabIcon;if(b)if(ta(b)){e.className="webim-icon";e.style.backgroundImage="url("+b+")"}else e.className="webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;e=this.options.titleVisibleLength;if(a){for(var f=
0,k=[],m=a.split(""),o=m.length,r=0;r<o;r++)if(f>=e||f<0)break;else{if(m[r].charCodeAt(0)>255)f+=2;else f++;k.push(m[r])}e=k.join("")}else e=a;(c.tabTitle.innerHTML=e)&&a&&e.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){ua(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return ga(this.element,"webim-window-active")},
activate:function(){if(!this.active()){D(this.element,"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){G(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;ua(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();ma(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!ga(this.element,
"webim-window-normal")){this._setVisibile();this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){ua(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");S(this.element)},_initEvents:function(){var a=this,b=a.$,c=b.tab,e=function(f){ka(f);F(f)};w(c,"click",function(f){a.isMinimize()?a.restore():a.minimize();e(f)});w(c,"mouseover",function(){D(this,"ui-state-hover");
G(this,"ui-state-default")});w(c,"mouseout",function(){G(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&D(this,"ui-state-default")});w(c,"mousedown",e);O(c);i(na(b.actions.firstChild),function(f,k){Y(k,"ui-state-hover")});i(["minimize","maximize","close","tabClose"],function(f,k){w(b[k],"click",function(m){this.disabled||a[k]();e(m)});w(b[k],"mousedown",e)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return ga(this.element,"webim-window-maximize")},
isMinimize:function(){return ga(this.element,"webim-window-minimize")}});var A=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},e=function(){this&&a==this&&(a=false)};w(x,"mousedown",function(f){f=pa(f);for(var k;f;)if(f.id==":webim-window"){k=f;break}else f=f.parentNode;if(k)(f=k.window)&&f.activate();else b()});return function(f){if(f.active()){b();a=f}f.bind("activate",c);f.bind("deactivate",e)}}();z("layout",function(a){function b(){if(f)return q.updateAllChat();
f=true;var t=o.get("tabs"),u=o.get("tabIds"),I=o.get("p"),ba=o.get("a");u&&u.length&&t&&i(t,function(R,T){var P=R.slice(2),X=R.slice(0,1);q.addChat(X,P,{},{isMinimize:true});q.chat(R).window.notifyUser("information",T.n)});I&&(q.prevCount=I)&&q._fitUI();ba&&q.focusChat(ba)}function c(){var t={};i(q.tabs,function(u,I){t[u]={n:I._count()}});o.set({tabs:t,tabIds:q.tabIds,p:q.prevCount,a:q.activeTabId})}a=a||{};var e=this.im,f=false,k=e.buddy,m=e.history,o=e.status,r=e.setting,C=e.room,q=new j.layout(null,
p({chatAutoPop:e.setting.get("msg_auto_pop")},a,{ui:this}));e.setting.get("minimize_layout")?q.collapse():q.expand();e.bind("beforeOnline",function(){q.changeState("ready")}).bind("online",function(t,u){q.changeState("active");q.options.user=u.user;b()}).bind("offline",function(t,u){u=="offline"&&q.removeAllChat();q.updateAllChat();q.changeState("stop")});r.bind("update",function(t,u,I){if("msg_auto_pop"==u)q.options.chatAutoPop=I;else if("minimize_layout"==u)I?q.collapse():q.expand()});k.bind("online",
function(t,u){q.updateChat("buddy",u)}).bind("offline",function(t,u){q.updateChat("buddy",u)}).bind("update",function(t,u){q.updateChat("buddy",u)});C.bind("addMember",function(t,u,I){(t=q.chat("room",u))&&t.addMember(I.id,I.nick,I.id==e.data.user.id)}).bind("removeMember",function(t,u,I){(t=q.chat("room",u))&&t.removeMember(I.id,I.nick)});q.bind("collapse",function(){r.set("minimize_layout",true)});q.bind("expand",function(){r.set("minimize_layout",false)});q.bind("displayUpdate",function(){c()});
e.bind("message",function(t,u){for(var I=false,ba=u.length,R,T=e.data.user.id,P,X,sa=0;sa<ba;sa++){R=u[sa];P=R.id;type=R.type;(X=q.chat(type,P))&&X.status("");if(!X){R.type==="unicast"?q.addChat(type,P,null,null,R.nick):q.addChat(type,P);X=q.chat(type,P)}X&&r.get("msg_auto_pop")&&!q.activeTabId&&q.focusChat(P);X.window.notifyUser("information","+1");P=X.window.pos;P==-1&&q.setNextMsgNum("+1");P==1&&q.setPrevMsgNum("+1");if(R.from!=T)I=true}if(I){L.play("msg");aa(g("new message"),5)}});e.bind("status",
function(t,u){i(u,function(I,ba){var R=e.data.user.id,T=ba.from;if(!(R!=ba.to&&R!=ba.from))(R=q.chat("buddy",T))&&R.status(ba.show)})});m.bind("unicast",function(t,u,I){(t=q.chat("unicast",u))&&t.history.add(I)});m.bind("multicast",function(t,u,I){(t=q.chat("multicast",u))&&t.history.add(I)});m.bind("clear",function(t,u,I){(t=q.chat(u,I))&&t.history.clear()});return q});s("layout",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">\t<div id=":shortcut" class="webim-shortcut">\t</div>\t<div class="webim-layout-r">\t<div id=":panels" class="webim-panels">\t<div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">\t<div id=":next" class="webim-window-tab webim-panels-next ui-state-default">\t<div id=":nextMsgCount" class="webim-window-tab-count">\t0\t</div>\t<em class="ui-icon ui-icon-triangle-1-w"></em>\t<span id=":nextCount">0</span>\t</div>\t</div>\t<div id=":tabsWrap" class="webim-panels-tab-wrap">\t<div id=":tabs" class="webim-panels-tab">\t</div>\t</div>\t<div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">\t<div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">\t<div id=":prevMsgCount" class="webim-window-tab-count">\t0\t</div>\t<span id=":prevCount">0</span>\t<em class="ui-icon ui-icon-triangle-1-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">\t<div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">\t<em class="ui-icon ui-icon-circle-arrow-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-expand-wrap ui-widget">\t<div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">\t<em class="ui-icon ui-icon-circle-arrow-w"></em>\t</div>\t</div>\t</div>\t<div id=":widgets" class="webim-widgets">\t</div>\t</div>\t</div></div>\t</div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">\t<div class="webim-window-tab-tip">\t<strong><%=title%></strong>\t</div>\t<em class="webim-icon" style="background-image:url(<%=icon%>)"></em>\t</a>\t</div>'},{_init:function(a,b){b=this.options;p(this,{window:v,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},tabIds:[],nextCount:0,
prevCount:0});b.unscalable&&D(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((x.compatMode==="CSS1Compat"&&x.documentElement.clientWidth||x.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,e=b.length,
f=this.prevCount;if(!(e<=c)){if(a){for(var k=0,m=0;m<e;m++)if(b[m]==a){k=m;break}if(k<=f)f=k;else if(k>=f+c)f=k-c+1}else f=e-c;this.prevCount=f}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,e=this.tabs,f=this.tabIds,k=f.length,m=0,o=0,r=0;r<k;r++){var C=e[f[r]];if(r<b||r>=c)if(a)J(C.element);else{this.activeTabId==f[r]&&C.minimize();var q=C._count();if(r<b){o+=q;C.pos=1}else{m+=q;C.pos=-1}E(C.element)}else{C.pos=0;J(C.element)}}if(!a){this.setNextMsgNum(m);this.setPrevMsgNum(o)}},
setNextMsgNum:function(a){ma(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){ma(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,e=b.nextCount;if(e>0&&a==-1||c>0&&a==1){b.slideing=true;if(e==1&&a==-1||c==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var f=b.$.tabs,k=parseFloat(f.style.left);c=-1*b.tabWidth*b.nextCount;var m=parseInt(500/13),o=1,r=(c-k)/m,C=setInterval(function(){f.style.left=
k+r*o+"px";if(o==m){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(C)}else o++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,c=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},
_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,e=this.nextCount;if(b<=a)c=e=0;else{e=b-a-c;e=e<0?0:e;c=b-a-e}this.prevCount=c;this.nextCount=e},_updateCountUI:function(){var a=this.$,b=this.prevCount,c=this.nextCount;c<=0?D(a.next,"ui-state-disabled"):G(a.next,"ui-state-disabled");b<=0?D(a.prev,"ui-state-disabled"):G(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display="block";a.prev.style.display="block"}else{E(a.next);E(a.prev)}a.nextCount.innerHTML=
c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;w(a.window,"resize",function(){if(c){c=true;a.buildUI()}});w(b.next,"mousedown",function(){a._slide(-1)});w(b.next,"mouseup",function(){a._slideUp()});O(b.next);w(b.prev,"mousedown",function(){a._slide(1)});w(b.prev,"mouseup",function(){a._slideUp()});O(b.prev);w(b.expand,"click",function(){if(!a.isMinimize())return false;a.expand();a.trigger("expand");return false});w(b.collapse,"click",function(){if(a.isMinimize())return false;
a.collapse();a.trigger("collapse");return false});Y(b.collapse,"ui-state-hover","ui-state-default");Y(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return ga(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||D(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&G(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=
-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&i(this.widgets,function(c,e){e.window!=a&&e.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,e){var f=this;b=p(b,{closeable:false,subHeader:a.header});var k=a.element;b=new j.window(null,b);b.html(k);f.$[e?e:"widgets"].insertBefore(b.element,c&&f.widgets[c]?f.widgets[c].window.element:
null);a.window=b;b.bind("displayStateChange",function(m,o){f._widgetStateChange(this,o)});f.widgets[a.name]=a},focusChat:function(a,b){b=K(a,b);var c=this.tabs[b],e=this.panels[b];c&&c.isMinimize()&&c.restore();e&&e.focus()},chat:function(a,b){return this.panels[K(a,b)]},updateChat:function(a,b){b=B(b);for(var c,e=b.length,f,k=0;k<e;k++){c=b[k];(f=this.panels[K(a,c.id)])&&f.update(c)}},updateAllChat:function(){i(this.panels,function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=y(this.tabIds,
function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{c&&c!=a&&this.tabs[c].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,b,c,e,f){a=a=="b"||a=="buddy"||a=="unicast"?"buddy":"room";var k=
this;if(!k.chat(a,b)){c=k.options.ui.addApp("chat",p({id:b,type:a,nick:f,winOptions:e},c));f=k.panels;b=K(a,b);f[b]=c;a=k.tabs[b]=(new j.window(null,p({isMinimize:k.activeTabId||!k.options.chatAutoPop,tabWidth:k.tabWidth-2,titleVisibleLength:9},e))).bind("close",function(){k._onChatClose(b)}).bind("displayStateChange",function(m,o){k._onChatChange(b,o)});k.tabIds.push(b);k.$.tabs.insertBefore(a.element,k.$.tabs.firstChild);c.setWindow(a);!a.isMinimize()&&k._changeActive(b);k._fitUI()}},removeChat:function(a,
b){var c=this.tabs[K(a,b)];c&&c.close()},removeAllChat:function(){i(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(ea(a))i(a,function(f,k){b.addShortcut(k)});else if(fa(a)){var c=b.$.shortcut,e=b.options.tpl_shortcut;if(!(c.childNodes.length>b.options.shortcutLength+1)){e=n(N(e,{title:g(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));Y(e.firstChild,"ui-state-hover");c.appendChild(e)}}}});s("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},
{_init:function(){W.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=B(a);var b=a.length,c=[];if(b){for(var e=0;e<b;e++)c.push(this._renderMsg(a[e]));this.$.content.innerHTML+=c.join("");this.trigger("update")}},_renderMsg:function(a){a=p({},a);W.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,e=a.timestamp,f=a.body,k=true,m=this._lastLogItem,o=[],r;r=a.nick;if(m&&m.to==c&&m.from==b&&e-m.timestamp<6E4)k=false;
if(k){this._lastLogItem=a;a=new h(e);o.push('<h4><span class="webim-gray">');o.push(a.getDay(true));o.push(" ");o.push(a.getTime());o.push("</span>");o.push(r);o.push('</h4><hr class="webim-line ui-state-default" />')}o.push("<p>");o.push(f);o.push("</p>");return o.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,e=new Date,f=[];c.setTime(a);b&&e.setTime(b.timestamp);if(!b||c.getDate()!=e.getDate()||c.getMonth()!=e.getMonth()){f.push("<h5>");f.push((new h(a)).getDay(true));
f.push("</h5>")}return f.join("")},ui:function(a){return p({element:this.element,$:this.$},a)},plugins:{}});var za=function(){function a(e,f){return'<a href="'+(f=="www."?"http://"+e:e)+'"'+c+">"+e+"</a>"}function b(e,f){c+=" "+e+'="'+f+'"'}var c;return function(e,f){c="";f&&fa(f)&&i(f,b);return e.replace(/(https?:\/\/|www\.)([^\s<]+)/ig,a)}}();j.history.defaults.parseMsg=true;W.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=ja(c);c=za(c,{target:"_blank"});b.msg.body=c}});j.history.defaults.emot=
true;W.add("history","emot",{render:function(a,b){b.msg.body=j.emot.parse(b.msg.body)}});s("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;i(b.firstChild.childNodes,function(c,e){w(e,"click",function(){G(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');i(a,function(c,e){var f=e.src,k=e.t?e.t:
e.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(k);b.push('" alt="');b.push(e.q[0]);b.push('" rel="');b.push(e.q[0]);b.push('" /></li>')});b.push("</ul>");return N(this.options.template,{emots:b.join("")})},toggle:function(){Z(this.element,"webim-emot-show")}});p(j.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",
q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},
{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=p({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var e=a.dir+"/";i(b.emots,function(f,k){if(k&&k.src)k.src=e+k.src;k&&k.q&&i(k.q,function(m,o){c[o]=f})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&i(b,function(e,f){var k=c[f],m=k.src,o=k.t?k.t:k.q[0],r=[];r.push('<img src="');r.push(m);r.push('" title="');r.push(o);r.push('" alt="');r.push(k.q[0]);r.push('" />');e=
ja(e);e=e.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(e,"g"),r.join(""))});return a}});z("chat",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,f=c.room,k=c.history,m=a.id,o=a.type;if(o=="room"){var r=k.get("multicast",m);r||k.load("multicast",m);var C=c.room.get(m)||{id:m,nick:a.nick||m};C.presence="online";a=p({info:C,user:c.data.user},b.options.roomChatOptions,{history:r,block:true,emot:true,clearHistory:false,member:true,type:o,downloadHistory:false},
a);var q=new j.chat(null,a);q.bind("sendMessage",function(t,u){c.sendMessage(u);k.set(u)}).bind("downloadHistory",function(t,u){k.download("multicast",u.id)}).bind("select",function(t,u){u.presence="online";e.presence(u);b.layout.addChat("buddy",u.id,u.nick);b.layout.focusChat("buddy",u.id)}).bind("block",function(t,u){f.block(u.id)}).bind("unblock",function(t,u){f.unblock(u.id)}).bind("destroy",function(){q.options.info.blocked&&f.leave(m)});setTimeout(function(){q.options.info.blocked?f.join(m):
f.initMember(m)},500);ea(C.members)&&i(C.members,function(t,u){q.addMember(u.id,u.nick,u.id==c.data.user.id)})}else{(r=k.get("unicast",m))||k.load("unicast",m);C=c.buddy.get(m)||{id:m,nick:a.nick||m};a=p({info:C,user:c.data.user},b.options.buddyChatOptions,{history:r,block:false,emot:true,clearHistory:true,member:false,msgType:"unicast"},a);q=new j.chat(null,a);c.buddy.get(m)||c.buddy.update(m);q.bind("sendMessage",function(t,u){c.sendMessage(u);k.set(u)}).bind("sendStatus",function(t,u){c.sendStatus(u)}).bind("clearHistory",
function(t,u){k.clear("unicast",u.id)}).bind("downloadHistory",function(t,u){k.download("unicast",u.id)})}return q});s("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t</div></div>',
template:'<div class="webim-chat webim-box webim-flex"> \t<div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div> \t<div id=":content" class="webim-chat-content webim-flex webim-box-h"> \t<div id=":sidebar" class="webim-chat-sidebar webim-box"></div><div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div> \t</div> \t<div id=":actions" class="webim-chat-actions"> \t<div id=":toolContent" class="webim-chat-tool-content"></div>\t<div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>\t<table class="webim-chat-t" cellSpacing="0"> \t<tr> \t<td style="vertical-align:top;"> \t<em class="webim-icon webim-icon-chat-edit"></em>\t</td> \t<td style="vertical-align:top;width:100%;"> \t<div class="webim-chat-input-wrap">\t<textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea> \t</div> \t</td> \t</tr> \t</table> \t</div> \t</div>'},
{_init:function(){var a=this,b=a.element,c=a.options,e=c.window,f=a.history=new j.history(null,{user:c.user,info:c.info});D(b,"webim-chat-"+c.type);a.$.main.insertBefore(f.element,a.$.main.firstChild);a.header=n(N(c.tpl_header));p(a.$,l(a.header));a._initEvents();e&&a.setWindow(e);c.simple&&E(a.header);a.update(c.info);f.add(c.history);W.call(a,"init",[null,a.ui()]);setTimeout(function(){a._adjustContent()},0)},setWindow:function(a){this.window=a;a.subHeader(this.header);a.html(this.element);a.title(this.options.info.nick);
this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(g("buddy offline notice",{name:this.options.info.nick}));else this.notice(g("user offline notice"));W.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;v.setTimeout(function(){a.focus()},0)},_noticeTime:null,_noticeTxt:"",notice:function(a,b){var c=this,e=
c.$.notice,f=c._noticeTime;f&&clearTimeout(f);if(a)if(b){e.innerHTML=a;J(e);setTimeout(function(){if(c._noticeTxt)e.innerHTML=c._noticeTxt;else E(e,500)},b)}else{c._noticeTxt=a;e.innerHTML=a;J(e)}else{c._noticeTxt=null;E(e)}},_adjustContent:function(){var a=this.$.main;a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b,c){if(c!="minimize"){v.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}}).bind("close",
function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},_sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"multicast":"unicast",to:c.id,from:b.user.id,nick:b.user.nick,offline:c.presence!="online",timestamp:(new Date).getTime(),body:a};W.call(this,"send",[null,this.ui({msg:a})]);this.trigger("sendMessage",[a])},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",
true);return true}else{var b=pa(a),c=b.value;if(Aa(c).length){this._sendMessage(c);b.value="";F(a)}}else this._typing()},_onFocusInput:function(a){var b=this;pa(a);(v.getSelection?v.getSelection().toString():x.selection?x.selection.createRange().text:"")||v.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=g("input notice"),e=b.input;a.history.bind("update",function(){a._adjustContent()}).bind("clear",function(){a.notice(g("clear history notice"),3E3)});w(e,"keyup",
function(){V.call(this)});w(e,"click",V);w(e,"select",V);w(e,"focus",function(){G(this,"webim-gray");if(this.value==c)this.value=""});w(e,"blur",function(){if(this.value==""){D(this,"webim-gray");this.value=c}});w(e,"keypress",function(f){a._inputkeypress(f)});w(b.main,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||
a.default_pic_url)b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);b.userStatus.innerHTML=qa(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var e=c.value,f=c.selectionStart,k=c.selectionEnd,m=e.substring(0,f);e=e.substring(k);k=a.length;c.value=m+a+e;c.setSelectionRange(f+k,f+k)}else if(x.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;
else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",[{to:this.options.info.id,show:a}])}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=v.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=a||"clear";var b=this.$.status,c=this.options.info.nick,e="";e=a=="clear"?"":
c+g(a);b.innerHTML=e;this._adjustContent();this._setST&&clearTimeout(this._setST);if(e!="")this._setST=v.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return p({self:this,$:this.$,history:this.history},a)},plugins:{}});j.chat.defaults.emot=true;W.add("chat","emot",{init:function(a,b){var c=b.self,e=new j.emot;e.bind("select",function(k,m){c.focus();c.insert(m,true)});var f=n(N('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));
w(f,"click",function(k){F(k);e.toggle()});b.$.toolContent.appendChild(e.element);b.$.tools.appendChild(f)},send:function(){}});j.chat.defaults.clearHistory=true;W.add("chat","clearHistory",{init:function(a,b){var c=b.self,e=n(N('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));w(e,"click",function(f){F(f);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(e)}});j.chat.defaults.block=true;W.add("chat","block",{init:function(a,
b){var c=b.self,e=c.options.info.blocked,f=c.options.info.nick,k=n('<a href="#chat-block" style="display:'+(e?"none":"")+'" title="'+g("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),m=n('<a href="#chat-block" style="display:'+(e?"":"none")+'" title="'+g("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');w(k,"click",function(o){F(o);E(k);J(m);c.trigger("block",[c.options.info])});w(m,"click",function(o){F(o);E(m);J(k);c.trigger("unblock",
[c.options.info])});b.$.tools.appendChild(k);b.$.tools.appendChild(m)}});j.chat.defaults.member=true;p(j.chat.prototype,{addMember:function(a,b,c){var e=this,f=e.memberLi;if(!f[a]){var k=n('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");w(k.firstChild,"click",function(m){F(m);c||e.trigger("select",[{id:a,nick:b}])});f[a]=k;e.$.member.appendChild(k);e.$.memberCount.innerHTML=parseInt(e.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=this.memberLi[a];if(b){this.$.member.removeChild(b);
delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});W.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var e=n(N('<div class="webim-box webim-flex  webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>(<span id=":memberCount">0</span>)</h4><ul id=":ul" class="webim-flex"></ul></div>')),f=l(e);c.member=f.ul;c.memberCount=
f.memberCount;c.sidebar.appendChild(e)}});j.chat.defaults.downloadHistory=true;W.add("chat","downloadHistory",{init:function(a,b){var c=b.self,e=n(N('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));w(e,"click",function(f){F(f);c.trigger("downloadHistory",[c.options.info])});b.$.tools.appendChild(e)}});z("setting",function(a){var b=this.im.setting,c=this.layout,e=this.setting=new j.setting(null,a);c.addWidget(e,
{title:g("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,k,m){typeof m!="object"&&e.check_tag(k,m)});e.bind("change",function(f,k,m){b.set(k,m)})});s("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},{_init:function(){},
template:function(){var a=this,b=[],c=a.options.data;c&&i(c,function(e,f){f&&typeof f!="boolean"||b.push(a._check_tpl(e,f))});return N(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&i(b,function(e){c[e]&&a._check_event(c[e])})},_check_tpl:function(a,b){return N(this.options.tpl_check,{label:g(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;w(a.firstChild,"click",function(){b._change(this.name,this.checked)})},check_tag:function(a,
b){var c=this;if(fa(a))i(a,function(k,m){c.check_tag(k,m)});else{var e=c.$,f=e[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=b;else{f=e[a]=n(c._check_tpl(a,b));c._check_event(f);e.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});z("user",function(a){a=a||{};var b=this.im,c=new j.user;E(c.element);a.container&&a.container.appendChild(c.element);c.bind("online",function(e,f){b.online(f)}).bind("offline",function(){b.offline()}).bind("presence",
function(e,f){b.sendPresence(f)});c.update(b.data.user);b.bind("online",function(){J(c.element);c.update(b.data.user)}).bind("offline",function(){c.show("unavailable")});return c});s("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;w(b.userShowTrigger,"click",function(e){c.style.display=="block"?E(c):J(c);F(e)});i(na(c.firstChild),function(e,f){w(f,"click",function(k){a._set(this.href.split("#")[1]);E(c);F(k)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=qa(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=g(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});z("login",function(a){a=a||{};var b=this.im,c=new j.login(null,a);a.container&&a.container.appendChild(c.element);c.bind("login",function(e,f){b.online(f)});b.bind("online",function(){c.hide()}).bind("offline",function(e,f,k){f=="online"&&c.showError(k)});return c});s("login",{questions:null,notice:"",template:'<div>  \t\t<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?i(a,function(c,e){var f=x.createElement("option");f.value=e[0];f.innerHTML=e[1];b.question.appendChild(f)}):E(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;Y(b.submit,"ui-state-hover");w(b.form,"submit",function(c){F(c);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){E(this.element)},show:function(){J(this.element)},
hideError:function(){E(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=g(a);J(b)},destroy:function(){}});z("buddy",function(a){a=a||{};var b=this,c=b.im,e=c.buddy,f=b.layout,k=new j.buddy(null,p({title:g("buddy")},a));f.addWidget(k,{className:"webim-buddy-window",title:g("buddy"),titleVisibleLength:19,sticky:c.setting.get("buddy_sticky"),isMinimize:!c.status.get("b"),icon:"buddy"});k.bind("select",function(q,t){b.layout.addChat("buddy",t.id);b.layout.focusChat("buddy",t.id)});
var m;if(!a.disable_user){m=b.addApp("user",a.userOptions);if(a.is_login){k.window.subHeader(m.element);m=null}}!a.is_login&&!a.disable_login&&b.addApp("login",p({container:k.$.content},a.loginOptions));c.setting.bind("update",function(q,t){if(q=="buddy_sticky")k.window.option.sticky=t});k.window&&k.window.bind("displayStateChange",function(q){if(q!="minimize"){e.options.active=true;c.status.set("b",1);e.complete()}else{c.status.set("b",0);e.options.active=false}});var o=function(q){return fa(q)?
q.id:q},r=function(q){return q.show!="invisible"&&q.presence=="online"},C=function(q){return q.show=="invisible"};e.bind("online",function(q,t){k.add(y(t,r))});e.bind("offline",function(q,t){k.remove(wa(t,o))});e.bind("update",function(q,t){k.add(y(t,r));k.update(y(t,r));k.remove(wa(y(t,C),o))});k.offline();c.bind("beforeOnline",function(){k.online()}).bind("online",function(){m&&k.window.subHeader(m.element);k.titleCount()}).bind("offline",function(){k.offline()});return k});s("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},
{_init:function(){var a=this.options;this.groups={};this.li={};this.li_group={};this.size=0;a.disable_group&&D(this.element,"webim-buddy-hidegroup");a.simple&&D(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=g("search buddy");w(c.firstChild,"click",function(){e.focus()});e.value=f;w(e,"focus",function(){D(c,"ui-state-active");if(this.value==f)this.value=""});w(e,"blur",function(){G(c,"ui-state-active");if(this.value=="")this.value=f});w(e,
"keyup",function(){var k=this.value;i(a.li,function(m,o){k&&(o.text||o.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?E(o):J(o)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?E(c):J(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){Z(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},
5E3)},_title:function(a){var b=this.window;b&&b.title(this.options.title+"["+g(a)+"]")},notice:function(a,b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");E(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();E(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a=a.nextSibling;var c=b.show?b.show:"available";a.className=
"webim-icon webim-icon-"+c;a.setAttribute("title",g(c));a=a.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=qa(b.status)||"&nbsp;";return a},showCount:function(a,b){var c=this.li;c[a]&&ma(c[a].firstChild.firstChild,b)},_addOne:function(a,b){var c=this,e=c.li,f=a.id,k=c.$.ul;if(!e[f]){c.size++;if(!a.default_pic_url)a.default_pic_url=
"";a.status=qa(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=g(a.show);a.pic_url=a.pic_url||"";e=e[f]=n(N(c.options.tpl_li,a));w(e.firstChild,"click",function(r){F(r);c.showCount(f,0);c.trigger("select",[a]);this.blur()});var m=c.groups,o=g(a.group||"friend");m=m[o];if(!m){m=n(N(c.options.tpl_group));E(m);if(o==g("stranger"))b=true;b?k.appendChild(m):k.insertBefore(m,k.firstChild);m={name:o,el:m,count:0,title:m.firstChild,li:m.lastChild};c.groups[o]=m}m.count==0&&J(m.el);c.li_group[f]=
m;m.li.appendChild(e);m.count++;m.title.innerHTML=o+"("+m.count+")"}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=B(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=B(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,e=this.li,f,k=this.li_group;a=da(a);for(var m=0;m<a.length;m++){b=
a[m];if(c=e[b]){this.size--;if(f=k[b]){f.count--;f.count==0&&E(f.el);f.title.innerHTML=f.name+"("+f.count+")"}S(c);delete e[b]}}this.titleCount()},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});z("room",function(){function a(o){var r=o.nick;o=p({},o,{group:"group",nick:r+"("+(parseInt(o.count)+"/"+parseInt(o.all_count))+")"});k.updateChat(o);o.blocked&&(o.nick=r+"("+g("blocked")+")");m.li[o.id]?m.update(o):m.add(o)}var b=this,c=b.im,e=c.room,f=c.setting,k=
b.layout,m=b.room=(new webim.ui.room(null)).bind("select",function(o,r){b.layout.addChat("room",r.id);b.layout.focusChat("room",r.id)});k.addWidget(m,{container:"tab",title:g("room"),icon:"room",sticky:c.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true});c.setting.bind("update",function(o,r,C){if(r=="buddy_sticky")m.window.options.sticky=C});e.bind("join",function(o,r){a(r)}).bind("leave",function(){}).bind("block",function(o,r,C){f.set("blocked_rooms",C);a(e.get(r));e.leave(r)}).bind("unblock",
function(o,r,C){f.set("blocked_rooms",C);a(e.get(r));e.join(r)}).bind("addMember",function(o,r){a(e.get(r))}).bind("removeMember",function(o,r){a(e.get(r))})});s("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-room-content webim-flex">\t\t\t\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;J(this.$.empty)},_initEvents:function(){var a=this,b=a.$,c=b.search,e=b.searchInput,f=g("search room");w(c.firstChild,"click",function(){e.focus()});e.value=f;w(e,"focus",function(){D(c,
"ui-state-active");if(this.value==f)this.value=""});w(e,"blur",function(){G(c,"ui-state-active");if(this.value=="")this.value=f});w(e,"keyup",function(){var k=this.value;i(a.li,function(m,o){k&&(o.text||o.innerHTML.replace(/<[^>]*>/g,"")).indexOf(k)==-1?E(o):J(o)})})},scroll:function(a){Z(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",
b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,e=a.id,f=b.$.ul;b.size++;if(!c[e]){if(!a.default_pic_url)a.default_pic_url="";c=c[e]=n(N(b.options.tpl_li,a));w(c.firstChild,"click",function(k){F(k);b.trigger("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=B(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){E(this.$.empty);a=B(a);for(var b=
0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,e=this.li;a=da(a);for(var f=0;f<a.length;f++){b=a[f];if(c=e[b]){S(c);delete e[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){}});z("menu",function(a){var b=this.layout;a=this.menu=new j.menu(null,a);b.addWidget(a,{title:g("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},
null,"shortcut")});s("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&E(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&i(c,function(e,f){b.push(a._li_tpl(f))});return N(a.options.template,
{list:b.join("")})},_li_tpl:function(a){return N(this.options.tpl_li,{title:g(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(ea(a))i(a,function(e,f){b.add(f)});else{var c=b.$;E(c.empty);c.ul.appendChild(n(b._li_tpl(a)))}},destroy:function(){}});z("chatlink",function(a){var b=this,c=b.im,e=b.chatlink=(new webim.ui.chatlink(null,a)).bind("select",function(m,o){b.layout.addChat("buddy",
o);b.layout.focusChat("buddy",o)}),f=function(m){return m.show!="invisible"&&m.presence=="online"},k=function(m){return m.show=="invisible"};c.buddy.bind("online",function(m,o){e.add(y(o,f))}).bind("update",function(m,o){e.add(y(o,f));e.remove(y(o,k))}).bind("offline",function(m,o){e.remove(o)});c.bind("beforeOnline",function(m,o){o.stranger_ids=e.idsArray()}).bind("online",function(){e.remove(c.data.user)}).bind("offline",function(){e.removeAll()})});s("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,
/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,link_class:null,off_link_class:null,link_wrap:null,space_wrap:null},{_init:function(){function a(R,T){if(!R)return false;for(var P=T.length,X=0;X<P;X++){var sa=T[X].exec(R);if(sa&&sa[1])return sa[1]}return false}
var b=this.list={},c=this.options,e=this.anthors={},f=c.link_href,k=c.space_href,m=c.space_id,o=c.off_link_class,r=c.link_class,C=c.space_class,q=c.space_wrap||x;(c=(c.link_wrap||x).getElementsByTagName("a"))&&i(c,function(R,T){var P=a(T.href,f),X=T.innerHTML;if(P&&na(T.firstChild).length==0&&X&&(!T.className||!r||r.test(T.className))&&(!T.className||!o||!o.test(T.className))){e[P]?e[P].push(T):e[P]=[T];b[P]={id:P,name:X}}});if(k=a(v.location.href,k)){b[k]=p(b[k],{id:k});q=q.getElementsByTagName("*");
c=q.length;for(var t,u,I,ba=0;ba<c;ba++){t=q[ba];u=t.className;I=t.id;if(C&&C.test(u)||m&&m.test(I)){t=na(t.firstChild);if(t.length){t=t[t.length-1];e[k]?e[k].push(t):e[k]=[t]}break}}}},_temp:function(a){var b=this;a=n(N('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',a));w(a,"click",function(c){b.trigger("select",this.id);ka(c);F(c)});return a},idsArray:function(){var a=[];i(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,c=this.anthors,
e=a.length,f,k,m,o,r;for(f=0;f<e;f++){k=a[f];if(k.id&&(m=k.uid)&&(o=b[m])){r=c[m];if(!o.elements&&r){o.elements=[];for(var C=0;C<r.length;C++)if(r[C].tagName.toLowerCase()=="li"){o.elements[C]=x.createElement("li");o.elements[C].appendChild(this._temp({id:k.id,title:"",text:g("chat with me")}))}else o.elements[C]=this._temp({id:k.id,title:g("chat with",{name:o.name}),text:""})}r&&i(r,function(q,t){t.parentNode.insertBefore(o.elements[q],t.nextSibling)})}}},remove:function(a){var b=this.list,c=a.length,
e,f,k,m;for(e=0;e<c;e++){f=a[e];if(f.id&&(k=f.uid)&&(m=b[k]))m.elements&&i(m.elements,function(o,r){S(r)})}},removeAll:function(){i(this.list,function(a,b){b.elements&&i(b.elements,function(c,e){S(e)})})}});Q("notification",{url:"webim/notifications"},{_init:function(){this.request=this.options.jsonp?jsonp:H},grep:function(a){return a&&a.text},handle:function(a){a=y(B(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){this.request({url:ca("notifications"),cache:false,dataType:"json",
context:this,success:this.handle})}});z("notification",function(a){var b=this.im,c=this.layout,e=this.notification=new j.notification(null,a),f=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});c.addWidget(e,{title:g("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});f.bind("data",function(k,m){e.window.notifyUser("information","+"+m.length);e.add(m)});setTimeout(function(){f.load()},2E3)});s("notification",{template:'<div id="webim-notification" class="webim-notification">\t<ul id=":ul"><%=list%></ul>\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t</div>',
tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&E(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&i(c,function(e,f){b.push(a._li_tpl(f))});return N(a.options.template,{list:b.join("")})},_li_tpl:function(a){return N(this.options.tpl_li,{text:a.text,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=
this;if(ea(a))i(a,function(e,f){b.add(f)});else{var c=b.$;E(c.empty);c.ul.appendChild(n(b._li_tpl(a)))}},destroy:function(){}})})(window,document);
(function(y,A,pa){function ya(e){return za.call(e)==="[object Function]"}function qa(e){return za.call(e)==="[object Array]"}function Ea(e){return e&&za.call(e)==="[object Object]"}function Aa(e){return(e||"").replace(/^\s+|\s+$/g,"")}function ta(e,g){var j=false;if(Ea(g)){e=e||{};for(var l in g){var o=g[l];if(e[l]!=o){j=j||{};j[l]=o}}}return j}function ka(e){var g=[];if(e!=null){var j=e.length;if(j==null||typeof e==="string"||ya(e)||e.setInterval)g[0]=e;else for(;j;)g[--j]=e[j]}return g}function F(){var e=
arguments[0]||{},g=1,j=arguments.length,l=false,o;if(typeof e==="boolean"){l=e;e=arguments[1]||{};g=2}if(typeof e!=="object"&&!ya(e))e={};for(;g<j;g++)if((o=arguments[g])!=null)for(var v in o){var t=e[v],u=o[v];if(e!==u)if(l&&u&&typeof u==="object"&&!u.nodeType)e[v]=F(l,t||(u.length!=null?[]:{}),u);else if(u!==pa)e[v]=u}return e}function L(e,g,j){var l,o=0,v=e.length,t=v===pa||ya(e);if(j)if(t)for(l in e){if(g.apply(e[l],j)===false)break}else for(;o<v;){if(g.apply(e[o++],j)===false)break}else if(t)for(l in e){if(g.call(e[l],
l,e[l])===false)break}else for(j=e[0];o<v&&g.call(j,o,j)!==false;j=e[++o]);return e}function ra(e,g,j){for(var l=[],o=0,v=e.length;o<v;o++)!j!==!g(e[o],o)&&l.push(e[o]);return l}function ua(e,g){for(var j=[],l,o=0,v=e.length;o<v;o++){l=g(e[o],o);if(l!=null)j[j.length]=l}return j.concat.apply([],j)}function fa(e){this.type=e;this.timeStamp=(new Date).getTime()}function M(e){this.URL=e;this._setting();this._connect()}function B(e,g){var j=this;g=g||{};var l=j.ws=new WebSocket(e);l.onopen=function(){j.trigger("open",
"success");l.send("subscribe "+g.domain+" "+g.ticket)};l.onclose=function(o){j.trigger("close",[o.data])};l.onmessage=function(o){o=o.data;try{o=o?y.JSON&&y.JSON.parse?y.JSON.parse(o):(new Function("return "+o))():o}catch(v){}j.trigger("message",[o])};l.onerror=function(){j.trigger("error",[])}}function la(e,g,j){if(typeof g!="undefined"){j=j||{};if(g===null){g="";j.expires=-1}var l="";if(j.expires&&(typeof j.expires=="number"||j.expires.toUTCString)){if(typeof j.expires=="number"){l=new Date;l.setTime(l.getTime()+
j.expires*24*60*60*1E3)}else l=j.expires;l="; expires="+l.toUTCString()}var o=j.path?"; path="+j.path:"",v=j.domain?"; domain="+j.domain:"";j=j.secure?"; secure":"";A.cookie=[e,"=",encodeURIComponent(g),l,o,v,j].join("")}else{g=null;if(A.cookie&&A.cookie!=""){j=A.cookie.split(";");for(l=0;l<j.length;l++){o=Aa(j[l]);if(o.substring(0,e.length+1)==e+"="){g=decodeURIComponent(o.substring(e.length+1));break}}}return g}}function R(e,g){this.options=F({},R.defaults,g);this._init(e,g)}function z(e){return e&&
e.split?e.split(","):qa(e)?e:parseInt(e)?[parseInt(e)]:[]}function ma(e,g,j){function l(o,v){this.data=o;this.options=F({},l.defaults,v);ya(this._init)&&this._init()}l.defaults=g;fa.on(l);F(l.prototype,j);R[e]=l}function H(e,g){if(typeof e=="string"){e[e]=g;if(g===pa)return H[e]}F(H,e)}var za=Object.prototype.toString;fa.on=function(){for(var e,g=fa.on.prototype,j=0,l=arguments.length;j<l;j++){e=arguments[j].prototype;e.bind=e.addEventListener=g.addEventListener;e.unbind=e.removeEventListener=g.removeEventListener;
e.trigger=e.dispatchEvent=g.dispatchEvent}};fa.on.prototype={addEventListener:function(e,g){var j=this.__listeners=this.__listeners||{};j[e]=j[e]||[];j[e].push(g);return this},dispatchEvent:function(e,g){var j=this.__listeners=this.__listeners||{};e=e.type?e:new fa(e);j=j[e.type];if(Object.prototype.toString.call(g)==="[object Array]")g.unshift(e);else g=[e,g];if(j)for(var l=0,o=j.length;l<o;l++)j[l].apply(this,g);return this},removeEventListener:function(e,g){var j=this.__listeners=this.__listeners||
{};if(j[e])if(g){j=j[e];for(var l=j.length;l--;)j[l]===g&&j.splice(l,1)}else delete j[e];return this}};var W=function(){function e(x){var m={};for(var E in e.settings)m[E]=e.settings[E];if(x)for(E in x)m[E]=x[E];var N,$,aa,C=m.type.toUpperCase(),I=o.test(C),V,X,Ga=y,Y;m.url=m.url.replace(ca,"");m.context=x&&x.context!=null?x.context:m;if(m.data&&m.processData&&typeof m.data!=="string")m.data=g(m.data,m.traditional);var ga=O.exec(m.url);E=y.location;ga=ga&&(ga[1]&&ga[1]!==E.protocol||ga[2]!==E.host);
/https?:/i.test(E.protocol)||(ga=false);ga=m.forceRemote?true:ga;if(m.dataType==="jsonp"&&!ga)m.dataType="json";if(m.dataType==="jsonp"){if(C==="GET")t.test(m.url)||(m.url+=(u.test(m.url)?"&":"?")+(m.jsonp||"callback")+"=?");else if(!m.data||!t.test(m.data))m.data=(m.data?m.data+"&":"")+(m.jsonp||"callback")+"=?";m.dataType="json"}if(m.dataType==="json"&&(m.data&&t.test(m.data)||t.test(m.url))){N=m.jsonpCallback||"jsonp"+j++;if(m.data)m.data=(m.data+"").replace(t,"="+N+"$1");m.url=m.url.replace(t,
"="+N+"$1");m.dataType="script";var Ba=y[N],sa=false;y[N]=function(ia){if(!sa){sa=true;if(Object.prototype.toString.call(Ba)==="[object Function]")Ba(ia);else{y[N]=pa;try{delete y[N]}catch(va){}}aa=ia;K.handleSuccess(m,D,$,aa);K.handleComplete(m,D,$,aa);V&&V.removeChild(Y);X&&X.parentNode&&X.parentNode.removeChild(X)}}}if(m.dataType==="script"&&m.cache===null)m.cache=false;if(m.cache===false&&C==="GET"){var Ca=(new Date).getTime(),Fa=m.url.replace(J,"$1_="+Ca);m.url=Fa+(Fa===m.url?(u.test(m.url)?
"&":"?")+"_="+Ca:"")}if(m.data&&C==="GET")m.url+=(u.test(m.url)?"&":"?")+m.data;m.global&&K.active++;if(m.dataType==="script"&&C==="GET"&&ga){x=false;if(N&&m.async&&!l)if(y._fragmentProxy)V=X=A.createDocumentFragment();else{x=true;if(m.url.slice(0,1)=="/")m.url=E.protocol+"//"+E.host+(E.port?":"+E.port:"")+m.url;else if(!/^https?:\/\//i.test(m.url)){E=E.href;C=/([^?#]+)\//.exec(E);m.url=(C?C[1]:E)+"/"+m.url}m.url=m.url.replace("="+N,"=parent."+N);X=A.createElement("iframe");X.style.position="absolute";
X.style.left="-100px";X.style.top="-100px";X.style.height="1px";X.style.width="1px";X.style.visibility="hidden";A.body.insertBefore(X,A.body.firstChild);Ga=X.contentWindow}var na=function(){var ia=Ga.document;V=V||ia.getElementsByTagName("head")[0]||ia.documentElement;Y=ia.createElement("script");if(m.scriptCharset)Y.charset=m.scriptCharset;Y.src=m.url;if(l)Y.async=m.async;if(N)Y.onload=Y.onerror=Y.onreadystatechange=function(){if(!sa&&(!this.readyState||this.readyState==="loaded"||this.readyState===
"complete")){sa=true;K.handleError(m,D,"error","load error");V&&Y.parentNode&&V.removeChild(Y);X&&X.parentNode&&X.parentNode.removeChild(X)}};else{var va=false;Y.onload=Y.onreadystatechange=function(){if(!va&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){va=true;K.handleSuccess(m,D,$,aa);K.handleComplete(m,D,$,aa);Y.onload=Y.onreadystatechange=null;V&&Y.parentNode&&V.removeChild(Y)}}}V.insertBefore(Y,V.firstChild)};x?setTimeout(function(){na()},0):na();return pa}var wa=
false,D=m.xhr();if(D){m.username?D.open(C,m.url,m.async,m.username,m.password):D.open(C,m.url,m.async);try{if(m.data!=null&&!I||x&&x.contentType)D.setRequestHeader("Content-Type",m.contentType);if(m.ifModified){K.lastModified[m.url]&&D.setRequestHeader("If-Modified-Since",K.lastModified[m.url]);K.etag[m.url]&&D.setRequestHeader("If-None-Match",K.etag[m.url])}ga||D.setRequestHeader("X-Requested-With","XMLHttpRequest");D.setRequestHeader("Accept",m.dataType&&m.accepts[m.dataType]?m.accepts[m.dataType]+
", */*; q=0.01":m.accepts._default)}catch(Ia){}if(m.beforeSend&&m.beforeSend.call(m.context,D,m)===false){m.global&&K.active--;D.abort();return false}m.global&&K.triggerGlobal(m,"ajaxSend",[D,m]);var ja=D.onreadystatechange=function(ia){if(!D||D.readyState===0||ia==="abort"){wa||K.handleComplete(m,D,$,aa);wa=true;if(D)D.onreadystatechange=K.noop}else if(!wa&&D&&(D.readyState===4||ia==="timeout")){wa=true;D.onreadystatechange=K.noop;$=ia==="timeout"?"timeout":!K.httpSuccess(D)?"error":m.ifModified&&
K.httpNotModified(D,m.url)?"notmodified":"success";var va;if($==="success")try{aa=K.httpData(D,m.dataType,m)}catch(a){$="parsererror";va=a}if($==="success"||$==="notmodified")N||K.handleSuccess(m,D,$,aa);else K.handleError(m,D,$,va);N||K.handleComplete(m,D,$,aa);ia==="timeout"&&D.abort();if(m.async)D=null}};try{var S=D.abort;D.abort=function(){D&&S.call&&S.call(D);ja("abort")}}catch(ea){}m.async&&m.timeout>0&&setTimeout(function(){D&&!wa&&ja("timeout")},m.timeout);try{D.send(I||m.data==null?null:
m.data)}catch(Ha){K.handleError(m,D,null,Ha);K.handleComplete(m,D,$,aa)}m.async||ja();return D}}function g(x){var m=[];if(typeof x=="object"){for(var E in x)m[m.length]=encodeURIComponent(E)+"="+encodeURIComponent(x[E]);return m.join("&").replace(P,"+")}return x}var j=(new Date).getTime(),l=typeof A.createElement("script").async==="boolean",o=/^(?:GET|HEAD|DELETE)$/,v=/\S/,t=/\=\?(&|$)/,u=/\?/,J=/([?&])_=[^&]*/,O=/^(\w+:)?\/\/([^\/?#]+)/,P=/%20/g,ca=/#.*$/;y._fragmentProxy=false;var U=A.createDocumentFragment(),
ha=A.createElement("script");try{ha.appendChild(A.createTextNode("window._fragmentProxy = true"))}catch(xa){ha.text="window._fragmentProxy = true"}U.appendChild(ha);U=ha=null;e.param=g;var K={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(x,m,E,N){x.error&&x.error.call(x.context,m,E,N);x.global&&K.triggerGlobal(x,"ajaxError",[m,x,N])},handleSuccess:function(x,m,E,N){x.success&&x.success.call(x.context,N,E,m);x.global&&K.triggerGlobal(x,"ajaxSuccess",[m,x])},handleComplete:function(x,
m,E){x.complete&&x.complete.call(x.context,m,E);x.global&&K.triggerGlobal(x,"ajaxComplete",[m,x]);x.global&&K.active--},triggerGlobal:function(){},httpSuccess:function(x){try{return!x.status&&location.protocol==="file:"||x.status>=200&&x.status<300||x.status===304||x.status===1223}catch(m){}return false},httpNotModified:function(x,m){var E=x.getResponseHeader("Last-Modified"),N=x.getResponseHeader("Etag");if(E)K.lastModified[m]=E;if(N)K.etag[m]=N;return x.status===304},httpData:function(x,m,E){var N=
x.getResponseHeader("content-type")||"",$=m==="xml"||!m&&N.indexOf("xml")>=0;x=$?x.responseXML:x.responseText;$&&x.documentElement.nodeName==="parsererror"&&K.error("parsererror");if(E&&E.dataFilter)x=E.dataFilter(x,m);if(typeof x==="string")if(m==="json"||!m&&N.indexOf("json")>=0)x=x?y.JSON&&y.JSON.parse?y.JSON.parse(x):(new Function("return "+x))():x;else if(m==="script"||!m&&N.indexOf("javascript")>=0)if(x&&v.test(x)){m=A.getElementsByTagName("head")[0]||A.documentElement;E=A.createElement("script");
E.type="text/javascript";try{E.appendChild(A.createTextNode(x))}catch(aa){E.text=x}m.insertBefore(E,m.firstChild);m.removeChild(E)}return x}};e.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new y.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};e.setup=
function(x){if(x)for(var m in x)e.settings[m]=x[m]};if(y.ActiveXObject)e.settings.xhr=function(){if(y.location.protocol!=="file:")try{return new y.XMLHttpRequest}catch(x){}try{return new y.ActiveXObject("Microsoft.XMLHTTP")}catch(m){}};return e}(),oa=y.JSON?y.JSON:function(){function e(l){return j[l]||"\\u00"+Math.floor(l.charCodeAt()/16).toString(16)+(l.charCodeAt()%16).toString(16)}function g(l){switch(Object.prototype.toString.call(l)){case "[object String]":return'"'+l.replace(/[\x00-\x1f\\"]/g,
e)+'"';case "[object Array]":for(var o=[],v=l.length,t=0;t<v;t++)o.push(g(l[t]));return"["+o.join(",")+"]";case "[object Object]":o=[];for(v in l)(t=g(l[v]))&&o.push(g(v)+":"+t);return"{"+o+"}";case "[object Number]":case "[object Boolean]":return String(l);case false:return"null"}return null}var j={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:g,parse:function(l){l=l.toString();if(!l||!l.length)return null;return(new Function("return "+l))()}}}();
M.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=M.CLOSED;this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var e=this;if(e._connecting)return e;e.readyState=M.CONNECTING;e._connecting=true;e._onPolling||y.setTimeout(function(){e._startPolling()},300);return e},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=M.OPEN;this.trigger("open",
"success")},_onClose:function(e){var g=this;g._setting();setTimeout(function(){g.trigger("close",[e])},1E3)},_onData:function(e){this.trigger("message",[e])},_onError:function(e){var g=this;g._setting();setTimeout(function(){g.trigger("error",[e])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;W({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(e){var g=this;g._onPolling=
false;if(g._connecting)if(e){g._pollingTimes==1&&g._onConnect();g._onData(e);g._failTimes=0;g._pollTimer=y.setTimeout(function(){g._startPolling()},200)}else return g._onError("error data")},_onPollError:function(e){var g=this;g._onPolling=false;if(g._connecting){g._failTimes++;if(g._pollingTimes==1)g._onError("can not connect.");else if(g._failTimes>1)g._onClose(e);else g._pollTimer=y.setTimeout(function(){g._startPolling()},200)}}};M.CONNECTING=0;M.OPEN=1;M.CLOSED=2;fa.on(M);B.prototype={readyState:0,
send:function(){},close:function(){this.ws.close()}};B.enable=!!y.WebSocket;B.CONNECTING=0;B.OPEN=1;B.CLOSED=2;fa.on(B);fa.on(R);R.OFFLINE=0;R.BEFOREONLINE=1;R.ONLINE=2;F(R.prototype,{state:R.OFFLINE,_init:function(){this.data={user:{presence:"offline",show:"unavailable"}};this.status=new R.status;this.setting=new R.setting;this.buddy=new R.buddy;this.room=new R.room(null,this.data);this.history=new R.history(null,this.data);this._initEvents()},_createConnect:function(){var e=this,g=e.data.connection;
e.connection=e.options.connectionType!="jsonpd"&&g.websocket&&B.enable?new B(g.websocket,g):new M(g.server+(/\?/.test(g)?"&":"?")+W.param({ticket:g.ticket,domain:g.domain}));e.connection.bind("connect",function(){}).bind("message",function(j,l){e.handle(l)}).bind("error",function(){e._stop("connect","Connect Error")}).bind("close",function(){e._stop("connect","Disconnect")})},setUser:function(e){F(this.data.user,e)},_ready:function(e){var g=this;g.state=R.BEFOREONLINE;g._unloadFun=y.onbeforeunload;
y.onbeforeunload=function(){g._deactivate()};g.trigger("beforeOnline",[e])},_go:function(){var e=this.data,g=this.history,j=this.buddy,l=this.room;this.state=R.ONLINE;g.options.userInfo=e.user;L(e.buddies,function(v,t){g.init("unicast",t.id,t.history)});j.set(e.buddies);L(e.rooms,function(v,t){g.init("multicast",t.id,t.history)});j=this.setting.get("blocked_rooms");var o=e.rooms;qa(j)&&o&&L(j,function(v,t){o[t]&&(o[t].blocked=true)});l.set(o);l.options.ticket=e.connection.ticket;this.trigger("online",
[e]);this._createConnect();if((e=e.new_messages)&&e.length){L(e,function(v,t){t["new"]=true});this.trigger("message",[e])}},_stop:function(e,g){if(this.state!==R.OFFLINE){this.state=R.OFFLINE;y.onbeforeunload=this._unloadFun;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.trigger("offline",[e,g])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function e(u){var J={id:u.from,presence:u.type};if(u.show)J.show=u.show;if(u.nick)J.nick=
u.nick;if(u.status)J.status=u.status;return J}function g(u){return u.type=="online"||u.type=="offline"}function j(u){return u.type=="join"||u.type=="leave"}var l=this,o=l.history,v=l.buddy,t=l.room;l.bind("message",function(u,J){for(var O=[],P=J.length,ca=l.data.user.id,U,ha,xa,K=0;K<P;K++){U=J[K];xa=U.type;ha=xa=="unicast"?U.to==ca?U.from:U.to:U.to;U.id=ha;if(xa=="unicast"&&!U["new"]){ha={id:ha,presence:"online"};if(U.nick&&U.to==ca)ha.nick=U.nick;O.push(ha)}}if(O.length){v.presence(O);v.complete()}o.set(J)});
l.bind("presence",function(u,J){v.presence(ua(ra(J,g),e));J=ra(J,j);for(var O=J.length-1;O>=0;O--){var P=J[O];P.type=="leave"?t.removeMember(P.to||P.status,P.from):t.addMember(P.to||P.status,{id:P.from,nick:P.nick})}})},handle:function(e){if(e.messages&&e.messages.length){for(var g=e.messages,j=[],l=[],o=0;o<g.length;o++){var v=g[o];if(v.body&&v.body.indexOf("webim-event:")==0){v.event=v.body.replace("webim-event:","").split("|,|");l.push(v)}else j.push(v)}j.length&&this.trigger("message",[j]);l.length&&
this.trigger("event",[l])}e.presences&&e.presences.length&&this.trigger("presence",[e.presences]);e.statuses&&e.statuses.length&&this.trigger("status",[e.statuses])},sendMessage:function(e,g){e.ticket=this.data.connection.ticket;this.trigger("sendMessage",[e]);W({type:"get",dataType:"jsonp",cache:false,url:H("message"),data:e,success:g,error:g})},sendStatus:function(e,g){e.ticket=this.data.connection.ticket;this.trigger("sendStatus",[e]);W({type:"get",dataType:"jsonp",cache:false,url:H("status"),
data:e,success:g,error:g})},sendPresence:function(e,g){e.ticket=this.data.connection.ticket;this.data.user.show=e.show;this.status.set("s",e.show);this.trigger("sendPresence",[e]);W({type:"get",dataType:"jsonp",cache:false,url:H("presence"),data:e,success:g,error:g})},online:function(e){var g=this,j=g.status;if(g.state===R.OFFLINE){var l=[],o=[],v=j.get("tabs"),t=j.get("tabIds");t&&t.length&&v&&L(v,function(u){u[0]=="b"&&l.push(u.slice(2));u[0]=="r"&&o.push(u.slice(2))});e=F({buddy_ids:l.join(","),
room_ids:o.join(","),show:j.get("s")||"available"},e);g._ready(e);j.set("o",false);j.set("s",e.show);W({type:"get",dataType:"jsonp",cache:false,url:H("online"),data:e,success:function(u){if(u)if(u.success){u.user=F(g.data.user,u.user,{presence:"online"});g.data=u;g._go()}else g._stop("online",u.error_msg);else g._stop("online","Not Found")},error:function(){g._stop("online","Not Found")}})}},offline:function(){var e=this.data;if(this.state!==R.OFFLINE){this.status.set("o",true);this.connection.close();
this._stop("offline","offline");W({type:"get",dataType:"jsonp",cache:false,url:H("offline"),data:{status:"offline",ticket:e.connection.ticket}})}},_deactivate:function(){var e=this.data;!e||!e.connection||!e.connection.ticket||W({type:"get",dataType:"jsonp",cache:false,url:H("deactivate"),data:{ticket:e.connection.ticket}})}});y.webim=R;F(R,{version:"1.1.0",defaults:{},log:function(){var e=new Date;["[",e.getHours(),":",e.getMinutes(),":",e.getSeconds(),"-",e.getMilliseconds(),"]"].join("");if(y&&
y.console)y.console.log.apply(null,arguments);else y&&y.runtime&&y.air&&y.air.Introspector&&y.air.Introspector.Console.log.apply(null,arguments)},idsArray:z,now:function(){return(new Date).getTime()},isFunction:ya,isArray:qa,isObject:Ea,trim:Aa,makeArray:ka,extend:F,each:L,inArray:function(e,g){for(var j=0,l=g.length;j<l;j++)if(g[j]===e)return j;return-1},grep:ra,map:ua,JSON:oa,ajax:W,comet:M,socket:B,model:ma,route:H,ClassEvent:fa});ma("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,
msg_auto_pop:true,temporary_rooms:[],blocked_rooms:[]}},{_init:function(){this.data=F({},this.options.data,this.data)},get:function(e){return this.data[e]},set:function(e,g){var j=this,l=e;if(e){if(typeof e=="string"){l={};l[e]=g}var o=j.data,v=ta(o,l);if(v){L(v,function(t,u){j.trigger("update",[t,u])});l=F({},o,l);j.data=l;W({type:"get",url:H("setting"),dataType:"jsonp",cache:false,data:{data:oa.stringify(l)}})}}}});ma("status",{key:"_webim"},{_init:function(){var e=this.data,g=this.options.key;
if(e)this._save(e);else this.data=(e=y.localStorage?y.localStorage.getItem(g):la(g))?oa.parse(e):{}},set:function(e,g){var j=e;if(typeof e=="string"){j={};j[e]=g}var l=this.data;ta(l,j)&&this._save(F({},l,j))},get:function(e){return this.data[e]},clear:function(){this._save({})},_save:function(e){var g=this.options.key;this.data=e;e=oa.stringify(e);y.localStorage?y.localStorage.setItem(g,e):la(g,e,{path:"/",domain:A.domain})}});ma("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash=
{};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(e){var g=this.dataHash,j=0,l;for(var o in g)if(Ea(e)){l=true;for(var v in e)if(e[v]!=g[o][v])l=false;l&&j++}else j++;return j},get:function(e){return this.dataHash[e]},all:function(e){return e?ra(this.data,function(g){return g.show!="invisible"&&g.presence=="online"}):this.data},complete:function(){var e=this.dataHash,g=[],j;for(var l in e){j=e[l];if(j.incomplete){j.incomplete=false;g.push(l)}}this.load(g)},update:function(e){this.load(e)},
presence:function(e){var g=this.dataHash;e=qa(e)?e:[e];for(var j in e){var l=e[j];l.presence=l.presence=="offline"?"offline":"online";l.incomplete=!g[l.id]}this.set(e)},load:function(e){e=z(e);e.length&&W({type:"get",url:H("buddies"),cache:false,dataType:"jsonp",data:{ids:e.join(",")},context:this,success:this.set})},set:function(e){var g=this.data,j=this.dataHash,l={};e=e||[];var o,v;for(var t in e){o=e[t];if(id=o.id){if(!j[id]){o.presence=o.presence||"online";o.show=o.show?o.show:o.presence=="offline"?
"unavailable":"available";j[id]={};g.push(j[id])}o.incomplete=!!o.incomplete;if(v=ta(j[id],o)){o=v.presence||"update";l[o]=l[o]||[];F(j[id],v);l[o].push(j[id])}}}for(var u in l)this.trigger(u,[l[u]]);this.options.active&&this.complete()}});(function(){ma("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(e){return this.dataHash[e]},all:function(e){return e?ra(this.data,function(g){return g.temporary}):this.data},block:function(e){var g=this.dataHash[e];if(g&&!g.blocked){g.blocked=
true;var j=[];L(this.dataHash,function(l,o){!o.temporary&&o.blocked&&j.push(o.id)});this.trigger("block",[e,j])}},unblock:function(e){var g=this.dataHash[e];if(g&&g.blocked){g.blocked=false;var j=[];L(this.dataHash,function(l,o){!o.temporary&&o.blocked&&j.push(o.id)});this.trigger("unblock",[e,j])}},set:function(e){var g=this,j=g.data,l=g.dataHash;L(e,function(o,v){var t=v.id;if(t){v.members=v.members||[];v.count=v.count||0;v.all_count=v.all_count||0;if(l[t])F(l[t],v);else{l[t]=v;j.push(v)}g.trigger("join",
[l[t]])}})},addMember:function(e,g){var j=this;if(qa(g))L(g,function(u,J){j.addMember(e,J)});else{var l=j.dataHash[e];if(l){for(var o=l.members,v,t=o.length;t--;)if(o[t].id==g.id)v=o[t];if(!v){g.nick=g.nick;o.push(g);l.count=o.length;j.trigger("addMember",[e,g])}}}},removeMember:function(e,g){var j=this.dataHash[e];if(j){for(var l=j.members,o,v=l.length;v--;)if(l[v].id==g){o=l[v];l.splice(v,1);j.count--}o&&this.trigger("removeMember",[e,o])}},initMember:function(e){var g=this.dataHash[e];if(g&&!g.initMember){g.initMember=
true;this.loadMember(e)}},loadMember:function(e){var g=this,j=g.options;W({type:"get",cache:false,url:H("members"),dataType:"jsonp",data:{ticket:j.ticket,id:e},success:function(l){g.addMember(e,l)}})},join:function(e,g,j){var l=this,o=l.options;W({type:"get",cache:false,url:H("join"),dataType:"jsonp",data:{ticket:o.ticket,id:e,nick:g||""},success:function(v){l.initMember(e);l.set([v]);j&&j(v)}})},leave:function(e){var g=this.options,j=this.dataHash[e],l=g.user;if(j){j.initMember=false;W({type:"get",
cache:false,url:H("leave"),dataType:"jsonp",data:{ticket:g.ticket,id:e,nick:l.nick}});this.trigger("leave",[j])}},clear:function(){}})})();ma("history",{},{_init:function(){this.data=this.data||{};this.data.unicast=this.data.unicast||{};this.data.multicast=this.data.multicast||{}},get:function(e,g){return this.data[e][g]},set:function(e){var g=this.data,j={unicast:{},multicast:{}};e=ka(e);var l=e.length,o,v,t=this.options.userInfo.id;if(l){for(var u=0;u<l;u++){o=e[u];J=o.type;if((v=J=="unicast"?o.to==
t?o.from:o.to:o.to)&&J){j[J][v]=j[J][v]||[];j[J][v].push(o)}}for(var J in j)for(v in j[J]){o=j[J][v];if(g[J][v]){g[J][v]=g[J][v].concat(o);this._triggerMsg(J,v,o)}else this.load(J,v)}}},_triggerMsg:function(e,g,j){this.trigger(e,[g,j])},clear:function(e,g){this.data[e][g]=[];this.trigger("clear",[e,g]);W({url:H("clear"),type:"get",cache:false,dataType:"jsonp",data:{type:e,id:g}})},download:function(e,g){var j=H("download"),l=A.createElement("iframe"),o=new Date,v=[];o={id:g,type:e,time:(new Date).getTime(),
date:o.getFullYear()+"-"+(o.getMonth()+1)+"-"+o.getDate()};for(var t in o)v[v.length]=encodeURIComponent(t)+"="+encodeURIComponent(o[t]);j+=(/\?/.test(j)?"&":"?")+v.join("&");l.setAttribute("src",j);l.style.display="none";A.body.appendChild(l)},init:function(e,g,j){if(qa(j)){this.data[e][g]=j;this._triggerMsg(e,g,j)}},load:function(e,g){var j=this;j.data[e][g]=[];W({url:H("history"),cache:false,type:"get",dataType:"jsonp",data:{type:e,id:g},success:function(l){j.init(e,g,l)}})}})})(window,document);
(function(y,A,pa){function ya(){return false}function qa(a){var b="";if(a.length==0)return"";b=a.replace(/&/g,"&amp;");b=b.replace(/</g,"&lt;");b=b.replace(/>/g,"&gt;");b=b.replace(/    /g,"&nbsp;");b=b.replace(/\'/g,"&#39;");b=b.replace(/\"/g,"&quot;");return b=b.replace(/\n/g,"<br />")}function Ea(a){return/^http:\/\/[A-Za-z0-9]+\.[A-Za-z0-9]+[\/=\?%\-&_~`@[\]\':+!]*([^<>\"])*$/.test(a)}function Aa(a){return a?a.replace(/<(?:.|\s)*?>/g,""):""}function ta(a,b){for(var c=[];a;a=a.nextSibling)a.nodeType==
1&&a!=b&&c.push(a);return c}function ka(a,b){return a&&RegExp("(^|\\s+)"+b+"(\\s+|$)").test(a.className)}function F(a,b){if(a)ka(a,b)||(a.className+=" "+b)}function L(a,b){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," "))}function ra(a,b,c){a&&(a.className=a.className.replace(RegExp("(^|\\s+)("+b.split(/\s+/).join("|")+")(?=(\\s+|$))","g")," ")+" "+c)}function ua(a,b,c){z(a,"mouseover",function(){F(this,b);c&&L(this,c)});z(a,"mouseout",function(){L(this,
b);c&&F(this,c)})}function fa(a,b,c){if(typeof c==="boolean")c?F(a,b):L(a,b);else ka(a,b)?L(a,b):F(a,b)}function M(a){a&&a.style&&(a.style.display="block")}function B(a){a&&a.style&&(a.style.display="none")}function la(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function R(a,b){var c=a.childNodes;for(i=0;i<c.length;i++)a.removeChild(c[i]);typeof b==="string"?a.innerHTML=b:a.appendChild(b)}function z(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+
b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function ma(a){if(a){a.stopPropagation&&a.stopPropagation();a.cancelBubble=true}}function H(a){if(a){a.preventDefault&&a.preventDefault();a.returnValue=false}}function za(a){if(!a.target)a.target=a.srcElement||A;if(a.target.nodeType===3)a.target=a.target.parentNode;return a.target}function W(a){a.setAttribute("unselectable","on");a.style.MozUserSelect="none";a.style.OUserSelect="none";a.style.WebkitUserSelect="none";z(a,"selectstart",ya)}function oa(){if(!sa){sa=
true;if(Ca){for(var a,b=0;a=Ca[b++];)a();Ca=null}}}function e(){if(!Fa){Fa=true;if(A.readyState==="complete")return oa();if(A.addEventListener)A.addEventListener("DOMContentLoaded",function(){A.removeEventListener("DOMContentLoaded",arguments.callee,false);oa()},false);else if(A.attachEvent){A.attachEvent("onreadystatechange",function(){if(A.readyState==="complete"){A.detachEvent("onreadystatechange",arguments.callee);oa()}});A.documentElement.doScroll&&y==y.top&&function(){if(!sa){try{A.documentElement.doScroll("left")}catch(a){setTimeout(arguments.callee,
0);return}oa()}}()}z(y,"load",oa)}}function g(a){var b=new Date;b.setTime(a?parseFloat(a)+g.timeSkew:(new Date).getTime());this.date=b}function j(a,b,c){if(a.addEventListener)a.addEventListener(b,c,false);else{a["e"+b+c]=c;a[b+c]=function(){return a["e"+b+c](y.event)};a.attachEvent("on"+b,a[b+c])}}function l(a){a&&a.parentNode&&a.parentNode.removeChild(a)}function o(a){return a?y.JSON&&y.JSON.parse?y.JSON.parse(a):(new Function("return "+a))():a}function v(a,b){j(a,"submit",function(){function c(){try{var n=
f.contentWindow.name||null;if(n!=null){l(d);b&&b(o(n))}else throw Error("Empty data");}catch(p){l(d);b&&b({error:"Retrieve data error"})}}a.setAttribute("target","_upload_form13123");var d=A.createElement("div");d.innerHTML='<iframe name="_upload_form13123" id="_upload_form13123" style="display:none;" scrolling="no" frameborder="0"></iframe>';var f=d.firstChild;A.body.appendChild(d);if(y.postMessage){var h=function(n){var p=y,r=h;if(p.addEventListener)p.removeEventListener("message",r,false);else{p.detachEvent("onmessage",
p["message"+r]);p["message"+r]=null}l(d);b&&b(o(n.data))};j(y,"message",h)}else{var k=false;j(f,"load",function(){if(k)y.attachEvent||c();else{k=true;f.contentWindow.location="about:blank"}});if(y.attachEvent)f.onreadystatechange=function(){k&&c()}}})}function t(a,b,c){c=C({locale:t.locale},c);c=t.dictionary[c.locale];N(c)||(c={});a=c[a]===pa?a:c[a];if(b){D=b;for(var d in b)a=a.replace(/\{\{(.*?)\}\}/g,Ia)}return a}function u(a,b){this.element=a;this.options=C({},u.defaults,b);this._init()}function J(a){a=
a.getElementsByTagName("*");for(var b,c,d={},f=a.length-1;f>-1;f--){b=a[f];if((c=b.id)&&c.indexOf(":")==0)d[c.substring(1,c.length)]=b}return d}function O(a){var b=A.createElement("div");b.innerHTML=a;return b=b.firstChild}function P(a,b,c){function d(f,h){this.id=Ha++;this.name=a;this.className="webim-"+a;this.options=C({},d.defaults,h);if(this.element=f||this.template&&O(this.template())||this.options.template&&O(S(this.options.template))){this.options.className&&F(this.element,this.options.className);
this.$=J(this.element)}m(this._init)&&this._init();m(this._initEvents)&&this._initEvents()}d.defaults=b;Y.on(d);C(d.prototype,P.prototype,c);u[a]=d}function ca(a,b){u.apps[a]=b||{}}function U(a,b){return b?a=="b"||a=="buddy"||a=="unicast"?"b_"+b:"r_"+b:a}function ha(a){return a=="b"||a=="buddy"||a=="unicast"?"buddy":"room"}function xa(){A.selection&&(this.caretPos=A.selection.createRange())}function K(){return"xx4xyxyxxxyxyyxy".replace(/[xy]/g,function(a){var b=Math.random()*16|0;return(a=="x"?b:
b&3|8).toString(16)})}var x=webim.idsArray,m=webim.isFunction,E=webim.isArray,N=webim.isObject,$=webim.trim,aa=webim.makeArray,C=webim.extend,I=webim.each,V=webim.grep,X=webim.ajax,Ga=webim.model,Y=webim.ClassEvent,ga=webim.route,Ba=webim.map,sa=false,Ca=[],Fa=false;g.timeSkew=0;g.init=function(a){g.timeSkew=(new Date).getTime()-parseFloat(a)};C(g.prototype,{getTime:function(){var a=this.date,b=a.getHours();a=a.getMinutes();if(a<10)a="0"+a;return b+":"+a+""},getDay:function(a){var b=this.date;if(a){a=
new Date;a.setHours(0);a.setMinutes(0);a.setSeconds(0);a.setMilliseconds(0);a=a.getTime()-b.getTime();if(a<=0)return t("dt:today");else if(a<864E5)return t("dt:yesterday")}return t("dt:monthdate",{month:t(["dt:january","dt:february","dt:march","dt:april","dt:may","dt:june","dt:july","dt:august","dt:september","dt:october","dt:november","dt:december"][b.getMonth()]),date:b.getDate()})}});var na=function(){var a=true,b={lib:"sound.swf",msg:"sound/msg.mp3"};return{enable:function(){a=true},disable:function(){a=
false},init:function(c){C(b,c);c=b.lib+"?_"+(new Date).getTime();c=navigator.plugins&&navigator.mimeTypes&&navigator.mimeTypes.length?'<embed type="application/x-shockwave-flash" width="10" height="10" id="webim-flashlib" allowscriptaccess="always" src="'+c+'" />':'<object width="10" height="10" id="webim-flashlib" type="application/x-shockwave-flash" data="'+c+'">\t\t\t\t<param name="allowScriptAccess" value="always" />\t\t\t\t<param name="movie" value="'+c+'" />\t\t\t\t<param name="scale" value="noscale" />\t\t\t\t</object>';
try{A.getElementById("webim-flashlib-c").innerHTML=c}catch(d){}},play:function(c){c=Ea(c)?c:b[c];if(a)try{A.getElementById("webim-flashlib").playSound(c?c:"/sound/sound.mp3")}catch(d){}}}}(),wa=function(){var a=false;z(y,"focus",function(){a=false});z(y,"blur",function(){a=true});var b=A.title,c=0,d=false;return function(f,h){if(a){if(k){clearInterval(k);c=0;d=false}var k=setInterval(function(){c++;d=!d;if(c==h||!a){clearInterval(k);c=0;d=false}A.title=d?"["+f+"]"+b:b},1500)}}}(),D={},Ia=function(a,
b){return D[b]||""};t.locale="zh-CN";t.dictionary={};t.store=function(a,b){var c=t.dictionary;N(c[a])||(c[a]={});C(c[a],b)};Y.on(u);C(u.prototype,{render:function(){var a=this,b=a.layout;a.element.insertBefore(b.element,a.element.firstChild);setTimeout(function(){a.initSound()},1E3);b.buildUI()},_init:function(){var a=this.im=new webim(null,this.options.imOptions),b=this.options;this.layout=this.addApp(b.layout||"layout",b.layoutOptions);a.setting.get("play_sound")?na.enable():na.disable();a.bind("online",
function(c,d){g.init(d.server_time)});a.setting.bind("update",function(c,d,f){if("play_sound"==d)f?na.enable():na.disable()})},addApp:function(a,b){var c=u.apps[a];if(c)return m(c)&&c.apply(this,[b])},initSound:function(a){na.init(a||this.options.soundUrls)}});var ja=function(a,b){if(b===pa)return parseInt(a.innerHTML);else if(b){b=typeof b=="number"?b:parseInt(a.innerHTML)+parseInt(b);a.innerHTML=b.toString();M(a)}else{a.innerHTML="0";B(a)}return b},S=function(){function a(d,f){return b&&b[f]!=pa?
b[f]:t(f)}var b=null,c=/\<\%\=(.*?)\%\>/ig;return function(d,f){if(!d)return"";b=f;return d.replace(c,a)}}(),ea={add:function(a,b,c){a=u[a].prototype;for(var d in c){a.plugins[d]=a.plugins[d]||[];a.plugins[d].push([b,c[d]])}},call:function(a,b,c){if((b=a.plugins[b])&&a.element.parentNode)for(var d=0;d<b.length;d++)a.options[b[d][0]]&&b[d][1].apply(a.element,c)}},Ha=1;C(P.prototype,{_init:function(){}});C(u,{version:"3.0.1",widget:P,app:ca,plugin:ea,i18n:t,date:g,ready:function(a){e();sa?a():Ca.push(a)},
createElement:O,defaults:{},apps:{}});webim.ui=u;P("window",{isMinimize:false,minimizable:true,maximizable:false,closeable:true,sticky:true,titleVisibleLength:12,count:0,template:'<div id=":webim-window" class="webim-window ui-widget">                                            <div class="webim-window-tab-wrap">                                            <div id=":tab" class="webim-window-tab ui-state-default">                                            <div class="webim-window-tab-inner">                                                    <div id=":tabTip" class="webim-window-tab-tip">                                                            <strong id=":tabTipC"><%=tooltip%></strong>                                                    </div>                                                    <a id=":tabClose" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                    <div id=":tabCount" class="webim-window-tab-count">                                                            0                                                    </div>                                                    <em id=":tabIcon" class="webim-icon webim-icon-comments"></em>                                                    <h4 id=":tabTitle"><%=title%></h4>                                            </div>                                            </div>                                            </div>                                            <div><div id=":window" class="webim-window-window">\t\t\t\t\t\t<iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe>                                                    <div id=":header" class="webim-window-header ui-widget-header ui-corner-top">                                                            <span id=":actions" class="webim-window-actions">                                                                    <a id=":minimize" title="<%=minimize%>" class="webim-window-minimize" href="#minimize"><em class="ui-icon ui-icon-minus"><%=minimize%></em></a>                                                                    <a id=":maximize" title="<%=maximize%>" class="webim-window-maximize" href="#maximize"><em class="ui-icon ui-icon-plus"><%=maximize%></em></a>                                                                    <a id=":close" title="<%=close%>" class="webim-window-close" href="#close"><em class="ui-icon ui-icon-close"><%=close%></em></a>                                                            </span>                                                            <h4 id=":headerTitle"><%=title%></h4>                                                            <div id=":subHeader" class="webim-window-subheader"></div>                                                    </div>                                                    <div id=":content" class="webim-window-content ui-widget-content">                                                    </div>                                            </div>                                            </div>                                            </div>'},
{html:function(a){R(this.$.content,a)},subHeader:function(a){R(this.$.subHeader,a)},_init:function(a,b){b=this.options;var c=this.$;a=this.element;a.window=this;b.tabWidth&&(c.tab.style.width=b.tabWidth+"px");b.subHeader&&this.subHeader(b.subHeader);this.title(b.title,b.icon);!b.minimizable&&B(c.minimize);!b.maximizable&&B(c.maximize);if(!b.closeable){B(c.tabClose);B(c.close)}b.isMinimize?this.minimize():this.restore();b.onlyIcon?B(c.tabTitle):la(c.tabTip);b.count&&this.notifyUser("information",b.count);
ia(this)},notifyUser:function(a,b){var c=this.$;if(a=="information")if(this.isMinimize())if(ja(c.tabCount,b)){F(c.tab,"ui-state-highlight");L(c.tab,"ui-state-default")}},_count:function(){return ja(this.$.tabCount)},title:function(a,b){var c=this.$,d=c.tabIcon;if(b)if(Ea(b)){d.className="webim-icon";d.style.backgroundImage="url("+b+")"}else d.className="webim-icon webim-icon-"+b;c.tabTipC.innerHTML=a;d=this.options.titleVisibleLength;if(a){for(var f=0,h=[],k=a.split(""),n=k.length,p=0;p<n;p++)if(f>=
d||f<0)break;else{if(k[p].charCodeAt(0)>255)f+=2;else f++;h.push(k[p])}d=h.join("")}else d=a;(c.tabTitle.innerHTML=d)&&a&&d.length<a.length&&c.tabTitle.setAttribute("title",a);c.headerTitle.innerHTML=a},_changeState:function(a){ra(this.element,"webim-window-normal webim-window-maximize webim-window-minimize","webim-window-"+(a=="restore"?"normal":a));this.trigger("displayStateChange",[a])},active:function(){return ka(this.element,"webim-window-active")},activate:function(){if(!this.active()){F(this.element,
"webim-window-active");this.trigger("activate")}},deactivate:function(){if(this.active()){L(this.element,"webim-window-active");this.options.sticky||this.minimize();this.trigger("deactivate")}},_setVisibile:function(){var a=this.$;ra(a.tab,"ui-state-default ui-state-highlight","ui-state-active");this.activate();ja(a.tabCount,0)},maximize:function(){if(!this.isMaximize()){this._setVisibile();this._changeState("maximize")}},restore:function(){if(!ka(this.element,"webim-window-normal")){this._setVisibile();
this._changeState("restore")}},minimize:function(){if(!this.isMinimize()){ra(this.$.tab,"ui-state-active","ui-state-default");this.deactivate();this._changeState("minimize")}},tabClose:function(){this.close()},close:function(){this.trigger("close");la(this.element)},_initEvents:function(){var a=this,b=a.$,c=b.tab,d=function(f){ma(f);H(f)};z(c,"click",function(f){a.isMinimize()?a.restore():a.minimize();d(f)});z(c,"mouseover",function(){F(this,"ui-state-hover");L(this,"ui-state-default")});z(c,"mouseout",
function(){L(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&F(this,"ui-state-default")});z(c,"mousedown",d);W(c);I(ta(b.actions.firstChild),function(f,h){ua(h,"ui-state-hover")});I(["minimize","maximize","close","tabClose"],function(f,h){z(b[h],"click",function(k){this.disabled||a[h]();d(k)});z(b[h],"mousedown",d)})},height:function(){return this.$.content.offsetHeight},_fitUI:function(){},isMaximize:function(){return ka(this.element,"webim-window-maximize")},isMinimize:function(){return ka(this.element,
"webim-window-minimize")}});var ia=function(){var a=false,b=function(){a&&a.deactivate();a=false;return true},c=function(){this&&this!=a&&b()&&(a=this)},d=function(){this&&a==this&&(a=false)};z(A,"mousedown",function(f){f=za(f);for(var h;f;)if(f.id==":webim-window"){h=f;break}else f=f.parentNode;if(h)(f=h.window)&&f.activate();else b()});return function(f){if(f.active()){b();a=f}f.bind("activate",c);f.bind("deactivate",d)}}();ca("layout",function(a){function b(){if(f)return q.updateAllChat();f=true;
var s=n.get("tabs"),w=n.get("tabIds"),G=n.get("p"),Q=n.get("a");w&&w.length&&s&&I(s,function(T,ba){var Z=T.slice(2),da=T.slice(0,1);q.addChat(da,Z,{},{isMinimize:true});q.chat(T).window.notifyUser("information",ba.n)});G&&(q.prevCount=G)&&q._fitUI();Q&&q.focusChat(Q)}function c(){var s={};I(q.tabs,function(w,G){s[w]={n:G._count()}});n.set({tabs:s,tabIds:q.tabIds,p:q.prevCount,a:q.activeTabId})}a=a||{};var d=this.im,f=false,h=d.buddy,k=d.history,n=d.status,p=d.setting,r=d.room,q=this.layout=new u.layout(null,
C({chatAutoPop:d.setting.get("msg_auto_pop")},a,{ui:this}));d.setting.get("minimize_layout")?q.collapse():q.expand();d.bind("beforeOnline",function(){q.changeState("ready")}).bind("online",function(s,w){q.changeState("active");q.options.user=w.user;b()}).bind("offline",function(s,w){w=="offline"&&q.removeAllChat();q.updateAllChat();q.changeState("stop")});p.bind("update",function(s,w,G){if("msg_auto_pop"==w)q.options.chatAutoPop=G;else if("minimize_layout"==w)G?q.collapse():q.expand()});h.bind("online",
function(s,w){q.updateChat("buddy",w)}).bind("offline",function(s,w){q.updateChat("buddy",w)}).bind("update",function(s,w){q.updateChat("buddy",w)});q.bind("collapse",function(){p.set("minimize_layout",true)});q.bind("expand",function(){p.set("minimize_layout",false)});q.bind("displayUpdate",function(){c()});(function(){r.bind("addMember",function(s,w,G){(s=q.chat("room",w))&&s.addMember(G.id,G.nick,G.id==d.data.user.id)}).bind("removeMember",function(s,w,G){(s=q.chat("room",w))&&s.removeMember(G.id,
G.nick)})})();d.bind("message",function(s,w){for(var G=false,Q=w.length,T,ba=d.data.user.id,Z,da,Da=0;Da<Q;Da++){T=w[Da];Z=T.id;type=T.type;(da=q.chat(type,Z))&&da.status("");if(!da){T.type==="unicast"?q.addChat(type,Z,null,null,T.nick):q.addChat(type,Z);da=q.chat(type,Z)}da&&p.get("msg_auto_pop")&&!q.activeTabId&&q.focusChat(Z);da.window.notifyUser("information","+1");Z=da.window.pos;Z==-1&&q.setNextMsgNum("+1");Z==1&&q.setPrevMsgNum("+1");if(T.from!=ba)G=true}if(G){na.play("msg");wa(t("new message"),
5)}});d.bind("status",function(s,w){I(w,function(G,Q){var T=d.data.user.id,ba=Q.from;if(!(T!=Q.to&&T!=Q.from))(T=q.chat("buddy",ba))&&T.status(Q.show)})});(function(){k.bind("unicast",function(s,w,G){(s=q.chat("unicast",w))&&s.history.add(G)});k.bind("multicast",function(s,w,G){(s=q.chat("multicast",w))&&s.history.add(G)});k.bind("clear",function(s,w,G){(s=q.chat(w,G))&&s.history.clear()})})();return q});P("layout",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout"><iframe class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><div class="webim-layout-bg ui-state-default ui-toolbar"></div><div class="webim-ui ui-helper-clearfix">\t<div id=":shortcut" class="webim-shortcut">\t</div>\t<div class="webim-layout-r">\t<div id=":panels" class="webim-panels">\t<div class="webim-window-tab-wrap ui-widget webim-panels-next-wrap">\t<div id=":next" class="webim-window-tab webim-panels-next ui-state-default">\t<div id=":nextMsgCount" class="webim-window-tab-count">\t0\t</div>\t<em class="ui-icon ui-icon-triangle-1-w"></em>\t<span id=":nextCount">0</span>\t</div>\t</div>\t<div id=":tabsWrap" class="webim-panels-tab-wrap">\t<div id=":tabs" class="webim-panels-tab">\t</div>\t</div>\t<div class="webim-window-tab-wrap ui-widget webim-panels-prev-wrap">\t<div id=":prev" class="webim-window-tab webim-panels-prev ui-state-default">\t<div id=":prevMsgCount" class="webim-window-tab-count">\t0\t</div>\t<span id=":prevCount">0</span>\t<em class="ui-icon ui-icon-triangle-1-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-collapse-wrap ui-widget">\t<div id=":collapse" class="webim-window-tab webim-collapse ui-state-default" title="<%=collapse%>">\t<em class="ui-icon ui-icon-circle-arrow-e"></em>\t</div>\t</div>\t<div class="webim-window-tab-wrap webim-expand-wrap ui-widget">\t<div id=":expand" class="webim-window-tab webim-expand ui-state-default" title="<%=expand%>">\t<em class="ui-icon ui-icon-circle-arrow-w"></em>\t</div>\t</div>\t</div>\t<div id=":widgets" class="webim-widgets">\t</div>\t</div>\t</div></div>\t</div>',
shortcutLength:5,chatAutoPop:true,tpl_shortcut:'<div class="webim-window-tab-wrap ui-widget webim-shortcut-item"><a class="webim-window-tab" href="<%=link%>" target="<%=target%>">\t<div class="webim-window-tab-tip">\t<strong><%=title%></strong>\t</div>\t<em class="webim-icon" style="background-image:url(<%=icon%>)"></em>\t</a>\t</div>',chatApp:"chat"},{_init:function(a,b){b=this.options;C(this,{window:y,widgets:{},panels:{},tabWidth:136,maxVisibleTabs:null,animationTime:210,activeTabId:null,tabs:{},
tabIds:[],nextCount:0,prevCount:0});b.unscalable&&F(this.$.layout,"webim-layout-unscalable");b.isMinimize&&this.collapse()},changeState:function(a){this.element.className="webim webim-state-"+a},_ready:false,buildUI:function(){var a=this.$;this.maxVisibleTabs=parseInt(((A.compatMode==="CSS1Compat"&&A.documentElement.clientWidth||A.body.clientWidth)-45-a.shortcut.offsetWidth-a.widgets.offsetWidth-70)/this.tabWidth);this._fitUI();this._ready=true},_updatePrevCount:function(a){var b=this.tabIds,c=this.maxVisibleTabs,
d=b.length,f=this.prevCount;if(!(d<=c)){if(a){for(var h=0,k=0;k<d;k++)if(b[k]==a){h=k;break}if(h<=f)f=h;else if(h>=f+c)f=h-c+1}else f=d-c;this.prevCount=f}},_setVisibleTabs:function(a){for(var b=this.prevCount,c=b+this.maxVisibleTabs,d=this.tabs,f=this.tabIds,h=f.length,k=0,n=0,p=0;p<h;p++){var r=d[f[p]];if(p<b||p>=c)if(a)M(r.element);else{this.activeTabId==f[p]&&r.minimize();var q=r._count();if(p<b){n+=q;r.pos=1}else{k+=q;r.pos=-1}B(r.element)}else{r.pos=0;M(r.element)}}if(!a){this.setNextMsgNum(k);
this.setPrevMsgNum(n)}},setNextMsgNum:function(a){ja(this.$.nextMsgCount,a)},setPrevMsgNum:function(a){ja(this.$.prevMsgCount,a)},slideing:false,_slide:function(a){var b=this,c=b.prevCount,d=b.nextCount;if(d>0&&a==-1||c>0&&a==1){b.slideing=true;if(d==1&&a==-1||c==1&&a==1)b.slideing=false;b._slideSetup(false);b._setVisibleTabs(true);if(a==-1){b.nextCount--;b.prevCount++}else if(a==1){b.nextCount++;b.prevCount--}var f=b.$.tabs,h=parseFloat(f.style.left);c=-1*b.tabWidth*b.nextCount;var k=parseInt(500/
13),n=1,p=(c-h)/k,r=setInterval(function(){f.style.left=h+p*n+"px";if(n==k){if(b.slideing)b._slide(a);else{b._fitUI();b._slideReset()}clearInterval(r)}else n++},13)}},_slideUp:function(){this.slideing=false},_slideSetup:function(a){var b=this.$,c=b.tabsWrap;b=b.tabs;if(!this._tabsWidth)this._tabsWidth=b.clientWidth;if(a)this._tabsWidth=null;c.style.position=a?"":"relative";c.style.overflow=a?"visible":"hidden";c.style.width=a?"":this._tabsWidth+"px";b.style.width=a?"":this.tabWidth*this.tabIds.length+
"px";b.style.position=a?"":"relative"},_slideReset:function(){this._slideSetup(true)},_updateCount:function(){var a=this.maxVisibleTabs,b=this.tabIds.length,c=this.prevCount,d=this.nextCount;if(b<=a)c=d=0;else{d=b-a-c;d=d<0?0:d;c=b-a-d}this.prevCount=c;this.nextCount=d},_updateCountUI:function(){var a=this.$,b=this.prevCount,c=this.nextCount;c<=0?F(a.next,"ui-state-disabled"):L(a.next,"ui-state-disabled");b<=0?F(a.prev,"ui-state-disabled"):L(a.prev,"ui-state-disabled");if(b>0||c>0){a.next.style.display=
"block";a.prev.style.display="block"}else{B(a.next);B(a.prev)}a.nextCount.innerHTML=c.toString();a.prevCount.innerHTML=b.toString()},_initEvents:function(){var a=this,b=a.$,c=false;z(a.window,"resize",function(){if(c){c=true;a.buildUI()}});z(b.next,"mousedown",function(){a._slide(-1)});z(b.next,"mouseup",function(){a._slideUp()});W(b.next);z(b.prev,"mousedown",function(){a._slide(1)});z(b.prev,"mouseup",function(){a._slideUp()});W(b.prev);z(b.expand,"click",function(){if(!a.isMinimize())return false;
a.expand();a.trigger("expand");return false});z(b.collapse,"click",function(){if(a.isMinimize())return false;a.collapse();a.trigger("collapse");return false});ua(b.collapse,"ui-state-hover","ui-state-default");ua(b.expand,"ui-state-hover","ui-state-default")},isMinimize:function(){return ka(this.$.layout,"webim-layout-minimize")},collapse:function(){this.isMinimize()||F(this.$.layout,"webim-layout-minimize")},expand:function(){this.isMinimize()&&L(this.$.layout,"webim-layout-minimize")},_displayUpdate:function(){this._ready&&
this.trigger("displayUpdate")},_fitUI:function(){this._updateCount();this.$.tabs.style.left=-1*this.tabWidth*this.nextCount+"px";this._updateCountUI();this._setVisibleTabs();this._displayUpdate()},_stickyWin:null,_widgetStateChange:function(a,b){b!="minimize"&&I(this.widgets,function(c,d){d.window!=a&&d.window.minimize()});this._displayUpdate()},widget:function(a){return this.widgets[a]},addWidget:function(a,b,c,d){var f=this;b=C(b,{closeable:false,subHeader:a.header});var h=a.element;b=new u.window(null,
b);b.html(h);f.$[d?d:"widgets"].insertBefore(b.element,c&&f.widgets[c]?f.widgets[c].window.element:null);a.window=b;b.bind("displayStateChange",function(k,n){f._widgetStateChange(this,n)});f.widgets[a.name]=a},focusChat:function(a,b){b=U(a,b);var c=this.tabs[b],d=this.panels[b];c&&c.isMinimize()&&c.restore();d&&d.focus()},chat:function(a,b){return this.panels[U(a,b)]},updateChat:function(a,b){b=aa(b);for(var c,d=b.length,f,h=0;h<d;h++){c=b[h];(f=this.panels[U(a,c.id)])&&f.update(c)}},updateAllChat:function(){I(this.panels,
function(a,b){b.update()})},_onChatClose:function(a){this.tabIds=V(this.tabIds,function(b){return b!=a});delete this.tabs[a];delete this.panels[a];this._changeActive(a,true);this._fitUI()},_onChatChange:function(a,b){if(b=="minimize"){this._changeActive(a,true);this._displayUpdate()}else{this._changeActive(a);this._fitUI()}},_changeActive:function(a,b){var c=this.activeTabId;if(b)c==a&&(this.activeTabId=null);else{c&&c!=a&&this.tabs[c].minimize();this.activeTabId=a;this._updatePrevCount(a)}},addChat:function(a,
b,c,d,f){a=ha(a);var h=this;if(!h.chat(a,b)){var k=h.panels,n=U(a,b);d=h.tabs[n]=(new u.window(null,C({isMinimize:h.activeTabId||!h.options.chatAutoPop,tabWidth:h.tabWidth-2,titleVisibleLength:9},d))).bind("close",function(){h._onChatClose(n)}).bind("displayStateChange",function(p,r){h._onChatChange(n,r)});a=h.options.ui.addApp(h.options.chatApp,C({id:b,type:a,nick:f,window:d},c));k[n]=a;h.tabIds.push(n);h.$.tabs.insertBefore(d.element,h.$.tabs.firstChild);!d.isMinimize()&&h._changeActive(n);h._fitUI()}},
removeChat:function(a,b){var c=this.tabs[U(a,b)];c&&c.close()},removeAllChat:function(){I(this.tabs,function(a,b){b.close()})},addShortcut:function(a){var b=this;if(E(a))I(a,function(f,h){b.addShortcut(h)});else if(N(a)){var c=b.$.shortcut,d=b.options.tpl_shortcut;if(!(c.childNodes.length>b.options.shortcutLength+1)){d=O(S(d,{title:t(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""}));ua(d.firstChild,"ui-state-hover");c.appendChild(d)}}}});P("history",{user:{},info:{},template:'<div class="webim-history">                        <div id=":content" class="webim-history-content">                 </div></div>'},
{_init:function(){ea.call(this,"init",[null,this.ui()])},clear:function(){this.$.content.innerHTML="";this.trigger("clear")},add:function(a){a=aa(a);var b=a.length,c=[];if(b){for(var d=0;d<b;d++)c.push(this._renderMsg(a[d]));this.$.content.innerHTML+=c.join("");this.trigger("update")}},_renderMsg:function(a){a=C({},a);ea.call(this,"render",[null,this.ui({msg:a})]);var b=a.from,c=a.to,d=a.timestamp,f=a.body,h=true,k=this._lastLogItem,n=[],p;p=a.nick;if(k&&k.to==c&&k.from==b&&d-k.timestamp<6E4)h=false;
if(h){this._lastLogItem=a;a=new g(d);n.push('<h4><span class="webim-gray">');n.push(a.getDay(true));n.push(" ");n.push(a.getTime());n.push("</span>");n.push(p);n.push('</h4><hr class="webim-line ui-state-default" />')}n.push("<p>");n.push(f);n.push("</p>");return n.join("")},_renderDateBreak:function(a){var b=this._lastLogItem,c=new Date,d=new Date,f=[];c.setTime(a);b&&d.setTime(b.timestamp);if(!b||c.getDate()!=d.getDate()||c.getMonth()!=d.getMonth()){f.push("<h5>");f.push((new g(a)).getDay(true));
f.push("</h5>")}return f.join("")},ui:function(a){return C({element:this.element,$:this.$},a)},plugins:{}});var va=function(){function a(d,f,h,k,n,p,r,q){if(f)return'<a href="'+(f=="www."?"http://"+d:d)+'"'+c+">"+d+"</a>";if(k)return'<a class="webim-img" href="'+p+'"'+c+'><img src="'+(q||p)+'" alt="'+(n||p)+'"/></a>';return'<a class="webim-file" href="'+p+'"'+c+">"+(n||p)+"</a>"}function b(d,f){c+=" "+d+'="'+f+'"'}var c;return function(d,f){c="";f&&N(f)&&I(f,b);return d.replace(/(https?:\/\/|www\.)([^\s<]+)|(\!?)\[([^\]]*)\]\(([^\)]+)\)(\(([^\)]+)\))?/ig,
a)}}();u.history.defaults.parseMsg=true;ea.add("history","parseMsg",{render:function(a,b){var c=b.msg.body;c=qa(c);c=va(c,{target:"_blank"});b.msg.body=c}});u.history.defaults.emot=true;ea.add("history","emot",{render:function(a,b){b.msg.body=u.emot.parse(b.msg.body)}});P("emot",{template:'<div class="webim-emot ui-widget-content"><%=emots%></div>'},{_init:function(){var a=this,b=a.element;I(b.firstChild.childNodes,function(c,d){z(d,"click",function(){L(b,"webim-emot-show");a.trigger("select",this.firstChild.getAttribute("rel"))})})},
template:function(){var a=this.emots=webim.ui.emot.emots,b=[];b.push('<ul class="ui-helper-clearfix">');I(a,function(c,d){var f=d.src,h=d.t?d.t:d.q[0];b.push('<li><img src="');b.push(f);b.push('" title="');b.push(h);b.push('" alt="');b.push(d.q[0]);b.push('" rel="');b.push(d.q[0]);b.push('" /></li>')});b.push("</ul>");return S(this.options.template,{emots:b.join("")})},toggle:function(){fa(this.element,"webim-emot-show")}});C(u.emot,{emots:[{t:"smile",src:"smile.png",q:[":)"]},{t:"smile_big",src:"smile-big.png",
q:[":d",":-d",":D",":-D"]},{t:"sad",src:"sad.png",q:[":(",":-("]},{t:"wink",src:"wink.png",q:[";)",";-)"]},{t:"tongue",src:"tongue.png",q:[":p",":-p",":P",":-P"]},{t:"shock",src:"shock.png",q:["=-O","=-o"]},{t:"kiss",src:"kiss.png",q:[":-*"]},{t:"glasses_cool",src:"glasses-cool.png",q:["8-)"]},{t:"embarrassed",src:"embarrassed.png",q:[":-["]},{t:"crying",src:"crying.png",q:[":'("]},{t:"thinking",src:"thinking.png",q:[":-/",":-\\"]},{t:"angel",src:"angel.png",q:["O:-)","o:-)"]},{t:"shut_mouth",src:"shut-mouth.png",
q:[":-X",":-x"]},{t:"moneymouth",src:"moneymouth.png",q:[":-$"]},{t:"foot_in_mouth",src:"foot-in-mouth.png",q:[":-!"]},{t:"shout",src:"shout.png",q:[">:o",">:O"]}],init:function(a){var b=webim.ui.emot,c=b._q={};a=C({dir:"webim/static/emot/default"},a);if(a.emots)b.emots=a.emots;var d=a.dir+"/";I(b.emots,function(f,h){if(h&&h.src)h.src=d+h.src;h&&h.q&&I(h.q,function(k,n){c[n]=f})})},parse:function(a){var b=webim.ui.emot._q,c=webim.ui.emot.emots;b&&I(b,function(d,f){var h=c[f],k=h.src,n=h.t?h.t:h.q[0],
p=[];p.push('<img src="');p.push(k);p.push('" title="');p.push(n);p.push('" alt="');p.push(h.q[0]);p.push('" />');d=qa(d);d=d.replace(RegExp("(\\"+".$^*\\[]()|+?{}:<>".split("").join("|\\")+")","g"),"\\$1");a=a.replace(RegExp(d,"g"),p.join(""))});return a}});P("upload",{template:'<div class="webim-upload ui-widget-content"><form class="ui-helper-clearfix" id=":form" method="POST" enctype="multipart/form-data" encoding="multipart/form-data"><input id=":input" type="file" name="files" /><input class="ui-state-default ui-corner-all webim-upload-submit" type="submit" value="<%=upload%>" /></form></div>'},
{_init:function(){var a=this;a.$.form.setAttribute("action",ga("upload"));v(a.$.form,function(b){if(b=b&&b[0])if(!b.url||b.error)alert(b.error||"Upload error");else{var c=["image/jpeg","image/jpg","image/gif","image/png"].indexOf(b.type)==-1?"":"!";c+="["+(b.name||"").replace(/\[|\]/ig,"")+"]("+b.url+")";if(b.thumbnailUrl)c+="("+b.thumbnailUrl+")";try{a.$.input.value=""}catch(d){}a.toggle();a.trigger("upload",c)}else alert("Upload error")})},toggle:function(){fa(this.element,"webim-upload-show")}});
ca("chat",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=c.room,h=c.history,k=a.id,n=a.type;if(n=="room"){var p=h.get("multicast",k);p||h.load("multicast",k);var r=c.room.get(k)||{id:k,nick:a.nick||k};r.presence="online";a=C({emot:true,clearHistory:false,member:true,block:true,downloadHistory:false},b.options.roomChatOptions,{info:r,user:c.data.user,history:p,type:n},a);var q=new u.chat(null,a);q.bind("sendMessage",function(s,w){c.sendMessage(w);h.set(w)}).bind("downloadHistory",function(s,w){h.download("multicast",
w.id)}).bind("select",function(s,w){w.presence="online";d.presence(w);b.layout.addChat("buddy",w.id,w.nick);b.layout.focusChat("buddy",w.id)}).bind("block",function(s,w){f.block(w.id)}).bind("unblock",function(s,w){f.unblock(w.id)}).bind("destroy",function(){q.options.info.blocked&&f.leave(k)});setTimeout(function(){q.options.info.blocked?f.join(k):f.initMember(k)},500);E(r.members)&&I(r.members,function(s,w){q.addMember(w.id,w.nick,w.id==c.data.user.id)})}else{(p=h.get("unicast",k))||h.load("unicast",
k);r=c.buddy.get(k)||{id:k,nick:a.nick||k};a=C({emot:true,clearHistory:true},b.options.buddyChatOptions,{info:r,user:c.data.user,history:p,block:false,member:false,msgType:"unicast"},a);q=new u.chat(null,a);c.buddy.get(k)||c.buddy.update(k);q.bind("sendMessage",function(s,w){c.sendMessage(w);h.set(w)}).bind("sendStatus",function(s,w){c.sendStatus(w)}).bind("clearHistory",function(s,w){h.clear("unicast",w.id)}).bind("downloadHistory",function(s,w){h.download("unicast",w.id)})}return q});P("chat",{tpl_header:'<div><div id=":user" class="webim-user"> \t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" src="" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t<span id=":userStatus" title="" class="webim-user-status">&nbsp;</span> \t</div></div>',
template:'<div id=":container" class="webim-chat webim-box webim-flex"> \t<div class="webim-chat-notice-wrap1"><div class="webim-chat-notice-wrap"><div id=":notice" class="webim-chat-notice ui-state-highlight"></div></div> </div>\t<div id=":content" class="webim-chat-content webim-flex webim-box-h"> \t<div id=":sidebar" class="webim-chat-sidebar webim-box"></div><div class="webim-flex webim-box"><div id=":main" class="webim-chat-main webim-flex"><div id=":status" class="webim-chat-status webim-gray"></div></div></div> \t</div> \t<div id=":actions" class="webim-chat-actions"> \t<div id=":toolContent" class="webim-chat-tool-content"></div>\t<div id=":tools" class="webim-chat-tools ui-helper-clearfix ui-state-default"></div>\t<table class="webim-chat-t" cellSpacing="0"> \t<tr> \t<td style="vertical-align:top;"> \t<em class="webim-icon webim-icon-chat-edit"></em>\t</td> \t<td style="vertical-align:top;width:100%;"> \t<div class="webim-chat-input-wrap">\t<textarea id=":input" class="webim-chat-input webim-gray ui-widget-content"><%=input notice%></textarea> \t</div> \t</td> \t</tr> \t</table> \t</div> \t</div>'},
{_init:function(){var a=this,b=a.element,c=a.options,d=c.window,f=a.history=new u.history(null,{user:c.user,info:c.info});F(b,"webim-chat-"+c.type);a.$.main.insertBefore(f.element,a.$.main.firstChild);a.header=O(S(c.tpl_header));C(a.$,J(a.header));a._initEvents();d&&a.setWindow(d);c.simple&&B(a.header);a.update(c.info);f.add(c.history);ea.call(a,"init",[null,a.ui()]);setTimeout(function(){a._adjustContent()},0)},setWindow:function(a,b){this.window=a;a.subHeader(this.header);!b&&a.html(this.element);
a.title(this.options.info.nick);this._bindWindow()},update:function(a){if(a){this.options.info=a;this.history.options.info=a;this._updateInfo(a)}a=this.options.info.presence=="online";if(this.options.user.presence=="online")a?this.notice(""):this.notice(t("buddy offline notice",{name:this.options.info.nick}));else this.notice(t("user offline notice"));ea.call(this,"update",[null,this.ui()])},focus:function(){var a=this.$.input;y.setTimeout(function(){try{a.focus()}catch(b){}},0)},_noticeTime:null,
_noticeTxt:"",notice:function(a,b){var c=this,d=c.$.notice,f=c._noticeTime;f&&clearTimeout(f);if(a)if(b){d.innerHTML=a;M(d);setTimeout(function(){if(c._noticeTxt)d.innerHTML=c._noticeTxt;else B(d,500)},b)}else{c._noticeTxt=a;d.innerHTML=a;M(d)}else{c._noticeTxt=null;B(d)}},_adjustContent:function(){var a=this.$.main;if(a.scrollTop!=a.scrollHeight)a.scrollTop=a.scrollHeight},_fitUI:function(){this._adjustContent()},_bindWindow:function(){var a=this;a.window.bind("displayStateChange",function(b,c){if(c!=
"minimize"){y.setTimeout(function(){a.$.input.focus()},0);a._adjustContent()}}).bind("close",function(){a.destroy()})},_inputAutoHeight:function(){var a=this.$.input,b=a[0].scrollTop;if(b>0){var c=a.height();c>32&&c<100&&a.height(c+b)}},sendMessage:function(a){var b=this.options,c=b.info;a={type:b.type=="room"?"multicast":"unicast",to:c.id,from:b.user.id,nick:b.user.nick,to_nick:c.nick,offline:c.presence!="online",timestamp:(new Date).getTime()-g.timeSkew,body:a};ea.call(this,"send",[null,this.ui({msg:a})]);
this.trigger("sendMessage",[a])},_inputkeypress:function(a){if(a.keyCode==13)if(a.ctrlKey){this.insert("\n",true);return true}else{var b=za(a),c=b.value;if($(c).length){this.sendMessage(c);b.value="";H(a)}}else this._typing()},_onFocusInput:function(a){var b=this;za(a);(y.getSelection?y.getSelection().toString():A.selection?A.selection.createRange().text:"")||y.setTimeout(function(){b.$.input.focus()},0)},_initEvents:function(){var a=this,b=a.$,c=t("input notice"),d=b.input;a.history.bind("update",
function(){a._adjustContent()}).bind("clear",function(){a.notice(t("clear history notice"),3E3)});z(d,"keyup",function(){xa.call(this)});z(d,"click",xa);z(d,"select",xa);z(d,"focus",function(){L(this,"webim-gray");if(this.value==c)this.value=""});z(d,"blur",function(){if(this.value==""){F(this,"webim-gray");this.value=c}});z(d,"keypress",function(f){a._inputkeypress(f)});z(b.main,"click",function(f){a._onFocusInput(f)})},_updateInfo:function(a){var b=this.$;b.userPic.setAttribute("href",a.url);b.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)try{b.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)}catch(c){}},100);b.userStatus.innerHTML=Aa(a.status)||"&nbsp";this.window&&this.window.title(a.nick,a.show)},insert:function(a,b){var c=this.$.input;c.focus();if(b){a||(a="");if(c.setSelectionRange){var d=c.value,f=c.selectionStart,h=c.selectionEnd,k=d.substring(0,f);d=d.substring(h);h=a.length;c.value=k+a+d;c.setSelectionRange(f+h,
f+h)}else if(A.selection)if(f=c.caretPos){f.text=a;f.collapse();f.select()}else c.value+=a;else c.value+=a}else c.value=a},_statusText:"",sendStatus:function(a){if(!(!a||a==this._statusText||this.options.info.presence=="offline")){this._statusText=a;this.trigger("sendStatus",[{to:this.options.info.id,show:a}])}},_checkST:false,_typing:function(){var a=this;a.sendStatus("typing");a._checkST&&clearTimeout(a._checkST);a._checkST=y.setTimeout(function(){a.sendStatus("clear")},6E3)},_setST:null,status:function(a){a=
a||"clear";var b=this.$.status,c=this.options.info.nick,d="";d=a=="clear"?"":c+t(a);b.innerHTML=d;this._adjustContent();this._setST&&clearTimeout(this._setST);if(d!="")this._setST=y.setTimeout(function(){b.innerHTML=""},1E4)},destroy:function(){this.trigger("destroy")},ui:function(a){return C({self:this,$:this.$,history:this.history},a)},plugins:{}});u.chat.defaults.emot=true;ea.add("chat","emot",{init:function(a,b){var c=b.self,d=c.emot=new u.emot;d.bind("select",function(h,k){c.focus();c.insert(k,
true)});var f=O(S('<a href="#chat-emot" title="<%=emot%>"><em class="webim-icon webim-icon-emot"></em></a>'));z(f,"click",function(h){c.upload&&L(c.upload.element,"webim-upload-show");H(h);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});u.chat.defaults.upload=false;ea.add("chat","upload",{init:function(a,b){var c=b.self,d=c.upload=new u.upload;d.bind("upload",function(h,k){c.sendMessage(k)});var f=O(S('<a href="#chat-upload" title="<%=upload%>"><em class="webim-icon webim-icon-upload"></em></a>'));
z(f,"click",function(h){c.emot&&L(c.emot.element,"webim-emot-show");H(h);d.toggle()});b.$.toolContent.appendChild(d.element);b.$.tools.appendChild(f)},send:function(){}});u.chat.defaults.clearHistory=true;ea.add("chat","clearHistory",{init:function(a,b){var c=b.self,d=O(S('<a href="#chat-clearHistory" title="<%=clear history%>"><em class="webim-icon webim-icon-clear"></em></a>'));z(d,"click",function(f){H(f);c.trigger("clearHistory",[c.options.info])});b.$.tools.appendChild(d)}});u.chat.defaults.block=
true;ea.add("chat","block",{init:function(a,b){var c=b.self,d=c.options.info.blocked,f=c.options.info.nick,h=O('<a href="#chat-block" style="display:'+(d?"none":"")+'" title="'+t("block group",{name:f})+'"><em class="webim-icon webim-icon-unblock"></em></a>'),k=O('<a href="#chat-block" style="display:'+(d?"":"none")+'" title="'+t("unblock group",{name:f})+'"><em class="webim-icon webim-icon-block"></em></a>');z(h,"click",function(n){H(n);B(h);M(k);c.trigger("block",[c.options.info])});z(k,"click",
function(n){H(n);B(k);M(h);c.trigger("unblock",[c.options.info])});b.$.tools.appendChild(h);b.$.tools.appendChild(k)}});u.chat.defaults.member=true;C(u.chat.prototype,{addMember:function(a,b,c){var d=this,f=d.memberLi;if(!f[a]){var h=O('<li><a class="'+(c?"ui-state-disabled":"")+'" href="'+a+'">'+b+"</a></li>");z(h.firstChild,"click",function(k){H(k);c||d.trigger("select",[{id:a,nick:b}])});f[a]=h;d.$.member.appendChild(h);d.$.memberCount.innerHTML=parseInt(d.$.memberCount.innerHTML)+1}},removeMember:function(a){var b=
this.memberLi[a];if(b){this.$.member.removeChild(b);delete this.memberLi[a];this.$.memberCount.innerHTML=parseInt(this.$.memberCount.innerHTML)-1}}});ea.add("chat","member",{init:function(a,b){var c=b.$;b.self.memberLi={};var d=O(S('<div class="webim-box webim-flex  webim-member ui-widget-content ui-corner-left"><iframe id=":bgiframe" class="webim-bgiframe" frameborder="0" tabindex="-1" src="about:blank;" ></iframe><h4><%=room member%>:<span id=":memberCount">0</span></h4><ul id=":ul" class="webim-flex"></ul></div>')),
f=J(d);c.member=f.ul;c.memberCount=f.memberCount;c.sidebar.appendChild(d)}});u.chat.defaults.downloadHistory=true;ea.add("chat","downloadHistory",{init:function(a,b){var c=b.self,d=O(S('<a style="float: right;" href="#chat-downloadHistory" title="<%=download history%>"><em class="webim-icon webim-icon-download"></em></a>'));z(d,"click",function(f){H(f);c.trigger("downloadHistory",[c.options.info])});b.$.tools.appendChild(d)}});ca("setting",function(a){var b=this.im.setting,c=this.layout,d=this.setting=
new u.setting(null,a);c.addWidget(d,{title:t("setting"),icon:"setting",sticky:false,onlyIcon:true,isMinimize:true});b.bind("update",function(f,h,k){typeof k!="object"&&d.check_tag(h,k)});d.bind("change",function(f,h,k){b.set(h,k)})});P("setting",{template:'<div id="webim-setting" class="webim-setting">\t\t\t<ul id=":ul"><%=tags%></ul>\t\t   </div>',tpl_check:'<li id=":<%=name%>"><input type="checkbox" <%=checked%> id="webim-setting-<%=name%>" name="<%=name%>"/><label for="webim-setting-<%=name%>"><%=label%></label></li>'},
{_init:function(){},template:function(){var a=this,b=[],c=a.options.data;c&&I(c,function(d,f){f&&typeof f!="boolean"||b.push(a._check_tpl(d,f))});return S(a.options.template,{tags:b.join("")})},_initEvents:function(){var a=this,b=a.options.data,c=a.$;b&&I(b,function(d){c[d]&&a._check_event(c[d])})},_check_tpl:function(a,b){return S(this.options.tpl_check,{label:t(a),name:a,checked:b?'checked="checked"':""})},_check_event:function(a){var b=this;z(a.firstChild,"click",function(){b._change(this.name,
this.checked)})},check_tag:function(a,b){var c=this;if(N(a))I(a,function(h,k){c.check_tag(h,k)});else{var d=c.$,f=d[a];if(!(b&&typeof b!="boolean"))if(f)f.firstChild.checked=b;else{f=d[a]=O(c._check_tpl(a,b));c._check_event(f);d.ul.appendChild(f)}}},_change:function(a,b){this.trigger("change",[a,b])},destroy:function(){}});ca("user",function(a){a=a||{};var b=this.im,c=new u.user;!a.show&&B(c.element);a.container&&a.container.appendChild(c.element);c.bind("online",function(d,f){b.online(f)}).bind("offline",
function(){b.offline()}).bind("presence",function(d,f){b.sendPresence(f)});c.update(b.data.user);b.bind("online",function(){M(c.element);c.update(b.data.user)}).bind("offline",function(){c.show("unavailable")});return c});P("user",{template:'<div>  \t\t<div id=":user" class="webim-user"> \t\t\t<a id=":userPic" class="webim-user-pic ui-corner-all ui-state-active" href="#id"><img width="50" height="50" defaultsrc="" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" class="ui-corner-all"></a> \t\t\t\t<div class="webim-user-show"><h4><a  id=":userShowTrigger" href="#show"><strong id=":userNick"></strong><span id=":userShow"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></span><em class="ui-icon ui-icon-triangle-1-s"><%=show_status_list%></em></a></h4>\t\t\t\t\t<p id=":userShowList" class="ui-state-active ui-corner-all" style="display: none;">\t\t\t\t\t\t<a href="#available" class="webim-user-show-available"><em class="webim-icon webim-icon-available"><%=available%></em><%=available%></a>\t\t\t\t\t\t<a href="#dnd" class="webim-user-show-dnd"><em class="webim-icon webim-icon-dnd"><%=dnd%></em><%=dnd%></a>\t\t\t\t\t\t<a href="#away" class="webim-user-show-away"><em class="webim-icon webim-icon-away"><%=away%></em><%=away%></a>\t\t\t\t\t\t<a href="#invisible" class="webim-user-show-invisible"><em class="webim-icon webim-icon-invisible"><%=invisible%></em><%=invisible%></a>\t\t\t\t\t\t<a href="#unavailable" class="webim-user-show-unavailable"><em class="webim-icon webim-icon-unavailable"><%=unavailable%></em><%=unavailable%></a>\t\t\t\t\t</p>\t\t\t\t</div> \t\t\t\t\t<span id=":userStatus" title="" class="webim-user-status"></span> \t\t\t\t\t\t</div> \t\t\t\t\t\t\t</div>'},
{_init:function(){},_initEvents:function(){var a=this,b=a.$,c=b.userShowList;z(b.userShowTrigger,"click",function(d){c.style.display=="block"?B(c):M(c);H(d)});I(ta(c.firstChild),function(d,f){z(f,"click",function(h){a._set(this.href.split("#")[1]);B(c);H(h)})})},update:function(a){var b=a.show||"unavailable",c=this.$;this.options.info=a;c.userStatus.innerHTML=Aa(a.status)||"&nbsp;";c.userNick.innerHTML=a.nick||"";c.userPic.setAttribute("href",a.url);c.userPic.firstChild.setAttribute("defaultsrc",
a.default_pic_url?a.default_pic_url:"");setTimeout(function(){if(a.pic_url||a.default_pic_url)c.userPic.firstChild.setAttribute("src",a.pic_url||a.default_pic_url)},100);this.show(b)},show:function(a){var b=t(a);this.$.userShow.innerHTML='<em class="webim-icon webim-icon-'+a+'">'+b+"</em>"+b},_set:function(a){var b=this.options.info;this.show(a);if(b){if(b.show!=a)if(a=="unavailable")this.trigger("offline",[]);else b.show=="unavailable"?this.trigger("online",[{show:a}]):this.trigger("presence",[{show:a,
status:b.status}])}else a!="unavailable"&&this.trigger("online",[{show:a}])},destroy:function(){}});ca("login",function(a){a=a||{};var b=this.im,c=new u.login(null,a);a.container&&a.container.appendChild(c.element);c.bind("login",function(d,f){b.online(f)});b.bind("online",function(){c.hide()}).bind("offline",function(d,f,h){f=="online"&&c.showError(h)});return c});P("login",{questions:null,notice:"",template:'<div id=":login" class="webim-login"> \t\t\t<div class="webim-login-logo" id=":logo"></div>\t\t\t<div class="webim-login-notice" id=":notice"></div>\t\t\t<div class="ui-state-error webim-login-error ui-corner-all" style="display: none;" id=":error"></div>\t\t\t<form id=":form">\t\t\t\t<p class="ui-helper-clearfix"><label for=":username"><%=username%></label><input name="username" id=":username" type="text" /></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":password"><%=password%></label><input name="password" id=":password" type="password" /></p>\t\t\t\t<div id=":more">\t\t\t\t<p class="ui-helper-clearfix"><label for=":question"><%=question%></label><select name="question" id=":question" ></select></p>\t\t\t\t<p class="ui-helper-clearfix"><label for=":answer"><%=answer%></label><input name="answer" id=":answer" type="text" /></p>\t\t\t\t</div>\t\t\t\t<p class="ui-helper-clearfix"><input name="submit" id=":submit" class="ui-state-default ui-corner-all webim-login-submit" value="<%=login%>" type="submit" /></p>\t\t\t</form>\t\t</div>'},
{_init:function(){var a=this.options.questions,b=this.$;a&&a.length?I(a,function(c,d){var f=A.createElement("option");f.value=d[0];f.innerHTML=d[1];b.question.appendChild(f)}):B(b.more);b.notice.innerHTML=this.options.notice},_initEvents:function(){var a=this,b=a.$;ua(b.submit,"ui-state-hover");z(b.form,"submit",function(c){H(c);a.trigger("login",[{username:b.username.value,password:b.password.value,question:b.question.value,answer:b.answer.value}])})},hide:function(){B(this.element)},show:function(){M(this.element)},
hideError:function(){B(this.$.error)},showError:function(a){var b=this.$.error;b.innerHTML=t(a);M(b)},destroy:function(){}});ca("buddy",function(a){a=a||{};var b=this,c=b.im,d=c.buddy,f=b.layout,h=new u.buddy(null,C({title:a.title||t("buddy")},a));f.addWidget(h,{className:"webim-buddy-window",title:a.title||t("buddy"),titleVisibleLength:19,sticky:c.setting.get("buddy_sticky"),isMinimize:!c.status.get("b"),icon:"buddy"});h.bind("select",function(q,s){b.layout.addChat("buddy",s.id);b.layout.focusChat("buddy",
s.id)});var k;if(!a.disable_user){k=b.addApp("user",a.userOptions);if(a.is_login){h.window.subHeader(k.element);M(k.element);k=null}}!a.is_login&&!a.disable_login&&b.addApp("login",C({container:h.$.content},a.loginOptions));c.setting.bind("update",function(q,s){if(q=="buddy_sticky")h.window.option.sticky=s});h.window&&h.window.bind("displayStateChange",function(q,s){if(s!="minimize"){d.options.active=true;c.status.set("b",1);d.complete()}else{c.status.set("b",0);d.options.active=false}});var n=function(q){return N(q)?
q.id:q},p=function(q){return q.show!="invisible"&&q.presence=="online"},r=function(q){return q.show=="invisible"};d.bind("online",function(q,s){h.add(V(s,p))});d.bind("offline",function(q,s){if(a.showUnavailable){h.remove(Ba(s,n));h.add(s)}else h.remove(Ba(s,n))});d.bind("update",function(q,s){h.add(V(s,p));h.update(V(s,p));h.remove(Ba(V(s,r),n))});h.offline();c.bind("beforeOnline",function(){h.online()}).bind("online",function(){k&&h.window.subHeader(k.element);h.titleCount()}).bind("offline",function(){h.offline()});
return h});P("buddy",{template:'<div id="webim-buddy" class="webim-buddy webim-flex webim-box">\t\t<div id=":search" class="webim-buddy-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t\t\t<div class="webim-buddy-content webim-flex" id=":content">\t\t\t\t<div id=":empty" class="webim-buddy-empty"><%=empty buddy%></div>\t\t\t\t\t<ul id=":ul"></ul>\t\t\t\t\t\t</div>\t\t\t\t\t\t\t</div>',tpl_group:'<li><h4><%=title%>(<%=count%>)</h4><hr class="webim-line ui-state-default" /><ul></ul></li>',
tpl_li:'<li title=""><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><em class="webim-icon webim-icon-<%=show%>" title="<%=human_show%>"><%=show%></em><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong><span><%=status%></span></a></li>'},{_init:function(){var a=this.options;this.groups={};this.li={};this.li_group=
{};this.size=0;a.disable_group&&F(this.element,"webim-buddy-hidegroup");a.simple&&F(this.element,"webim-buddy-simple")},_initEvents:function(){var a=this,b=a.$,c=b.search,d=b.searchInput,f=t("search buddy");z(c.firstChild,"click",function(){d.focus()});d.value=f;z(d,"focus",function(){F(c,"ui-state-active");if(this.value==f)this.value=""});z(d,"blur",function(){L(c,"ui-state-active");if(this.value=="")this.value=f});z(d,"keyup",function(){var h=this.value;I(a.li,function(k,n){h&&(n.text||n.innerHTML.replace(/<[^>]*>/g,
"")).indexOf(h)==-1?B(n):M(n)})})},titleCount:function(){var a=this.size,b=this.window,c=this.$.empty;b&&b.title(this.options.title+"("+(a?a:"0")+")");a?B(c):M(c);a>8?this.scroll(true):this.scroll(false)},scroll:function(a){fa(this.element,"webim-buddy-scroll",a)},_time:null,_titleBuddyOnline:function(a){var b=this;a||(a="");b._time&&clearTimeout(b._time);b._time=setTimeout(function(){b.titleCount()},5E3)},_title:function(a){var b=this.window;b&&b.title(this.options.title+"["+t(a)+"]")},notice:function(a,
b){switch(a){case "buddyOnline":this._titleBuddyOnline(b);break;default:this._title(a)}},online:function(){var a=this.$;this.notice("connect");B(a.empty)},offline:function(){var a=this.$;this.scroll(false);this.removeAll();B(a.empty);this.notice("offline")},_updateInfo:function(a,b){a=a.firstChild;a.setAttribute("href",b.url);a=a.firstChild;a=a.nextSibling;var c=b.show?b.show:"available";a.className="webim-icon webim-icon-"+c;a.setAttribute("title",t(c));a=a.nextSibling;a.setAttribute("defaultsrc",
b.default_pic_url?b.default_pic_url:"");if(b.pic_url||b.default_pic_url)a.setAttribute("src",b.pic_url||b.default_pic_url);a=a.nextSibling;a.innerHTML=b.nick;a=a.nextSibling;a.innerHTML=Aa(b.status)||"&nbsp;";return a},showCount:function(a,b){var c=this.li;c[a]&&ja(c[a].firstChild.firstChild,b)},_addOne:function(a,b){var c=this,d=c.li,f=a.id,h=c.$.ul;if(!d[f]){c.size++;if(!a.default_pic_url)a.default_pic_url="";a.status=Aa(a.status)||"&nbsp;";a.show=a.show||"available";a.human_show=t(a.show);a.pic_url=
a.pic_url||"";d=d[f]=O(S(c.options.tpl_li,a));z(d.firstChild,"click",function(p){H(p);c.showCount(f,0);c.trigger("select",[a]);this.blur()});var k=c.groups,n=t(a.group||"friend");k=k[n];if(!k){k=O(S(c.options.tpl_group));B(k);if(n==t("stranger"))b=true;b?h.appendChild(k):h.insertBefore(k,h.firstChild);k={name:n,el:k,count:0,title:k.firstChild,li:k.lastChild};c.groups[n]=k}k.count==0&&M(k.el);c.li_group[f]=k;k.li.appendChild(d);k.count++;k.title.innerHTML=n+"("+k.count+")"}},_updateOne:function(a){var b=
this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=aa(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a,b){a=aa(a);for(var c=0;c<a.length;c++)this._addOne(a[c],b);this.titleCount()},removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a);this.titleCount()},remove:function(a){var b,c,d=this.li,f,h=this.li_group;a=x(a);for(var k=0;k<a.length;k++){b=a[k];if(c=d[b]){this.size--;if(f=h[b]){f.count--;f.count==0&&B(f.el);f.title.innerHTML=f.name+
"("+f.count+")"}la(c);delete d[b]}}this.titleCount()},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},active:function(a){if(this.options.highlightable){this._actived&&L(this._actived.firstChild,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){F(a.firstChild,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}},destroy:function(){}});ca("room",function(a){function b(p,r){var q=p.nick;p=C({},p,{group:"group",nick:q+"("+(parseInt(p.count)+"/"+
parseInt(p.all_count||p.count))+")"});h.updateChat(p);p.blocked&&(p.nick=q+"("+t("blocked")+")");n.li[p.id]?n.update(p):!r&&n.add(p)}var c=this.im,d=c.room,f=c.setting,h=this.layout,k=c.buddy,n=this.room=(new webim.ui.room(null,C(a,{buddy:k,user:c.data.user}))).bind("select",function(p,r){h.addChat("room",r.id);h.focusChat("room",r.id)}).bind("discussion",function(p,r,q){r.id=r.id||K();d.join(r.id,r.nick,function(){h.addChat("room",r.id);h.focusChat("room",r.id)});for(p=0;p<q.length;p++){var s=q[p];
(function(w,G){setTimeout(function(){c.sendMessage(w)},G*500)})({type:"unicast",to:s,from:c.data.user.id,nick:c.data.user.nick,to_nick:k.get(s)&&k.get(s).nick,timestamp:(new Date).getTime(),body:"webim-event:invite|,|"+r.id+"|,|"+r.nick},p)}});c.bind("event",function(p,r){for(var q=0;q<r.length;q++){var s=r[q].event;s&&s[0]=="invite"&&d.join(s[1],s[2],function(){})}});h.addWidget(n,{title:t("room"),icon:"room",sticky:c.setting.get("buddy_sticky"),onlyIcon:true,isMinimize:true});c.setting.bind("update",
function(p,r,q){if(r=="buddy_sticky")n.window.options.sticky=q});d.bind("join",function(p,r){b(r);if(r.temporary){for(var q=[],s=f.get("temporary_rooms")||[],w=false,G=false,Q=0;Q<s.length;Q++){if(s[Q].id==r.id){w=true;G=s[Q].nick!=r.nick;s[Q].nick=r.nick}q.push(s[Q])}w||q.push({id:r.id,nick:r.nick});if(!w||G)f.set("temporary_rooms",q)}}).bind("leave",function(p,r){if(r.temporary){for(var q=[],s=f.get("temporary_rooms")||[],w=false,G=0;G<s.length;G++)if(s[G].id==r.id)w=true;else q.push(s[G]);w&&f.set("temporary_rooms",
q);n.remove(r.id)}}).bind("block",function(p,r,q){p=d.get(r);f.set("blocked_rooms",q);b(p);d.leave(r)}).bind("unblock",function(p,r,q){p=d.get(r);f.set("blocked_rooms",q);b(p);d.join(r,p&&p.nick)}).bind("addMember",function(p,r){b(d.get(r),true)}).bind("removeMember",function(p,r){b(d.get(r),true)})});P("room",{template:'<div id="webim-room" class="webim-room webim-flex webim-box">\t<div id=":list">\t<div id=":search" class="webim-room-search ui-state-default ui-corner-all"><em class="ui-icon ui-icon-search"></em><input id=":searchInput" type="text" value="" /></div>\t<div class="webim-room-content webim-flex">\t<div id=":empty" class="webim-room-empty"><%=empty room%></div>\t<ul id=":ul"></ul>\t</div>\t</div>\t<div id=":discussion" style="display:none;" class="webim-room-discussion">\t<h4><%=discussion%></h4>\t<div><p><%=discussion name%></p><input id=":name" class="webim-room-discussion-name" type="text" /></div>\t<div><p><%=select discussion buddies%></p><ul class="webim-room-discussion-list ui-widget-content" id=":ul2"></ul></div>\t<div><a id=":confirm" href="#" class="webim-button ui-state-default ui-corner-all"><%=confirm%></a><a id=":cancel" href="#" class="webim-button ui-state-default ui-corner-all"><%=cancel%></a></div>\t</div>\t<div id=":actions" class="webim-room-actions"><a id=":create" href="#" class="webim-button ui-state-default ui-corner-all"><%=create discussion%></a></div>\t</div>',
tpl_li:'<li title=""><input class="webim-button ui-state-default ui-corner-all" type="button" value="<%=invite%>" /><a href="<%=url%>" rel="<%=id%>" class="ui-helper-clearfix"><div id=":tabCount" class="webim-window-tab-count">0</div><img width="25" src="<%=pic_url%>" defaultsrc="<%=default_pic_url%>" onerror="var d=this.getAttribute(\'defaultsrc\');if(d && this.src!=d)this.src=d;" /><strong><%=nick%></strong></a></li>'},{_init:function(){this.size=0;this.li={};this._count=0;M(this.$.empty)},_initEvents:function(){var a=
this,b=a.$,c=b.search,d=b.searchInput,f=t("search room");z(c.firstChild,"click",function(){d.focus()});d.value=f;z(d,"focus",function(){F(c,"ui-state-active");if(this.value==f)this.value=""});z(d,"blur",function(){L(c,"ui-state-active");if(this.value=="")this.value=f});z(d,"keyup",function(){var h=this.value;I(a.li,function(k,n){h&&(n.text||n.innerHTML.replace(/<[^>]*>/g,"")).indexOf(h)==-1?B(n):M(n)})});z(b.create,"click",function(h){H(h);a.updateDiscussion()});z(b.confirm,"click",function(h){H(h);
a.confirmDiscussion()});z(b.cancel,"click",function(h){H(h);a.confirmDiscussion(true)})},scroll:function(a){fa(this.element,"webim-room-scroll",a)},_updateInfo:function(a,b){a=a.firstChild.nextSibling;a.setAttribute("href",b.url);a=a.firstChild.nextSibling;a.setAttribute("defaultsrc",b.default_pic_url?b.default_pic_url:"");a.setAttribute("src",b.pic_url);a=a.nextSibling;a.innerHTML=b.nick;return a},_addOne:function(a){var b=this,c=b.li,d=a.id,f=b.$.ul;b.size++;if(!c[d]){if(!a.default_pic_url)a.default_pic_url=
"";c=c[d]=O(S(b.options.tpl_li,a));var h=c.firstChild;a.temporary?z(h,"click",function(k){H(k);b.updateDiscussion(a)}):B(h);z(h.nextSibling,"click",function(k){H(k);b.showCount(d,0);b.trigger("select",[a]);this.blur()});f.appendChild(c)}},_updateOne:function(a){var b=this.li,c=a.id;b[c]&&this._updateInfo(b[c],a)},update:function(a){a=aa(a);for(var b=0;b<a.length;b++)this._updateOne(a[b])},add:function(a){B(this.$.empty);a=aa(a);for(var b=0;b<a.length;b++)this._addOne(a[b]);this.size>8&&this.scroll(true)},
removeAll:function(){var a=[],b=this.li;for(var c in b)a.push(c);this.remove(a)},remove:function(a){var b,c,d=this.li;a=x(a);for(var f=0;f<a.length;f++){b=a[f];if(c=d[b]){la(c);delete d[b]}}},select:function(a){(a=this.li[a])&&a.firstChild.click();return a},destroy:function(){},confirmDiscussion:function(a){var b=this.$;B(b.discussion);M(b.list);M(b.actions);if(!a){a=this._discussion||{};a.temporary=true;a.nick=b.name.value||t("discussion");b=b.ul2.getElementsByTagName("input");for(var c=[],d=0;d<
b.length;d++){var f=b[d];f.checked&&c.push(f.value)}this.trigger("discussion",[a,c])}},updateDiscussion:function(a){var b=[],c=this.options.buddy.all(true);this._discussion=a;var d=this.$;d.name.value=a&&a.nick.replace(/\([^\)]*\)/ig,"")||this.options.user.nick+"\u7684\u8ba8\u8bba\u7ec4";for(a=0;a<c.length;a++){var f=c[a];b.push('<li><label for="webim-discussion-'+f.id+'"><input id="webim-discussion-'+f.id+'" type="checkbox" name="buddy" value="'+f.id+'" />'+f.nick+"</label></li>")}d.ul2.innerHTML=
b.join("");M(d.discussion);B(d.list);B(d.actions)},showCount:function(a,b){var c=this.li;c[a]&&ja(c[a].firstChild.nextSibling.firstChild,b)},active:function(a){if(this.options.highlightable){this._actived&&L(this._actived.firstChild.nextSibling,"ui-state-default ui-state-highlight");if(a){if(a=this.li[a]){F(a.firstChild.nextSibling,"ui-state-default ui-state-highlight");this._actived=a}}else this._actived=null}}});ca("menu",function(a){var b=this.layout;a=this.menu=new u.menu(null,a);b.addWidget(a,
{title:t("menu"),icon:"home",sticky:false,onlyIcon:false,isMinimize:true},null,"shortcut")});P("menu",{template:'<div id="webim-menu" class="webim-menu">\t\t<ul id=":ul"><%=list%></ul>\t\t\t<div id=":empty" class="webim-menu-empty"><%=empty menu%></div>\t\t\t\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><img src="<%=icon%>"/><span><%=title%></span></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&B(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;
c&&I(c,function(d,f){b.push(a._li_tpl(f))});return S(a.options.template,{list:b.join("")})},_li_tpl:function(a){return S(this.options.tpl_li,{title:t(a.title),icon:a.icon,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(E(a))I(a,function(d,f){b.add(f)});else{var c=b.$;B(c.empty);c.ul.appendChild(O(b._li_tpl(a)))}},destroy:function(){}});ca("chatlink",function(a){var b=this,c=b.im,d=b.chatlink=
(new webim.ui.chatlink(null,a)).bind("select",function(k,n){b.layout.addChat("buddy",n);b.layout.focusChat("buddy",n)}),f=function(k){return k.show!="invisible"&&k.presence=="online"},h=function(k){return k.show=="invisible"};c.buddy.bind("online",function(k,n){d.add(V(n,f))}).bind("update",function(k,n){d.add(V(n,f));d.remove(V(n,h))}).bind("offline",function(k,n){d.remove(n)});c.bind("beforeOnline",function(k,n){n.stranger_ids=d.idsArray()}).bind("online",function(){d.remove(c.data.user)}).bind("offline",
function(){d.removeAll()})});P("chatlink",{link_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)$/,/\?(\d+)$/],space_href:[/space\.php\?uid=(\d+)$/i,/space\-(\d+)\.html$/i,/space\-uid\-(\d+)\.html$/i,/\?mod=space&uid=(\d+)/,/\?(\d+)$/],space_class:/spacemenu_list|line_list|xl\sxl2\scl/i,space_id:/profile_act/i,link_class:null,off_link_class:null,link_wrap:null,space_wrap:null},{_init:function(){function a(T,ba){if(!T)return false;for(var Z=
ba.length,da=0;da<Z;da++){var Da=ba[da].exec(T);if(Da&&Da[1])return Da[1]}return false}var b=this.list={},c=this.options,d=this.anthors={},f=c.link_href,h=c.space_href,k=c.space_id,n=c.off_link_class,p=c.link_class,r=c.space_class,q=c.space_wrap||A;(c=(c.link_wrap||A).getElementsByTagName("a"))&&I(c,function(T,ba){var Z=a(ba.href,f),da=ba.innerHTML;if(Z&&ta(ba.firstChild).length==0&&da&&(!ba.className||!p||p.test(ba.className))&&(!ba.className||!n||!n.test(ba.className))){d[Z]?d[Z].push(ba):d[Z]=
[ba];b[Z]={id:Z,name:da}}});if(h=a(y.location.href,h)){b[h]=C(b[h],{id:h});q=q.getElementsByTagName("*");c=q.length;for(var s,w,G,Q=0;Q<c;Q++){s=q[Q];w=s.className;G=s.id;if(r&&r.test(w)||k&&k.test(G)){s=ta(s.firstChild);if(s.length){s=s[s.length-1];d[h]?d[h].push(s):d[h]=[s]}break}}}},_temp:function(a){var b=this;a=O(S('<a id="<%=id%>" href="#chat" title="<%=title%>" class="webim-chatlink"><%=text%></a>',a));z(a,"click",function(c){b.trigger("select",this.id);ma(c);H(c)});return a},idsArray:function(){var a=
[];I(this.list,function(b){a.push(b)});return a},add:function(a){var b=this.list,c=this.anthors,d=a.length,f,h,k,n,p;for(f=0;f<d;f++){h=a[f];if(h.id&&(k=h.uid)&&(n=b[k])){p=c[k];if(!n.elements&&p){n.elements=[];for(var r=0;r<p.length;r++)if(p[r].tagName.toLowerCase()=="li"){n.elements[r]=A.createElement("li");n.elements[r].appendChild(this._temp({id:h.id,title:"",text:t("chat with me")}))}else n.elements[r]=this._temp({id:h.id,title:t("chat with",{name:n.name}),text:""})}p&&I(p,function(q,s){s.parentNode.insertBefore(n.elements[q],
s.nextSibling)})}}},remove:function(a){var b=this.list,c=a.length,d,f,h,k;for(d=0;d<c;d++){f=a[d];if(f.id&&(h=f.uid)&&(k=b[h]))k.elements&&I(k.elements,function(n,p){la(p)})}},removeAll:function(){I(this.list,function(a,b){b.elements&&I(b.elements,function(c,d){la(d)})})}});Ga("notification",{url:"webim/notifications"},{_init:function(){},grep:function(a){return a&&a.text},handle:function(a){a=V(aa(a),this.grep);a.length&&this.trigger("data",[a])},load:function(){X({url:ga("notifications"),cache:false,
dataType:this.options.jsonp?"jsonp":"json",context:this,success:this.handle})}});ca("notification",function(a){var b=this.im,c=this.layout,d=this.notification=new u.notification(null,a),f=b.notification=new webim.notification(null,{jsonp:b.options.jsonp});c.addWidget(d,{title:t("notification"),icon:"notification",sticky:false,onlyIcon:true,isMinimize:true});f.bind("data",function(h,k){d.window.notifyUser("information","+"+k.length);d.add(k)});setTimeout(function(){f.load()},2E3)});P("notification",
{template:'<div id="webim-notification" class="webim-notification">\t<ul id=":ul"><%=list%></ul>\t<div id=":empty" class="webim-notification-empty"><%=empty notification%></div>\t</div>',tpl_li:'<li><a href="<%=link%>" target="<%=target%>"><%=text%></a></li>'},{_init:function(){var a=this.options;a.data&&a.data.length&&B(this.$.empty)},template:function(){var a=this,b=[],c=a.options.data;c&&I(c,function(d,f){b.push(a._li_tpl(f))});return S(a.options.template,{list:b.join("")})},_li_tpl:function(a){return S(this.options.tpl_li,
{text:a.text,link:a.link,target:a.isExtlink?"_blank":""})},_fitUI:function(){var a=this.element;if(a.clientHeight>300)a.style.height="300px"},add:function(a){var b=this;if(E(a))I(a,function(d,f){b.add(f)});else{var c=b.$;B(c.empty);c.ul.appendChild(O(b._li_tpl(a)))}},destroy:function(){}});ca("layout.popup",function(a){u.buddy&&(u.buddy.defaults.highlightable=true);u.room&&(u.room.defaults.highlightable=true);u.chat&&(u.chat.defaults.simple=true);a=a||{};var b=this.im,c=b.buddy,d=b.history,f=b.status,
h=b.room,k=new u["layout.popup"](null,C({},a,{ui:this}));(function(){b.bind("online",function(n,p){k.options.user=p.user;k.updateAllChat()}).bind("offline",function(){k.updateAllChat()})})();(function(){b.bind("beforeOnline",function(r,q){C(q,{buddy_ids:f.get("_cacheBuddy"),room_ids:"",show:"available"})});var n=function(r){return r&&r.id},p=function(){var r=Ba(c.all(true),n);f.set("_cacheBuddy",r.join(","));k.updateAllChat()};c.bind("online",p).bind("offline",p)})();(function(){h.bind("addMember",
function(n,p,r){(n=k.chat("room",p))&&n.addMember(r.id,r.nick,r.id==b.data.user.id)}).bind("removeMember",function(n,p,r){(n=k.chat("room",p))&&n.removeMember(r.id,r.nick)})})();(function(){d.bind("unicast",function(n,p,r){(n=k.chat("unicast",p))&&n.history.add(r)});d.bind("multicast",function(n,p,r){(n=k.chat("multicast",p))&&n.history.add(r)});d.bind("clear",function(n,p,r){(n=k.chat(p,r))&&n.history.clear()})})();b.bind("message",function(n,p){for(var r=false,q=p.length,s,w=b.data.user.id,G,Q,
T=0;T<q;T++){s=p[T];G=s.id;type=s.type==="unicast"?"buddy":"room";(Q=k.chat(type,G))&&Q.status("");if(!Q){(Q=k.widget(type))&&Q.showCount(G,"+1");k.notifyUser(type,"+1")}if(s.from!=w)r=true}if(r){na.play("msg");wa(t("new message"),5)}});b.bind("status",function(n,p){I(p,function(r,q){var s=b.data.user.id,w=q.from;if(!(s!=q.to&&s!=q.from))(s=k.chat("buddy",w))&&s.status(q.show)})});return k});P("layout.popup",{template:'<div id="webim" class="webim webim-state-ready">\t<div class="webim-preload ui-helper-hidden-accessible">\t<div id="webim-flashlib-c">\t</div>\t</div>\t<div id=":layout" class="webim-layout webim-popup ui-helper-clearfix"><div id=":left" class="webim-popup-left"></div><div id=":right" class="webim-popup-right"></div>\t<div id=":widgets" class="webim-widgets ui-widget-content ui-helper-clearfix"><div class="webim-layout-bg ui-state-default ui-toolbar"></div></div>\t</div>\t</div>',
template_tab:'<div class="webim-window-tab-wrap">\t<div id=":tab" class="webim-window-tab ui-state-default">\t<div class="webim-window-tab-inner">\t<div id=":tabTip" class="webim-window-tab-tip">\t<strong id=":tabTipC"><%=title%></strong>\t</div>\t<div id=":tabCount" class="webim-window-tab-count">\t0\t</div>\t<em id=":tabIcon" class="webim-icon webim-icon-<%=icon%>"></em>\t</div>\t</div>\t</div>'},{_init:function(){C(this,{widgets:{},widgetIds:[],tabs:{},activeTabId:null});this.win=new u.window(null,
{closeable:false,minimizable:false,isMinimize:false})},buildUI:function(){var a=this.win;a.$.window.appendChild(this.$.widgets);this.$.left.appendChild(a.element)},widget:function(a){return this.widgets[a]},addWidget:function(a,b){var c=this.win,d=a.name;a.window=c;this.widgetIds.push(d);this.widgets[a.name]=a;B(a.element);c.$.content.appendChild(a.element);this._createTab(d,b);this.widgetIds.length==1&&this._activeTab(d)},_createTab:function(a,b){var c=this,d=O(S(c.options.template_tab,b));d.$=J(d);
var f=d.$.tab;z(f,"click",function(h){c._activeTab(a);ma(h);H(h)});z(f,"mouseover",function(){F(this,"ui-state-hover");L(this,"ui-state-default")});z(f,"mouseout",function(){L(this,"ui-state-hover");this.className.indexOf("ui-state-")==-1&&F(this,"ui-state-default")});W(f);c.$.widgets.appendChild(d);c.tabs[a]=d},_activeTab:function(a){for(var b=this.tabs,c=this.widgetIds.length-1;c>=0;c--){var d=this.widgetIds[c],f=this.widgets[d],h=b[d].$.tab;if(d==a){M(f.element);F(h,"ui-state-active");L(h,"ui-state-default");
ja(b[d].$.tabCount,0)}else if(d==this.activeTabId){B(f.element);F(h,"ui-state-default");L(h,"ui-state-active")}}this.activeTabId=a},notifyUser:function(a,b){if(a!=this.activeTabId){var c=this.tabs[a];c&&ja(c.$.tabCount,b)}},focusChat:function(){},chat:function(a,b){if(!a||this.__chat&&this.__chat.__id==U(a,b))return this.__chat;return null},updateChat:function(){var a=this.chat();a&&a.update()},updateAllChat:function(){this.updateChat()},addChat:function(a,b,c,d,f){a=ha(a);var h=this;h.__chat&&la(h.__chat.window.element);
var k=h.widget(a=="room"?"buddy":"room");k&&k.active(null);(k=h.widget(a))&&k.active(b);var n=(new u.window(null,C({minimizable:false},d))).bind("close",function(){h.__chat=null;k&&k.active()});c=h.__chat=h.options.ui.addApp("chat",C({},h.options.ui.options[a+"ChatOptions"],{id:b,type:a,nick:f,winOptions:d},c));c.__id=U(a,b);c.setWindow(n);h.$.right.appendChild(n.element)}})})(window,document);
